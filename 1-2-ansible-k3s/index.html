
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../1-1-ansible-install/">
      
      
        <link rel="next" href="../1-3-ansible-manifests/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.0.6">
    
    
      
        <title>1.2 Présentation de K3s et installation - PaaS Tutorial</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.558e4712.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.2505c338.min.css">
      
      

    
    
    
      
    
    
      <link rel="stylesheet" href="../css/print-site-enum-headings2.css">
    
      <link rel="stylesheet" href="../css/print-site-enum-headings3.css">
    
      <link rel="stylesheet" href="../css/print-site-enum-headings4.css">
    
      <link rel="stylesheet" href="../css/print-site-enum-headings5.css">
    
      <link rel="stylesheet" href="../css/print-site-enum-headings6.css">
    
      <link rel="stylesheet" href="../css/print-site.css">
    
      <link rel="stylesheet" href="../css/print-site-material.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#12-presentation-de-k3s-et-installation" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="PaaS Tutorial" class="md-header__button md-logo" aria-label="PaaS Tutorial" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            PaaS Tutorial
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              1.2 Présentation de K3s et installation
            
          </span>
        </div>
      </div>
    </div>
    
    
    
    
      <div class="md-header__source">
        <a href="https://github.com/esgi-lyon/paas-tutorial" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="PaaS Tutorial" class="md-nav__button md-logo" aria-label="PaaS Tutorial" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    PaaS Tutorial
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/esgi-lyon/paas-tutorial" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Tutoriel PaaS
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../0-install/" class="md-nav__link">
        Introduction et installation
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../1-1-ansible-install/" class="md-nav__link">
        1.1  Provisionning du paas avec ansible
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          1.2 Présentation de K3s et installation
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        1.2 Présentation de K3s et installation
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#notions-theoriques-sur-kubernetes" class="md-nav__link">
    Notions théoriques sur kubernetes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#noeud" class="md-nav__link">
    Noeud
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#namespace" class="md-nav__link">
    Namespace
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#les-pods" class="md-nav__link">
    Les pods
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploiement" class="md-nav__link">
    Déploiement
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#services" class="md-nav__link">
    Services
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ingress" class="md-nav__link">
    Ingress
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#specificite-de-k3s" class="md-nav__link">
    Spécificité de k3s
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#larchitecture-autour-de-kubeapps" class="md-nav__link">
    L'architecture autour de Kubeapps
  </a>
  
    <nav class="md-nav" aria-label="L'architecture autour de Kubeapps">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#e-premiers-tests-sur-le-role" class="md-nav__link">
    E. Premiers tests sur le rôle
  </a>
  
    <nav class="md-nav" aria-label="E. Premiers tests sur le rôle">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#le-playbook-converge" class="md-nav__link">
    Le playbook converge
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#le-playbook-verify" class="md-nav__link">
    Le playbook verify
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optionnel-utilisation-avec-les-extensions-vscode" class="md-nav__link">
    Optionnel - Utilisation avec les extensions Vscode
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../1-3-ansible-manifests/" class="md-nav__link">
        1.3 Algo d'installation des manifests
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../1-4-ansible-pebble/" class="md-nav__link">
        1.4 Autorité de certification
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../1-5-ansible-dns/" class="md-nav__link">
        1.5 Mise en place des communications réseau du cluster
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../1-6-ansible-cert-manager/" class="md-nav__link">
        1.6 Utiliser notre autorité avec cert-manager
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../1-7-ansible-trust-ca/" class="md-nav__link">
        1.7 Faire confiance à notre autorité de certification
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../1-8-ansible-dex/" class="md-nav__link">
        1.8 Authentification et des habilitations
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../1-9-ansible-kubeapps/" class="md-nav__link">
        1.9 Installation de kubeapps
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../2-packer-playbook/" class="md-nav__link">
        2. Utilisation de notre rôle dans packer
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../3-1-terraform-azure-init/" class="md-nav__link">
        3.1 Initialisation du déploiement final sur Azure avec Terraform
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../3-2-terraform-security/" class="md-nav__link">
        3.2 Sécurisation de l'organisation
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../3-3-terraform-azure-network-vm/" class="md-nav__link">
        3.3 Machine virtuelle et réseau
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../4-1-helm-chart/" class="md-nav__link">
        4.1 Création du Helm chart
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../4-2-helm-chart-deploy/" class="md-nav__link">
        4.2 Déploiement du chart
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../5-allez-plus-loin/" class="md-nav__link">
        5. Allez plus loin
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../print_page/" class="md-nav__link">
        Print Site
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#notions-theoriques-sur-kubernetes" class="md-nav__link">
    Notions théoriques sur kubernetes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#noeud" class="md-nav__link">
    Noeud
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#namespace" class="md-nav__link">
    Namespace
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#les-pods" class="md-nav__link">
    Les pods
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploiement" class="md-nav__link">
    Déploiement
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#services" class="md-nav__link">
    Services
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ingress" class="md-nav__link">
    Ingress
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#specificite-de-k3s" class="md-nav__link">
    Spécificité de k3s
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#larchitecture-autour-de-kubeapps" class="md-nav__link">
    L'architecture autour de Kubeapps
  </a>
  
    <nav class="md-nav" aria-label="L'architecture autour de Kubeapps">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#e-premiers-tests-sur-le-role" class="md-nav__link">
    E. Premiers tests sur le rôle
  </a>
  
    <nav class="md-nav" aria-label="E. Premiers tests sur le rôle">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#le-playbook-converge" class="md-nav__link">
    Le playbook converge
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#le-playbook-verify" class="md-nav__link">
    Le playbook verify
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optionnel-utilisation-avec-les-extensions-vscode" class="md-nav__link">
    Optionnel - Utilisation avec les extensions Vscode
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
    <a href="https://github.com/esgi-lyon/paas-tutorial/edit/main/docs/1-2-ansible-k3s.md" title="Edit this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4v-2m10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1 2.1 2.1Z"/></svg>
    </a>
  
  



<h1 id="12-presentation-de-k3s-et-installation">1.2 Présentation de K3s et installation<a class="headerlink" href="#12-presentation-de-k3s-et-installation" title="Permanent link">&para;</a></h1>
<hr />
<p>K3s est une distribution légère de Kubernetes conçue pour être facile à installer et à utiliser dans des environnements à ressources limitées tels que les appareils edge et IoT. Il convient également bien pour fonctionner sur des appareils basés sur Arm, ce qui en fait un choix populaire pour les grappes Raspberry Pi. </p>
<p>K3s peut exécuter toutes les charges de travail Kubernetes, mais il a une empreinte plus petite et nécessite moins de ressources qu'une installation Kubernetes traditionnelle.</p>
<h3 id="notions-theoriques-sur-kubernetes">Notions théoriques sur kubernetes<a class="headerlink" href="#notions-theoriques-sur-kubernetes" title="Permanent link">&para;</a></h3>
<h3 id="noeud">Noeud<a class="headerlink" href="#noeud" title="Permanent link">&para;</a></h3>
<p>Un nœud est une machine de travail dans Kubernetes, un groupe de nœud va composer ce qu'on appelle un cluster (grappe) de serveurs. Chaque nœud contient les services nécessaires à l'exécution de pods et est géré par les composants du master.</p>
<blockquote>
<p><strong>Note</strong> dans notre cas nous ferons appel à un seul noeud master</p>
</blockquote>
<h3 id="namespace">Namespace<a class="headerlink" href="#namespace" title="Permanent link">&para;</a></h3>
<p>Clusters virtuels présents sur le même cluster physique. Ces clusters virtuels sont appelés namespaces. Ils utilisent les fonctionnalités de groupage de linux Cgroup.</p>
<h3 id="les-pods">Les pods<a class="headerlink" href="#les-pods" title="Permanent link">&para;</a></h3>
<p><a href="https://kubernetes.io/fr/docs/concepts">source documentation officielle</a></p>
<p>Un pod est un groupe d'un ou plusieurs conteneurs (comme des conteneurs Docker), ayant du stockage/réseau partagé et une spécification sur la manière d'exécuter ces conteneurs. Les éléments d'un pod sont toujours co-localisés et co-ordonnancés, et s'exécutent dans un contexte partagé. Un pod modélise un "hôte logique" spécifique à une application - il contient un ou plusieurs conteneurs applicatifs qui sont étroitement liés.</p>
<p>Un pod peut être :</p>
<ul>
<li>Temporaire (Completed) pour effectuer une tâches particulière (cron, jouer des script, déploiement d'autres pods...)</li>
<li>Définitif soit une application en exécution</li>
</ul>
<h3 id="deploiement">Déploiement<a class="headerlink" href="#deploiement" title="Permanent link">&para;</a></h3>
<p>Comme un le fait en développement un fichier docker-compose, cette ressource décrit la mise en place des containers avant de les placer dans un pod (plusieurs containers peuvent se placer dans un pod)</p>
<h3 id="services">Services<a class="headerlink" href="#services" title="Permanent link">&para;</a></h3>
<p>Une manière abstraite d'exposer une application s'exécutant sur un ensemble de Pods en tant que service réseau.</p>
<h2 id="ingress">Ingress<a class="headerlink" href="#ingress" title="Permanent link">&para;</a></h2>
<p>Il s'agit du composant de kubernetes permettant de gérer au travers d'une technologie de reverse proxy et de répartition de charge le trafic réseau entrant (http(s)).</p>
<blockquote>
<p><strong>Note</strong> Un <strong>reverse proxy</strong> est à l'inverse d'un proxy chargé d'effectuer une action à partir d'une requête réseau externe. On l'utilise majoritairement avec un serveur DNS qui fait pointer des noms de domaines et sous domaines vers l'adresse Ip du serveur sur lequel un reverse proxy est installé.
Par exemple, il va servir à rediriger le traffic de la requête <code>kubeapps.k3s.local</code> vers une adresse et port réseau attribué par kubernetes à un pod.</p>
</blockquote>
<p>Voici pour résumer l'achitecture réseau d'un cluster kubernetes :</p>
<p><img alt="architecture réseau kubernetes" src="../images/k8s-archi.jpg" /></p>
<h2 id="specificite-de-k3s">Spécificité de k3s<a class="headerlink" href="#specificite-de-k3s" title="Permanent link">&para;</a></h2>
<p>K3s est une sorte d'implémentation alléger de kubernetes pour le rendre portable sur plus de plateformes comme des nano ordinateur et des infrastructures en périphérie de réseau (Edge computing).</p>
<p>Nous avons donc à la place de <code>etcd</code> comme outil de persistance du stockage <code>sqlite</code>, un ingress (ou reverse proxy) par défaut à <code>traefik</code> et on trouve nombreux composants coeur comme le kuber-controller-manager ou le scheduder ramené au plus proche du système (services réseaux au lieu de pods).</p>
<h2 id="larchitecture-autour-de-kubeapps">L'architecture autour de Kubeapps<a class="headerlink" href="#larchitecture-autour-de-kubeapps" title="Permanent link">&para;</a></h2>
<p>Pour rappel kubeapps nous sert à déployer des applications conteneurisées "packagées" au format helm chart dans un cluster kubernetes.
Il aura besoin de plusieurs autres outils pour fonctionner de manière sécurisée avec kubernetes.</p>
<ul>
<li>Une autorité de certification locale et Acme server pour nos tests <a href="https://github.com/letsencrypt/pebble">pebble</a></li>
<li>Un gestionnaire de certificats dédié à kubernetes <a href="https://cert-manager.io/">cert-manager</a></li>
<li>Un <strong>serveur openid</strong> exploitant une application oauth2 github : <a href="https://dexidp.io/">dex idp</a></li>
</ul>
<p>Voilà donc tout ce qu'on aura à mettre en place dans notre rôle ansible.</p>
<h3 id="e-premiers-tests-sur-le-role">E. Premiers tests sur le rôle<a class="headerlink" href="#e-premiers-tests-sur-le-role" title="Permanent link">&para;</a></h3>
<p>Nous allons d'abord définir l'utilisation d'une distribution ubuntu pour installer nos outils. Pour les tests en local, nous faisons du <strong>docker in docker</strong> ce qui impose des configurations particulières.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/roles/kubeapps/molecule/default/molecule.yml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-0-10">10</a></span>
<span class="normal"><a href="#__codelineno-0-11">11</a></span>
<span class="normal"><a href="#__codelineno-0-12">12</a></span>
<span class="normal"><a href="#__codelineno-0-13">13</a></span>
<span class="normal"><a href="#__codelineno-0-14">14</a></span>
<span class="normal"><a href="#__codelineno-0-15">15</a></span>
<span class="normal"><a href="#__codelineno-0-16">16</a></span>
<span class="normal"><a href="#__codelineno-0-17">17</a></span>
<span class="normal"><a href="#__codelineno-0-18">18</a></span>
<span class="normal"><a href="#__codelineno-0-19">19</a></span>
<span class="normal"><a href="#__codelineno-0-20">20</a></span>
<span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nn">---</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="nt">dependency</span><span class="p">:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">galaxy</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="nt">driver</span><span class="p">:</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docker</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="nt">platforms</span><span class="p">:</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">node-0</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">geerlingguy/docker-${MOLECULE_DISTRO:-ubuntu2004}-ansible:latest</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${MOLECULE_DOCKER_COMMAND:-&quot;&quot;}</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="w">    </span><span class="nt">privileged</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="w">    </span><span class="nt">pre_build_image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/sys/fs/cgroup:/sys/fs/cgroup:rw</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/lib/rancher/k3s</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="w">    </span><span class="nt">network_mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">host</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="w">    </span><span class="nt">tmpfs</span><span class="p">:</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/run</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/run</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="nt">provisioner</span><span class="p">:</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ansible</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="nt">verifier</span><span class="p">:</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ansible</span>
</code></pre></div></td></tr></table></div>
<blockquote>
<p><strong>Warning</strong> : le <code>name</code> de la platform va nous servir d'adresse réseau par laquelle ansible sur l'hôte va pouvoir accéder en ssh. Il est indispensable de le renseigner, car le role k3s en a besoin pour bien créer les nœud du cluster kubernetes. (même si on en utilise un seul)</p>
</blockquote>
<p>L'image du container <code>geerlingguy/docker-${MOLECULE_DISTRO:-ubuntu2004}</code> va nous permettre d'utiliser un linux préconfiguré qui s'initialise avec le démon <code>systemd</code>. Celui ci est une fonctionnalité assez neuve du coeur et recommandée pour la gestion des services en arrière plan (daemons) soit ici k3s</p>
<p>On note que l'on publie le port <code>80</code> et <code>443</code> à des fins de debug pour exposer Ingress.</p>
<blockquote>
<p><code>32444</code> le port pebble servira plus tard pour accéder à notre serveur ACME</p>
<p><strong><em>*Warning</em>* vérifie bien qu'aucun autre processus su votre machine n'utilise déjà le port 80 et 443</strong></p>
</blockquote>
<p>Les <strong>volumes</strong> que l'on utilise servent à rendre disponible des fonctionnalités du coeur linux désactivées par défaut sur des containers docker comme <code>systemd</code> et les <a href="https://fr.wikipedia.org/wiki/Espace_de_noms">espaces de nom</a> / <a href="https://kubernetes.io/docs/concepts/architecture/cgroups/"><code>cgroup</code> version 2</a>. 
Même chose pour le répertoire temporaire <code>tmpfs</code> qui assurent le bon fonctionnement de ces outils. 
Enfin <code>priviledgied: true</code> nous donne les droits administrateur complets sur le système du container.</p>
<p>Le playbook <code>verifier</code> va ensuite nous permettre de tester la bonne exécution du rôle et de ses dépendances.</p>
<h4 id="le-playbook-converge">Le playbook converge<a class="headerlink" href="#le-playbook-converge" title="Permanent link">&para;</a></h4>
<p>Ce playbook représente la façon dont on utilisera en condition réelle notre appel du rôle en ajoutant cependant des prérequis spécifique à notre environnement de test.</p>
<blockquote>
<p><strong>Note</strong> la partie <code>dig_host_docker_internal</code> servira à récupérer l'adresse ip de l'hôte docker pour pouvoir y accéder depuis les pods. C'est une astuce pour contourner le problème de résolution de domaines des pods avec un réseau sur localhost. C'est grâce à <code>network_mode: host</code> que l'on peut faire cela.</p>
</blockquote>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/roles/kubeapps/molecule/default/converge.yml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-1-10">10</a></span>
<span class="normal"><a href="#__codelineno-1-11">11</a></span>
<span class="normal"><a href="#__codelineno-1-12">12</a></span>
<span class="normal"><a href="#__codelineno-1-13">13</a></span>
<span class="normal"><a href="#__codelineno-1-14">14</a></span>
<span class="normal"><a href="#__codelineno-1-15">15</a></span>
<span class="normal"><a href="#__codelineno-1-16">16</a></span>
<span class="normal"><a href="#__codelineno-1-17">17</a></span>
<span class="normal"><a href="#__codelineno-1-18">18</a></span>
<span class="normal"><a href="#__codelineno-1-19">19</a></span>
<span class="normal"><a href="#__codelineno-1-20">20</a></span>
<span class="normal"><a href="#__codelineno-1-21">21</a></span>
<span class="normal"><a href="#__codelineno-1-22">22</a></span>
<span class="normal"><a href="#__codelineno-1-23">23</a></span>
<span class="normal"><a href="#__codelineno-1-24">24</a></span>
<span class="normal"><a href="#__codelineno-1-25">25</a></span>
<span class="normal"><a href="#__codelineno-1-26">26</a></span>
<span class="normal"><a href="#__codelineno-1-27">27</a></span>
<span class="normal"><a href="#__codelineno-1-28">28</a></span>
<span class="normal"><a href="#__codelineno-1-29">29</a></span>
<span class="normal"><a href="#__codelineno-1-30">30</a></span>
<span class="normal"><a href="#__codelineno-1-31">31</a></span>
<span class="normal"><a href="#__codelineno-1-32">32</a></span>
<span class="normal"><a href="#__codelineno-1-33">33</a></span>
<span class="normal"><a href="#__codelineno-1-34">34</a></span>
<span class="normal"><a href="#__codelineno-1-35">35</a></span>
<span class="normal"><a href="#__codelineno-1-36">36</a></span>
<span class="normal"><a href="#__codelineno-1-37">37</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="nn">---</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Converge</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">all</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">  </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">  </span><span class="nt">vars</span><span class="p">:</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="w">    </span><span class="nt">molecule_is_test</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="w">  </span><span class="nt">roles</span><span class="p">:</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">role</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">lookup(&#39;env&#39;,</span><span class="nv"> </span><span class="s">&#39;MOLECULE_PROJECT_DIRECTORY&#39;)</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">basename</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="w">  </span><span class="nt">pre_tasks</span><span class="p">:</span>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ensure test dependencies are installed.</span>
<a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="w">      </span><span class="nt">package</span><span class="p">:</span><span class="w"> </span>
<a id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="w">        </span><span class="nt">name</span><span class="p">:</span>
<a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">iptables</span>
<a id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">curl</span>
<a id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dnsutils</span>
<a id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span>
<a id="__codelineno-1-19" name="__codelineno-1-19"></a><span class="w">        </span><span class="nt">update_cache</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="w">      </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ansible_os_family == &#39;Debian&#39;</span>
<a id="__codelineno-1-21" name="__codelineno-1-21"></a>
<a id="__codelineno-1-22" name="__codelineno-1-22"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install pre-requisites for k8s module</span>
<a id="__codelineno-1-23" name="__codelineno-1-23"></a><span class="w">      </span><span class="nt">ansible.builtin.pip</span><span class="p">:</span>
<a id="__codelineno-1-24" name="__codelineno-1-24"></a><span class="w">        </span><span class="nt">name</span><span class="p">:</span>
<a id="__codelineno-1-25" name="__codelineno-1-25"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">openshift</span>
<a id="__codelineno-1-26" name="__codelineno-1-26"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pyyaml</span>
<a id="__codelineno-1-27" name="__codelineno-1-27"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes</span>
<a id="__codelineno-1-28" name="__codelineno-1-28"></a>
<a id="__codelineno-1-29" name="__codelineno-1-29"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dig host.docker.internal address</span>
<a id="__codelineno-1-30" name="__codelineno-1-30"></a><span class="w">      </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dig +short host.docker.internal</span>
<a id="__codelineno-1-31" name="__codelineno-1-31"></a><span class="w">      </span><span class="nt">register</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dig_host_docker_internal</span>
<a id="__codelineno-1-32" name="__codelineno-1-32"></a><span class="w">      </span><span class="nt">changed_when</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<a id="__codelineno-1-33" name="__codelineno-1-33"></a><span class="w">      </span><span class="nt">tags</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">kubeapps</span><span class="p p-Indicator">]</span>
<a id="__codelineno-1-34" name="__codelineno-1-34"></a>
<a id="__codelineno-1-35" name="__codelineno-1-35"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">ansible.builtin.set_fact</span><span class="p">:</span>
<a id="__codelineno-1-36" name="__codelineno-1-36"></a><span class="w">        </span><span class="nt">kubeapps_internal_acme_network_ip</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">dig_host_docker_internal.stdout</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-1-37" name="__codelineno-1-37"></a><span class="w">      </span><span class="nt">tags</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">kubeapps</span><span class="p p-Indicator">]</span>
</code></pre></div></td></tr></table></div>
<blockquote>
<p>Notes :
- <code>hosts: all</code> permet de jouer le playbook sur tous les hôtes
- <code>role: {{etc...}}</code> résoud le chemin de fichier vers le répertoire du rôle
- Les pré-tâches servent à installer des packages linux et python manquant à notre container utiles pour l'environnement local et les tests.</p>
</blockquote>
<h4 id="le-playbook-verify">Le playbook verify<a class="headerlink" href="#le-playbook-verify" title="Permanent link">&para;</a></h4>
<p>Nous allons ensuite vérifier que k3s est bien prêt avec deux vérifications :</p>
<ul>
<li>Vérification de la bonne initialisation du nœud <strong>master</strong> 
simplement en vérifiant que le retour de la commande contient bien "Ready    master".</li>
</ul>
<p>On utilise pour cette fois la commande <code>kubectl</code> directement. Pour en savoir plus pour cette commande centrale dans l'utilisation d'un cluster kubernetes <a href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands">c'est ici</a></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/roles/kubeapps/molecule/default/verify.yml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-2-10">10</a></span>
<span class="normal"><a href="#__codelineno-2-11">11</a></span>
<span class="normal"><a href="#__codelineno-2-12">12</a></span>
<span class="normal"><a href="#__codelineno-2-13">13</a></span>
<span class="normal"><a href="#__codelineno-2-14">14</a></span>
<span class="normal"><a href="#__codelineno-2-15">15</a></span>
<span class="normal"><a href="#__codelineno-2-16">16</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="nn">---</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Verify</span>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">all</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="w">  </span><span class="nt">gather_facts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Get single node</span>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="w">      </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubectl get nodes</span>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="w">      </span><span class="nt">changed_when</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<a id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="w">      </span><span class="nt">register</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes_nodes</span>
<a id="__codelineno-2-10" name="__codelineno-2-10"></a>
<a id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Print list of running nodes.</span>
<a id="__codelineno-2-12" name="__codelineno-2-12"></a><span class="w">      </span><span class="nt">debug</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">var=kubernetes_nodes.stdout</span>
<a id="__codelineno-2-13" name="__codelineno-2-13"></a>
<a id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Assert master node ready</span>
<a id="__codelineno-2-15" name="__codelineno-2-15"></a><span class="w">      </span><span class="nt">ansible.builtin.assert</span><span class="p">:</span>
<a id="__codelineno-2-16" name="__codelineno-2-16"></a><span class="w">        </span><span class="nt">that</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;&quot;node-0</span><span class="nv">   </span><span class="s">Ready</span><span class="nv">    </span><span class="s">control-plane,master&quot;</span><span class="nv"> </span><span class="s">in</span><span class="nv"> </span><span class="s">kubernetes_nodes.stdout&#39;</span>
</code></pre></div></td></tr></table></div>
<p>Lancer votre premier test avec <code>molecule test</code> et voilà vous avez un playbook offrant un cluster kubernetes prêt à l'emploi tout en suivant rigoureusement le concept du test driven development pour plus de fiabilité.</p>
<blockquote>
<p><strong>Note</strong> : Vous pouvez aussi lancer <code>molecule test --destroy never</code> pour ensuite garder le conteneur et debugger l'état du système après le "provision" ansible avec <code>molecule login</code> (qui équivaut à <code>docker exec -it node-0 bash</code>)</p>
<p><strong>Note</strong> : En cas d'erreur <code>export ANSIBLE_STDOUT_CALLBACK=yaml</code> avant de lancer <code>molecule test</code> pour avoir un meilleur rendu de la possible erreur.</p>
</blockquote>
<p>Ensuite dans la suite du fichier on procède à une vérification des pods de la suite k3s. </p>
<blockquote>
<p>Vous pourrez relancer seulement la suite de vérification avec <code>molecule verify</code> si votre container n'a pas été détruit (<code>--destroy false</code>)</p>
</blockquote>
<p>Nous savons ici que k3s est lancé. En sachant que ce rôle est externe nous n'avons pas besoin de faire plus de tests sur ces composants centraux disposés dans le namespace <code>kube-system</code>.</p>
<p>On valide bien que le service est de type cluster ip. Cela signifie qu'il est exposé dans le cluster avec sa propre adresse. Si le type aurait été vide cela aurait voulu dire soit que quelque chose n'est pas correctement configuré soit que kubernetes n'est pas disposé à attribué une configuration réseau à ce service.</p>
<blockquote>
<p><strong>INFO</strong> Kubernetes utilise l'outil natif de linux <code>iptables</code> pour faire fonctionner cette ressource.</p>
</blockquote>
<h4 id="optionnel-utilisation-avec-les-extensions-vscode"><a href="../5-allez-plus-loin/#kubernetes-sur-vscode">Optionnel - Utilisation avec les extensions Vscode</a><a class="headerlink" href="#optionnel-utilisation-avec-les-extensions-vscode" title="Permanent link">&para;</a></h4>
<hr />





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": ["content.code.copy", "content.action.edit"], "search": "../assets/javascripts/workers/search.e5c33ebb.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.51d95adb.min.js"></script>
      
        <script src="../js/print-site.js"></script>
      
    
  </body>
</html>