
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.0.6">
    
    
      
        <title>Print Site - PaaS Tutorial</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.558e4712.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.2505c338.min.css">
      
      

    
    
    
      
    
    
      <link rel="stylesheet" href="../css/print-site-enum-headings2.css">
    
      <link rel="stylesheet" href="../css/print-site-enum-headings3.css">
    
      <link rel="stylesheet" href="../css/print-site-enum-headings4.css">
    
      <link rel="stylesheet" href="../css/print-site-enum-headings5.css">
    
      <link rel="stylesheet" href="../css/print-site-enum-headings6.css">
    
      <link rel="stylesheet" href="../css/print-site.css">
    
      <link rel="stylesheet" href="../css/print-site-material.css">
    
    <script>__md_scope=new URL("/",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  
        <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', function () {
            remove_material_navigation();remove_mkdocs_theme_navigation();generate_toc();
        })
        </script>
        </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="PaaS Tutorial" class="md-header__button md-logo" aria-label="PaaS Tutorial" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            PaaS Tutorial
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Print Site
            
          </span>
        </div>
      </div>
    </div>
    
    
    
    
      <div class="md-header__source">
        <a href="https://github.com/esgi-lyon/paas-tutorial" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="PaaS Tutorial" class="md-nav__button md-logo" aria-label="PaaS Tutorial" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    PaaS Tutorial
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/esgi-lyon/paas-tutorial" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Tutoriel PaaS
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../0-install/" class="md-nav__link">
        Introduction et installation
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../1-1-ansible-install/" class="md-nav__link">
        1.1  Provisionning du paas avec ansible
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../1-2-ansible-k3s/" class="md-nav__link">
        1.2 Présentation de K3s et installation
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../1-3-ansible-manifests/" class="md-nav__link">
        1.3 Algo d'installation des manifests
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../1-4-ansible-pebble/" class="md-nav__link">
        1.4 Autorité de certification
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../1-5-ansible-dns/" class="md-nav__link">
        1.5 Mise en place des communications réseau du cluster
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../1-6-ansible-cert-manager/" class="md-nav__link">
        1.6 Utiliser notre autorité avec cert-manager
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../1-7-ansible-trust-ca/" class="md-nav__link">
        1.7 Faire confiance à notre autorité de certification
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../1-8-ansible-dex/" class="md-nav__link">
        1.8 Authentification et des habilitations
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../1-9-ansible-kubeapps/" class="md-nav__link">
        1.9 Installation de kubeapps
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../2-packer-playbook/" class="md-nav__link">
        2. Utilisation de notre rôle dans packer
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../3-1-terraform-azure-init/" class="md-nav__link">
        3.1 Initialisation du déploiement final sur Azure avec Terraform
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../3-2-terraform-security/" class="md-nav__link">
        3.2 Sécurisation de l'organisation
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../3-3-terraform-azure-network-vm/" class="md-nav__link">
        3.3 Machine virtuelle et réseau
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../4-1-helm-chart/" class="md-nav__link">
        4.1 Création du Helm chart
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../4-2-helm-chart-deploy/" class="md-nav__link">
        4.2 Déploiement du chart
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../5-allez-plus-loin/" class="md-nav__link">
        5. Allez plus loin
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Print Site
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Print Site
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#" class="md-nav__link">
    Tutoriel PaaS
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0-install" class="md-nav__link">
    Introduction et installation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-1-ansible-install" class="md-nav__link">
    1.1  Provisionning du paas avec ansible
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-2-ansible-k3s" class="md-nav__link">
    1.2 Présentation de K3s et installation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-3-ansible-manifests" class="md-nav__link">
    1.3 Algo d'installation des manifests
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-4-ansible-pebble" class="md-nav__link">
    1.4 Autorité de certification
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-5-ansible-dns" class="md-nav__link">
    1.5 Mise en place des communications réseau du cluster
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-6-ansible-cert-manager" class="md-nav__link">
    1.6 Utiliser notre autorité avec cert-manager
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-7-ansible-trust-ca" class="md-nav__link">
    1.7 Faire confiance à notre autorité de certification
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-8-ansible-dex" class="md-nav__link">
    1.8 Authentification et des habilitations
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-9-ansible-kubeapps" class="md-nav__link">
    1.9 Installation de kubeapps
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-packer-playbook" class="md-nav__link">
    2. Utilisation de notre rôle dans packer
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-1-terraform-azure-init" class="md-nav__link">
    3.1 Initialisation du déploiement final sur Azure avec Terraform
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-2-terraform-security" class="md-nav__link">
    3.2 Sécurisation de l'organisation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-3-terraform-azure-network-vm" class="md-nav__link">
    3.3 Machine virtuelle et réseau
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-1-helm-chart" class="md-nav__link">
    4.1 Création du Helm chart
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-2-helm-chart-deploy" class="md-nav__link">
    4.2 Déploiement du chart
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-allez-plus-loin" class="md-nav__link">
    5. Allez plus loin
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#" class="md-nav__link">
    Tutoriel PaaS
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0-install" class="md-nav__link">
    Introduction et installation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-1-ansible-install" class="md-nav__link">
    1.1  Provisionning du paas avec ansible
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-2-ansible-k3s" class="md-nav__link">
    1.2 Présentation de K3s et installation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-3-ansible-manifests" class="md-nav__link">
    1.3 Algo d'installation des manifests
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-4-ansible-pebble" class="md-nav__link">
    1.4 Autorité de certification
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-5-ansible-dns" class="md-nav__link">
    1.5 Mise en place des communications réseau du cluster
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-6-ansible-cert-manager" class="md-nav__link">
    1.6 Utiliser notre autorité avec cert-manager
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-7-ansible-trust-ca" class="md-nav__link">
    1.7 Faire confiance à notre autorité de certification
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-8-ansible-dex" class="md-nav__link">
    1.8 Authentification et des habilitations
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-9-ansible-kubeapps" class="md-nav__link">
    1.9 Installation de kubeapps
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-packer-playbook" class="md-nav__link">
    2. Utilisation de notre rôle dans packer
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-1-terraform-azure-init" class="md-nav__link">
    3.1 Initialisation du déploiement final sur Azure avec Terraform
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-2-terraform-security" class="md-nav__link">
    3.2 Sécurisation de l'organisation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-3-terraform-azure-network-vm" class="md-nav__link">
    3.3 Machine virtuelle et réseau
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-1-helm-chart" class="md-nav__link">
    4.1 Création du Helm chart
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-2-helm-chart-deploy" class="md-nav__link">
    4.2 Déploiement du chart
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-allez-plus-loin" class="md-nav__link">
    5. Allez plus loin
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



  <h1>Print Site</h1>

<div id="print-site-page" class="print-site-enumerate-figures">
        <section class="print-page">
            <div id="print-page-toc" data-toc-depth="3">
                <nav role='navigation' class='print-page-toc-nav'>
                <h1 class='print-page-toc-title'>Table of Contents</h1>
                </nav>
            </div>
        </section>
        <section class="print-page" id="index"><h1 id="index-tutoriel-paas">Tutoriel PaaS<a class="headerlink" href="#index-tutoriel-paas" title="Permanent link">&para;</a></h1>
<p><img alt="résultat" src="../images/result.gif" /></p>
<h3 id="index-architecture">Architecture<a class="headerlink" href="#index-architecture" title="Permanent link">&para;</a></h3>
<p><img alt="archi" src="../images/archi.jpg" /></p>
<h2 id="index-requis-pour-suivre-le-tutoriel">Requis pour suivre le tutoriel<a class="headerlink" href="#index-requis-pour-suivre-le-tutoriel" title="Permanent link">&para;</a></h2>
<h3 id="index-materiel-et-outils">Matériel et outils<a class="headerlink" href="#index-materiel-et-outils" title="Permanent link">&para;</a></h3>
<ul>
<li>Un PC / Mac peu importe l'OS (PC risque d'être instable)</li>
<li>Un compte <a href="http://github.com/">github</a></li>
<li>Un compte <a href="https://azure.microsoft.com/fr-fr/">azure</a> avec le crédit de 100$ offert pour les étudiants (avec l'email myges cela fonctionne normalement)</li>
<li>Valider votre compte <a href="https://education.github.com/globalcampus/student">github student</a> pour ne pas avoir à acheter de nom de domaine. Pour valider utilisez votre adresse mail de l'université.</li>
<li>Un compte <a href="https://hub.docker.com/">docker hub</a></li>
</ul>
<h3 id="index-competences">Compétences<a class="headerlink" href="#index-competences" title="Permanent link">&para;</a></h3>
<ul>
<li>Des bases d'administration système et réseau linux</li>
<li>Algorithmie et programmation sur au moins un langage</li>
<li>Des bases sur les certificats "Secure socket layer" et leur utilisation de la cryptographie asymétrique</li>
<li>Connaissance du langage de configuration <code>yaml</code></li>
<li>Culture sur les infrastructures de déploiement multienvironnements (staging, prod)</li>
<li>Connaissance des concepts d'environnements isolés linux ou <strong>containers</strong></li>
<li>L'outil de gestion de version Git l'hôte git <strong>github</strong></li>
</ul>
<h2 id="index-sommaire">Sommaire<a class="headerlink" href="#index-sommaire" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="#0-install">0. Installation</a></li>
<li><a href="#index-sommaire">1. Rôle ansible</a><ul>
<li><a href="#1-1-ansible-install">1.1 Provisionning du paas avec ansible</a></li>
<li><a href="#1-2-ansible-k3s">1.2 Présentation de K3s et installation</a></li>
<li><a href="#1-3-ansible-manifests">1.3 Installation des manifests (algo)</a></li>
<li><a href="#1-4-ansible-pebble">1.4 Autorité de certification</a></li>
<li><a href="#1-5-ansible-dns">1.5 Mise en place des communications réseau du cluster</a></li>
<li><a href="#1-6-ansible-cert-manager">1.6 Utiliser notre autorité avec cert-manager</a></li>
<li><a href="#1-7-ansible-trust-ca">1.7 Faire confiance à notre autorité de certification</a></li>
<li><a href="#1-8-ansible-dex">1.8 Authentification et des habilitations</a></li>
<li><a href="#1-9-ansible-kubeapps">1.9 Kubeapps</a></li>
</ul>
</li>
<li><a href="#2-packer-playbook">2. Packer</a></li>
<li><a href="#index-sommaire">3. Terraform / Azure</a><ul>
<li><a href="#3-1-terraform-azure-init">3.1 Initialisation du déploiement final sur Azure avec Terraform</a></li>
<li><a href="#3-2-terraform-security">3.2 Sécurisation de l'organisation</a></li>
<li><a href="#3-3-terraform-azure-network.md">3.3 Réseau</a></li>
<li><a href="#3-4-terraform-azure-vm.md">3.4 Machine virtuelle</a></li>
</ul>
</li>
<li>
<p><a href="#index-sommaire">4. Helm chart du microservice</a></p>
<ul>
<li><a href="#4-1-helm-chart">4.1 Création du Helm chart</a></li>
<li><a href="#4-2-helm-chart-deploy">4.2 4.2 Déploiement du chart</a></li>
</ul>
</li>
<li>
<p><a href="#5-allez-plus-loin">5. FAQ et exercices</a></p>
</li>
</ul></section><section class="print-page" id="0-install"><h1 id="0-install-introduction-et-installation">Introduction et installation<a class="headerlink" href="#0-install-introduction-et-installation" title="Permanent link">&para;</a></h1>
<hr />
<p>L'objectif de ce tutoriel est de vous permettre de créer sur une petite machine ou sur un serveur personnel un PaaS (Platform as a service). Un PaaS permet de déployer des applications en microservices. Celui-ci sera basé sur <a href="https://kubernetes.io/fr/">kubernetes</a> pour la conteneurisation et <a href="https://kubeapps.dev/">Kubeapps</a> pour l'interface de déploiement.</p>
<p>L'optique de cet outillage suivra :</p>
<ul>
<li>
<p>le principe <strong>d'immutable infrastructure</strong> avec l'idée de recréer plutôt que de mettre à jour. Ainsi nous aurons recour à des iso linux déjà prêt pour déployer la plateforme <strong>kubernetes</strong> / <strong>kubeapps</strong> directement sur un serveur.</p>
</li>
<li>
<p>Le principe <strong>d'infrastructure as code</strong> (IaC) en gardant toutes la spécification de notre infrastructure dans des configurations et scripts. On utilisera également des tests basiques de nos configurations.</p>
</li>
</ul>
<p>Pour cela nous ferons appel à un socle technique composé de :</p>
<ul>
<li>l'outil <a href="https://k3s.io/"><code>k3s</code></a> qui simplifie l'installation de kubernetes sur des machines ARM tout en restant compatible avec les architectures classiques X64. Il fourni par défaut des pods (containers en execution) pour inclure des fonctionnalités souvent recherchés sur ce type de configuration edge computing. (reverse proxy, configuration DNS...)</li>
<li><a href="https://www.packer.io/">Packer</a> pour créer des images iso de machine linux</li>
<li><a href="https://www.ansible.com/">Ansible</a> pour provisioner cette image</li>
<li><a href="https://azure.microsoft.com/fr-fr/">Azure</a> pour nous founir des serveurs accessible en ssh sur lequels nous pourrons mettre en ligne</li>
<li><a href="https://www.terraform.io/">Terraform</a> pour contrôler azure de manière IaC et de déclencher toute la mise en place du PaaS dessus.</li>
</ul>
<h2 id="0-install-installation-de-docker">Installation de Docker<a class="headerlink" href="#0-install-installation-de-docker" title="Permanent link">&para;</a></h2>
<p>Pour rappel l'architecture de base de docker :</p>
<p><img alt="docker architecture" src="https://docs.docker.com/engine/images/architecture.svg" /></p>
<blockquote>
<p>Source documentation docker</p>
</blockquote>
<p>et les couches des systèmes de conteneurisation docker et kubernetes :</p>
<p><img alt="docker k8s architecture" src="../images/kube-archi.png" /></p>
<p>Pour utilisateurs de <strong>windows</strong> il faut un <a href="https://devblogs.microsoft.com/commandline/a-preview-of-wsl-in-the-microsoft-store-is-now-available/#how-to-install-and-use-wsl-in-the-microsoft-store"><strong>WSL</strong></a>. </p>
<p><strong>Pour WSL</strong> :</p>
<p>Vous utilisez une version de Windows 11 ou supérieure (numéro de version de Windows 22000 ou supérieur).
Vous avez activé le composant optionnel Virtual Machine Platform
Vous pouvez le faire en exécutant : <code>dism.exe /online /enable-feature /featurename:VirtualMachinePlatform /all</code> dans une invite PowerShell élevée.</p>
<p>Cliquez sur ce [lien] (https://aka.ms/wslstorepage) pour accéder à la page du magasin WSL et cliquez sur Installer pour installer WSL.</p>
<p>Traduit avec www.DeepL.com/Translator (version gratuite)</p>
<ul>
<li>Télécharger après avoir suivi cette documentation la distribution linux <code>Ubuntu 20.04.5 LTS</code> depuis le windows store. </li>
<li><strong>+ Windows terminal bien que pas obligatoire il est très pratique pour accéder au shell</strong></li>
</ul>
<p>Ensuite dans vscode installer l'extension wsl <code>ms-vscode-remote.remote-wsl</code>.</p>
<p>Laissez-le ensuite finir de s'initialiser.</p>
<h2 id="0-install-mise-a-jour-de-linux">Mise à jour de Linux<a class="headerlink" href="#0-install-mise-a-jour-de-linux" title="Permanent link">&para;</a></h2>
<p>Ensuite bonne habitude, on met à jour linux :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#0-install-__codelineno-0-1"></a>apt<span class="w"> </span>update<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>apt<span class="w"> </span>upgrade<span class="w"> </span>-y
</code></pre></div>
<p>Puis activer <code>systemd</code> en modifiant <code>/etc/wsl.conf</code> dans votre distribution linux :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#0-install-__codelineno-1-1"></a><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s1">&#39;[boot]\nsystemd=true&#39;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>/etc/wsl.conf
</code></pre></div>
<p>Puis redémarrer l'app Ubuntu. Si des problèmes apparaissent encore lancer la commande <code>wsl --shutdown</code> depuis un powershell en administrateur avant de lancer le shell WSL.</p>
<p>Ensuite pour finaliser l'installation de docker pour éviter les problèmes de droit avec rancher desktop :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#0-install-__codelineno-2-1"></a>sudo<span class="w"> </span>addgroup<span class="w"> </span>--system<span class="w"> </span>docker
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#0-install-__codelineno-2-2"></a>sudo<span class="w"> </span>adduser<span class="w"> </span><span class="nv">$USER</span><span class="w"> </span>docker
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#0-install-__codelineno-2-3"></a>newgrp<span class="w"> </span>docker
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#0-install-__codelineno-2-4"></a><span class="c1"># And something needs to be done so $USER always runs in group `docker` on the `Ubuntu` WSL</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#0-install-__codelineno-2-5"></a>sudo<span class="w"> </span>chown<span class="w"> </span>root:docker<span class="w"> </span>/var/run/docker.sock
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#0-install-__codelineno-2-6"></a>sudo<span class="w"> </span>chmod<span class="w"> </span>g+w<span class="w"> </span>/var/run/docker.sock
</code></pre></div>
<h2 id="0-install-rancher-comme-alternative-a-docker-desktop">Rancher comme alternative à docker desktop<a class="headerlink" href="#0-install-rancher-comme-alternative-a-docker-desktop" title="Permanent link">&para;</a></h2>
<p><a href="https://rancherdesktop.io/"><strong>Rancher</strong></a> l'alternative mieux configurée et sans soucis de license à docker desktop. Il est portable sur windows et mac et nous permet d'avoir une expérience docker complète et fonctionnelle sur notre machine.</p>
<p>Dans les choix proposés dans la mise en place :
- <strong>Décocher kubernetes</strong>
- Choisissez <strong>dockerd</strong> comme moteur de conteneurisation</p>
<p>Vérifier que vous avez bien la commande <code>docker</code> disponible sinon ajouter <code>~/.rd/bin</code> à votre <code>PATH</code> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#0-install-__codelineno-3-1"></a><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;export PATH=&quot;$PATH:$HOME/.rd/bin&quot;&#39;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>~/.zshrc
</code></pre></div>
<p>Puis dans wsl : </p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#0-install-__codelineno-4-1"></a>sudo<span class="w"> </span>systemctl<span class="w"> </span>restart<span class="w"> </span>docker
</code></pre></div>
<h2 id="0-install-installation-de-lenvironnement-python">Installation de l'environnement python<a class="headerlink" href="#0-install-installation-de-lenvironnement-python" title="Permanent link">&para;</a></h2>
<p><strong>Maintenant tout ce que nous allons faire se trouve dans la ligne de commande sur un shell <code>bash</code> ou <code>zsh</code></strong></p>
<p><strong>Conda</strong> : <a href="https://docs.conda.io/en/latest/miniconda.html">docs.conda.io</a>. Installer simplement avec le setup <code>.pkg</code> pour mac.</p>
<blockquote>
<p>Pour Linux et Windows avec WSL utilisez la ligne de commande ci-dessous pour l'installer
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#0-install-__codelineno-5-1"></a>wget<span class="w"> </span>https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh<span class="w"> </span>-P<span class="w"> </span>/tmp
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#0-install-__codelineno-5-2"></a>chmod<span class="w"> </span>+x<span class="w"> </span>/tmp/Miniconda3-latest-Linux-x86_64.sh
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#0-install-__codelineno-5-3"></a>/tmp/Miniconda3-latest-Linux-x86_64.sh<span class="w"> </span>-p<span class="w"> </span><span class="nv">$HOME</span>/miniconda
</code></pre></div></p>
<p>Pour arm :
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#0-install-__codelineno-6-1"></a>wget<span class="w"> </span>https://repo.anaconda.com/miniconda/Miniconda3-py39_4.12.0-Linux-aarch64.sh<span class="w"> </span>-P<span class="w"> </span>/tmp
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#0-install-__codelineno-6-2"></a>chmod<span class="w"> </span>+x<span class="w"> </span>/tmp/Miniconda3-py39_4.12.0-Linux-aarch64.sh
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#0-install-__codelineno-6-3"></a>/tmp/Miniconda3-py39_4.12.0-Linux-aarch64.sh<span class="w"> </span>-p<span class="w"> </span><span class="nv">$HOME</span>/miniconda
</code></pre></div></p>
</blockquote>
<p>Veillez à bien accepter toutes les propositions (licence terms, initialize Miniconda3).</p>
<p>Puis lancer <code>conda init zsh</code> (ou <code>bash</code> si vous préférez)</p>
<p><strong>Relancer votre shell pour appliquer</strong> (commande <code>exec $SHELL</code>)</p>
<h2 id="0-install-installation-de-vscode">Installation de vscode<a class="headerlink" href="#0-install-installation-de-vscode" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://code.visualstudio.com/download">Avec installer toutes plateformes</a></li>
<li>Homebrew sur mac <code>brew install --cask visual-studio-code</code></li>
<li><a href="https://snapcraft.io/code">Avec snap pour linux</a> sur linux</li>
</ul></section><section class="print-page" id="1-1-ansible-install"><h1 id="1-1-ansible-install-11-provisionning-du-paas-avec-ansible">1.1  Provisionning du paas avec ansible<a class="headerlink" href="#1-1-ansible-install-11-provisionning-du-paas-avec-ansible" title="Permanent link">&para;</a></h1>
<hr />
<p>Cette partie très longue présente comment créer le rôle ansible qui va permettre de provisionner un cluster kubernetes sur un serveur linux puis d'y mettre en place la solution de PaaS.</p>
<p>L'objectif d'ansible est de déployer des configurations et des outils sur des machines. À l'aide d'un format de configuration simple
proche de l'algorithmie, nous pourrons amener tous les outils indispensables à la création de notre PaaS.</p>
<h3 id="1-1-ansible-install-installer-ansible-et-creation-du-role">Installer ansible et création du rôle<a class="headerlink" href="#1-1-ansible-install-installer-ansible-et-creation-du-role" title="Permanent link">&para;</a></h3>
<p>Ansible est un outil dépendant de l'écosystème python. Pour simplifier la gestion des dépendances 
qui risquent de faire conflit avec d'autres installations
de python, nous allons utiliser <code>miniconda</code> installé précédemment.</p>
<p>Molecule est un outil permettant de tester nos suites de configurations ansible contenus dans des rôles ou des tâches.</p>
<p>Créer votre espace de travail :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#1-1-ansible-install-__codelineno-0-1"></a><span class="nb">cd</span><span class="w"> </span>~
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#1-1-ansible-install-__codelineno-0-2"></a>mkdir<span class="w"> </span>paas-tutorial/
</code></pre></div>
<p>Ensuite on initialise un environnement virtuel python avec sa propre version de <strong>python 3.9</strong> et les dépendances ansible et molecule. Ainsi nos dépendances n'entrent pas en conflit avec d'autres pouvant être incompatible.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#1-1-ansible-install-__codelineno-1-1"></a>conda<span class="w"> </span>create<span class="w"> </span>-n<span class="w"> </span>playbook-paas<span class="w"> </span><span class="nv">python</span><span class="o">=</span><span class="m">3</span>.9
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#1-1-ansible-install-__codelineno-1-2"></a>conda<span class="w"> </span>activate<span class="w"> </span>playbook-paas
</code></pre></div>
<p>Installer ansible et molecule préconfiguré pour utiliser docker (rancher desktop).
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#1-1-ansible-install-__codelineno-2-1"></a>pip<span class="w"> </span>install<span class="w"> </span><span class="s1">&#39;ansible==6.5.0&#39;</span><span class="w"> </span><span class="s1">&#39;molecule[docker]&#39;</span>
</code></pre></div></p>
<p><strong>Sur windows</strong> lancez cette commande pour avoir accès aux dépendances python directement.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#1-1-ansible-install-__codelineno-3-1"></a><span class="c1"># ~/.bashrc si vous utiliser bash </span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#1-1-ansible-install-__codelineno-3-2"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;export PATH=\&quot;</span><span class="nv">$PATH</span><span class="s2">:</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span><span class="s2">/.local/bin\&quot;&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>~/.zshrc
</code></pre></div>
<p>Vérifier que tous fonctionne avec <code>ansible --version</code>.</p>
<p>Vous devriez avoir <code>ansible [core 2.13.4]</code> dans le retour</p>
<h3 id="1-1-ansible-install-bonus-pour-faire-fonctionner-lextension-vscode-ansible"><strong>Bonus</strong> pour faire fonctionner l'extension VsCode ansible<a class="headerlink" href="#1-1-ansible-install-bonus-pour-faire-fonctionner-lextension-vscode-ansible" title="Permanent link">&para;</a></h3>
<blockquote>
<p><strong>Warning</strong>: Utilisateur du WSL <strong>Pour utiliser vscode, utilisez le impérativement via la ligne de commande linux WSL dans votre projet <code>~/paas-tutorial</code></strong> : <code>code .</code></p>
<p>Vscode : <code>.vscode/settings.json</code>
Remplacez bien le chemin avec le résultat de cette commande <code>which python</code>
miniconda sur wsl, mambaforge sur mac
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#1-1-ansible-install-__codelineno-4-1"></a><span class="p">{</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#1-1-ansible-install-__codelineno-4-2"></a><span class="w">    </span><span class="nt">&quot;ansible.python.interpreterPath&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;User-Path&gt;/mambaforge/envs/playbook-paas/bin/python&quot;</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#1-1-ansible-install-__codelineno-4-3"></a><span class="p">}</span>
</code></pre></div></p>
</blockquote>
<h3 id="1-1-ansible-install-b-playbook-ansible">B. Playbook ansible<a class="headerlink" href="#1-1-ansible-install-b-playbook-ansible" title="Permanent link">&para;</a></h3>
<p>Un playbook ansible est un projet chargé de lancer plusieurs rôles différents sur des machines disponibles sur le réseau via <strong>ssh</strong>. (localhost par exemple peut être provisioné).</p>
<p>Pour aller plus loin dans le fonctionnement de ansible, cet outil s'appuie intégralement sur l'environnement python installé sur une machine invités (que l'on provisionne). Grâce à python ansible va abstraire la complexité de l'administration système linux avec des <strong>déclarations yaml</strong>, des <strong>templates</strong> pour créer des fichiers dynamiquement, des <strong>structures de contrôles</strong> algorithmique et des variables manipulables avec des <strong>filters</strong>.</p>
<h4 id="1-1-ansible-install-on-commence">On Commence :<a class="headerlink" href="#1-1-ansible-install-on-commence" title="Permanent link">&para;</a></h4>
<p>On va créer un dossier playbook pour mettre tout ce qui concerne ansible</p>
<p>Aussi, on va geler les versions des dépendances dans un fichier requirements pour qu'un autre environnement puisse facilement retrouver l'état de votre installation sans problèmes de compatibilités.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#1-1-ansible-install-__codelineno-5-1"></a>mkdir<span class="w"> </span>-p<span class="w"> </span>paas-tutorial/playbook
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#1-1-ansible-install-__codelineno-5-2"></a><span class="nb">cd</span><span class="w"> </span>paas-tutorial/playbook
</code></pre></div>
<p>Geler les dépendances pour éviter des soucis de compatibilité plus tard.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#1-1-ansible-install-__codelineno-6-1"></a>pip<span class="w"> </span>freeze<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-E<span class="w"> </span><span class="s2">&quot;ansible|molecule&quot;</span><span class="w"> </span>&gt;<span class="w"> </span>requirements.txt
</code></pre></div>
<blockquote>
<p>Nous allons suivre <strong>l'alternative-directory-layout</strong> recommandé par cette <a href="https://docs.ansible.com/ansible/latest/user_guide/sample_setup.html#alternative-directory-layout">documentation</a></p>
</blockquote>
<p>Voici la suite complète de commande pour créer la structure du playbook.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#1-1-ansible-install-__codelineno-7-1"></a>touch<span class="w"> </span>site.yml
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#1-1-ansible-install-__codelineno-7-2"></a>touch<span class="w"> </span>requirements.yaml
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#1-1-ansible-install-__codelineno-7-3"></a>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#1-1-ansible-install-__codelineno-7-4"></a>mkdir<span class="w"> </span>roles/
</code></pre></div>
<p>Ensuite dans <code>requirements.yaml</code> on importe les roles que l'on utilise en dépendances.</p>
<blockquote>
<p>Ansible galaxy est le gestionnaire de paquet pour importer des rôles et des collections ansible dans un playbook.</p>
<p><strong>Note</strong> pour l'instant, il y a un bug avec galaxy nous empêchant de récupérer la bonne version de k3s. On peut forcer l'utilisation directe de git pour récupérer la version 3.3.0</p>
</blockquote>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/requirements.yaml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#1-1-ansible-install-__codelineno-8-1"> 1</a></span>
<span class="normal"><a href="#1-1-ansible-install-__codelineno-8-2"> 2</a></span>
<span class="normal"><a href="#1-1-ansible-install-__codelineno-8-3"> 3</a></span>
<span class="normal"><a href="#1-1-ansible-install-__codelineno-8-4"> 4</a></span>
<span class="normal"><a href="#1-1-ansible-install-__codelineno-8-5"> 5</a></span>
<span class="normal"><a href="#1-1-ansible-install-__codelineno-8-6"> 6</a></span>
<span class="normal"><a href="#1-1-ansible-install-__codelineno-8-7"> 7</a></span>
<span class="normal"><a href="#1-1-ansible-install-__codelineno-8-8"> 8</a></span>
<span class="normal"><a href="#1-1-ansible-install-__codelineno-8-9"> 9</a></span>
<span class="normal"><a href="#1-1-ansible-install-__codelineno-8-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="nn">---</span>
<a id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="nt">roles</span><span class="p">:</span><span class="w"> </span>
<a id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">xanmanning.k3s</span>
<a id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="w">      </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://github.com/PyratLabs/ansible-role-k3s.git</span>
<a id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="w">      </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v3.3.0</span>
<a id="__codelineno-8-6" name="__codelineno-8-6"></a>
<a id="__codelineno-8-7" name="__codelineno-8-7"></a><span class="nt">collections</span><span class="p">:</span>
<a id="__codelineno-8-8" name="__codelineno-8-8"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">community.general</span>
<a id="__codelineno-8-9" name="__codelineno-8-9"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes.core</span>
<a id="__codelineno-8-10" name="__codelineno-8-10"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">azure.azcollection</span>
</code></pre></div></td></tr></table></div>
<p>Les <strong>collections</strong> vont servir à ajouter des fonctionnalités à ansible et ses directives de tâches. Ici on ajoute les fonctionnalités fondamentales ainsi que celles pour manipuler notre cluster kubernetes (abstraction de la commande <code>kubectl</code>).</p>
<p>Les <strong>roles</strong> correspondent à des suites de tâches qui vont installer et configurer un outil sur une machine. Ici on utilisera un <a href="https://github.com/PyratLabs/ansible-role-k3s">role k3s</a> qui s'occupe de configurer en fonction de nos paramètres le cluster k3s.</p>
<blockquote>
<p><strong>Note</strong> K3s n'utilise pas <code>docker</code> mais <code>containerd</code> pour utiliser les fonctionnalités de conteneur linux.</p>
</blockquote>
<p>Pour installer ces <code>requirements</code> maintenant on lance dans le dossier <code>playbook/</code> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#1-1-ansible-install-__codelineno-9-1"></a>ansible-galaxy<span class="w"> </span>install<span class="w"> </span>-r<span class="w"> </span>requirements.yaml
</code></pre></div>
<p>Normalement tous est installé correctement et prêt à l'emploi.</p>
<h3 id="1-1-ansible-install-c-initialiser-le-role-installant-un-cluster-kubernetes-k3s">C. Initialiser le rôle installant un Cluster kubernetes (k3s)<a class="headerlink" href="#1-1-ansible-install-c-initialiser-le-role-installant-un-cluster-kubernetes-k3s" title="Permanent link">&para;</a></h3>
<p>Pour suivre la convention d'ansible nous allons procéder en créant un rôle. Il sera ici interne à notre projet pour simplifier, mais on peut imaginer facilement le déplacer dans un autre repository.
Son objectif sera d'installer un ensemble de solutions pour faire fonctionner kubeapps.</p>
<p>Dans le dossier <code>playbook</code> faites donc :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#1-1-ansible-install-__codelineno-10-1"></a>mkdir<span class="w"> </span>roles
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#1-1-ansible-install-__codelineno-10-2"></a><span class="nb">cd</span><span class="w"> </span>roles
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#1-1-ansible-install-__codelineno-10-3"></a>ansible-galaxy<span class="w"> </span>init<span class="w"> </span>kubeapps
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#1-1-ansible-install-__codelineno-10-4"></a><span class="nb">cd</span><span class="w"> </span>kubeapps
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#1-1-ansible-install-__codelineno-10-5"></a><span class="c1"># Créer un scénario de test par défaut</span>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#1-1-ansible-install-__codelineno-10-6"></a>molecule<span class="w"> </span>init<span class="w"> </span>scenario<span class="w"> </span>-d<span class="w"> </span>docker<span class="w"> </span>default
</code></pre></div>
<p>Vous devriez obtenir cette structure dans le nouveau dossier <code>playbook/</code> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#1-1-ansible-install-__codelineno-11-1"></a>README.md 
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#1-1-ansible-install-__codelineno-11-2"></a>defaults/
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#1-1-ansible-install-__codelineno-11-3"></a>files/     
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#1-1-ansible-install-__codelineno-11-4"></a>handlers/
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#1-1-ansible-install-__codelineno-11-5"></a>molecule/default
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#1-1-ansible-install-__codelineno-11-6"></a>meta/      
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#1-1-ansible-install-__codelineno-11-7"></a>tasks/     
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#1-1-ansible-install-__codelineno-11-8"></a>templates/ 
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#1-1-ansible-install-__codelineno-11-9"></a>tests/    
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#1-1-ansible-install-__codelineno-11-10"></a>vars/
</code></pre></div>
<p>Voici ce que va être rendu comme structure de <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_reuse_roles.html"><strong>rôle</strong></a>.</p>
<p>Nous allons ensuite mettre à jour les métadonnées ansible galaxy avec notamment la dépendance kubernetes (rôle k3s). Il y a déjà du contenu présent, ne supprimer rien et ajouter à la ligne 51 la case du tableau <code>dependencies</code>.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/roles/kubeapps/meta/main.yml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#1-1-ansible-install-__codelineno-12-51">51</a></span>
<span class="normal"><a href="#1-1-ansible-install-__codelineno-12-52">52</a></span>
<span class="normal"><a href="#1-1-ansible-install-__codelineno-12-53">53</a></span>
<span class="normal"><a href="#1-1-ansible-install-__codelineno-12-54">54</a></span>
<span class="normal"><a href="#1-1-ansible-install-__codelineno-12-55">55</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-12-51" name="__codelineno-12-51"></a><span class="nt">dependencies</span><span class="p">:</span>
<a id="__codelineno-12-52" name="__codelineno-12-52"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">xanmanning.k3s</span>
<a id="__codelineno-12-53" name="__codelineno-12-53"></a><span class="w">      </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v3.3.0</span>
<a id="__codelineno-12-54" name="__codelineno-12-54"></a><span class="w">      </span><span class="nt">vars</span><span class="p">:</span>
<a id="__codelineno-12-55" name="__codelineno-12-55"></a><span class="w">        </span><span class="nt">k3s_release_version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1.21</span>
</code></pre></div></td></tr></table></div>
<blockquote>
<p><code>k3s_release_version</code> est indispensable de ne pas monter au-dessus de la version <code>1.21</code>. Dans le contexte docker in docker, il y a des problèmes de compatibilité avec les fonctionnalités linux récentes (QOS, cgroups, ...).</p>
</blockquote>
<p>Ensuite vous devez obligatoirement définir ces Informations sur les metas du rôles:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/roles/kubeapps/meta/main.yml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#1-1-ansible-install-__codelineno-13-1">1</a></span>
<span class="normal"><a href="#1-1-ansible-install-__codelineno-13-2">2</a></span>
<span class="normal"><a href="#1-1-ansible-install-__codelineno-13-3">3</a></span>
<span class="normal"><a href="#1-1-ansible-install-__codelineno-13-4">4</a></span>
<span class="normal"><a href="#1-1-ansible-install-__codelineno-13-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="nt">galaxy_info</span><span class="p">:</span>
<a id="__codelineno-13-2" name="__codelineno-13-2"></a><span class="w">  </span><span class="nt">author</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">loic-roux-404</span>
<a id="__codelineno-13-3" name="__codelineno-13-3"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">paas_tutorial</span>
<a id="__codelineno-13-4" name="__codelineno-13-4"></a><span class="w">  </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubeapps deployment</span>
<a id="__codelineno-13-5" name="__codelineno-13-5"></a><span class="w">  </span><span class="nt">role_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubeapps</span>
</code></pre></div></td></tr></table></div>
<p>Le rôle kubernetes se lancera donc directement avant les tâches de celui de kubeapps.</p>
<hr /></section><section class="print-page" id="1-2-ansible-k3s"><h1 id="1-2-ansible-k3s-12-presentation-de-k3s-et-installation">1.2 Présentation de K3s et installation<a class="headerlink" href="#1-2-ansible-k3s-12-presentation-de-k3s-et-installation" title="Permanent link">&para;</a></h1>
<hr />
<p>K3s est une distribution légère de Kubernetes conçue pour être facile à installer et à utiliser dans des environnements à ressources limitées tels que les appareils edge et IoT. Il convient également bien pour fonctionner sur des appareils basés sur Arm, ce qui en fait un choix populaire pour les grappes Raspberry Pi. </p>
<p>K3s peut exécuter toutes les charges de travail Kubernetes, mais il a une empreinte plus petite et nécessite moins de ressources qu'une installation Kubernetes traditionnelle.</p>
<h3 id="1-2-ansible-k3s-notions-theoriques-sur-kubernetes">Notions théoriques sur kubernetes<a class="headerlink" href="#1-2-ansible-k3s-notions-theoriques-sur-kubernetes" title="Permanent link">&para;</a></h3>
<h3 id="1-2-ansible-k3s-noeud">Noeud<a class="headerlink" href="#1-2-ansible-k3s-noeud" title="Permanent link">&para;</a></h3>
<p>Un nœud est une machine de travail dans Kubernetes, un groupe de nœud va composer ce qu'on appelle un cluster (grappe) de serveurs. Chaque nœud contient les services nécessaires à l'exécution de pods et est géré par les composants du master.</p>
<blockquote>
<p><strong>Note</strong> dans notre cas nous ferons appel à un seul noeud master</p>
</blockquote>
<h3 id="1-2-ansible-k3s-namespace">Namespace<a class="headerlink" href="#1-2-ansible-k3s-namespace" title="Permanent link">&para;</a></h3>
<p>Clusters virtuels présents sur le même cluster physique. Ces clusters virtuels sont appelés namespaces. Ils utilisent les fonctionnalités de groupage de linux Cgroup.</p>
<h3 id="1-2-ansible-k3s-les-pods">Les pods<a class="headerlink" href="#1-2-ansible-k3s-les-pods" title="Permanent link">&para;</a></h3>
<p><a href="https://kubernetes.io/fr/docs/concepts">source documentation officielle</a></p>
<p>Un pod est un groupe d'un ou plusieurs conteneurs (comme des conteneurs Docker), ayant du stockage/réseau partagé et une spécification sur la manière d'exécuter ces conteneurs. Les éléments d'un pod sont toujours co-localisés et co-ordonnancés, et s'exécutent dans un contexte partagé. Un pod modélise un "hôte logique" spécifique à une application - il contient un ou plusieurs conteneurs applicatifs qui sont étroitement liés.</p>
<p>Un pod peut être :</p>
<ul>
<li>Temporaire (Completed) pour effectuer une tâches particulière (cron, jouer des script, déploiement d'autres pods...)</li>
<li>Définitif soit une application en exécution</li>
</ul>
<h3 id="1-2-ansible-k3s-deploiement">Déploiement<a class="headerlink" href="#1-2-ansible-k3s-deploiement" title="Permanent link">&para;</a></h3>
<p>Comme un le fait en développement un fichier docker-compose, cette ressource décrit la mise en place des containers avant de les placer dans un pod (plusieurs containers peuvent se placer dans un pod)</p>
<h3 id="1-2-ansible-k3s-services">Services<a class="headerlink" href="#1-2-ansible-k3s-services" title="Permanent link">&para;</a></h3>
<p>Une manière abstraite d'exposer une application s'exécutant sur un ensemble de Pods en tant que service réseau.</p>
<h2 id="1-2-ansible-k3s-ingress">Ingress<a class="headerlink" href="#1-2-ansible-k3s-ingress" title="Permanent link">&para;</a></h2>
<p>Il s'agit du composant de kubernetes permettant de gérer au travers d'une technologie de reverse proxy et de répartition de charge le trafic réseau entrant (http(s)).</p>
<blockquote>
<p><strong>Note</strong> Un <strong>reverse proxy</strong> est à l'inverse d'un proxy chargé d'effectuer une action à partir d'une requête réseau externe. On l'utilise majoritairement avec un serveur DNS qui fait pointer des noms de domaines et sous domaines vers l'adresse Ip du serveur sur lequel un reverse proxy est installé.
Par exemple, il va servir à rediriger le traffic de la requête <code>kubeapps.k3s.local</code> vers une adresse et port réseau attribué par kubernetes à un pod.</p>
</blockquote>
<p>Voici pour résumer l'achitecture réseau d'un cluster kubernetes :</p>
<p><img alt="architecture réseau kubernetes" src="../images/k8s-archi.jpg" /></p>
<h2 id="1-2-ansible-k3s-specificite-de-k3s">Spécificité de k3s<a class="headerlink" href="#1-2-ansible-k3s-specificite-de-k3s" title="Permanent link">&para;</a></h2>
<p>K3s est une sorte d'implémentation alléger de kubernetes pour le rendre portable sur plus de plateformes comme des nano ordinateur et des infrastructures en périphérie de réseau (Edge computing).</p>
<p>Nous avons donc à la place de <code>etcd</code> comme outil de persistance du stockage <code>sqlite</code>, un ingress (ou reverse proxy) par défaut à <code>traefik</code> et on trouve nombreux composants coeur comme le kuber-controller-manager ou le scheduder ramené au plus proche du système (services réseaux au lieu de pods).</p>
<h2 id="1-2-ansible-k3s-larchitecture-autour-de-kubeapps">L'architecture autour de Kubeapps<a class="headerlink" href="#1-2-ansible-k3s-larchitecture-autour-de-kubeapps" title="Permanent link">&para;</a></h2>
<p>Pour rappel kubeapps nous sert à déployer des applications conteneurisées "packagées" au format helm chart dans un cluster kubernetes.
Il aura besoin de plusieurs autres outils pour fonctionner de manière sécurisée avec kubernetes.</p>
<ul>
<li>Une autorité de certification locale et Acme server pour nos tests <a href="https://github.com/letsencrypt/pebble">pebble</a></li>
<li>Un gestionnaire de certificats dédié à kubernetes <a href="https://cert-manager.io/">cert-manager</a></li>
<li>Un <strong>serveur openid</strong> exploitant une application oauth2 github : <a href="https://dexidp.io/">dex idp</a></li>
</ul>
<p>Voilà donc tout ce qu'on aura à mettre en place dans notre rôle ansible.</p>
<h3 id="1-2-ansible-k3s-e-premiers-tests-sur-le-role">E. Premiers tests sur le rôle<a class="headerlink" href="#1-2-ansible-k3s-e-premiers-tests-sur-le-role" title="Permanent link">&para;</a></h3>
<p>Nous allons d'abord définir l'utilisation d'une distribution ubuntu pour installer nos outils. Pour les tests en local, nous faisons du <strong>docker in docker</strong> ce qui impose des configurations particulières.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/roles/kubeapps/molecule/default/molecule.yml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#1-2-ansible-k3s-__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-0-10">10</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-0-11">11</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-0-12">12</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-0-13">13</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-0-14">14</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-0-15">15</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-0-16">16</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-0-17">17</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-0-18">18</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-0-19">19</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-0-20">20</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-0-21">21</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-0-22">22</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-0-23">23</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nn">---</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="nt">dependency</span><span class="p">:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">galaxy</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="nt">driver</span><span class="p">:</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docker</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="nt">platforms</span><span class="p">:</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">node-0</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">geerlingguy/docker-${MOLECULE_DISTRO:-ubuntu2004}-ansible:latest</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${MOLECULE_DOCKER_COMMAND:-&quot;&quot;}</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="w">    </span><span class="nt">privileged</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="w">    </span><span class="nt">pre_build_image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/sys/fs/cgroup:/sys/fs/cgroup:rw</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/lib/rancher/k3s</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="w">    </span><span class="nt">network_mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">host</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="w">    </span><span class="nt">tmpfs</span><span class="p">:</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/run</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/run</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="nt">provisioner</span><span class="p">:</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ansible</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="nt">verifier</span><span class="p">:</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ansible</span>
</code></pre></div></td></tr></table></div>
<blockquote>
<p><strong>Warning</strong> : le <code>name</code> de la platform va nous servir d'adresse réseau par laquelle ansible sur l'hôte va pouvoir accéder en ssh. Il est indispensable de le renseigner, car le role k3s en a besoin pour bien créer les nœud du cluster kubernetes. (même si on en utilise un seul)</p>
</blockquote>
<p>L'image du container <code>geerlingguy/docker-${MOLECULE_DISTRO:-ubuntu2004}</code> va nous permettre d'utiliser un linux préconfiguré qui s'initialise avec le démon <code>systemd</code>. Celui ci est une fonctionnalité assez neuve du coeur et recommandée pour la gestion des services en arrière plan (daemons) soit ici k3s</p>
<p>On note que l'on publie le port <code>80</code> et <code>443</code> à des fins de debug pour exposer Ingress.</p>
<blockquote>
<p><code>32444</code> le port pebble servira plus tard pour accéder à notre serveur ACME</p>
<p><strong><em>*Warning</em>* vérifie bien qu'aucun autre processus su votre machine n'utilise déjà le port 80 et 443</strong></p>
</blockquote>
<p>Les <strong>volumes</strong> que l'on utilise servent à rendre disponible des fonctionnalités du coeur linux désactivées par défaut sur des containers docker comme <code>systemd</code> et les <a href="https://fr.wikipedia.org/wiki/Espace_de_noms">espaces de nom</a> / <a href="https://kubernetes.io/docs/concepts/architecture/cgroups/"><code>cgroup</code> version 2</a>. 
Même chose pour le répertoire temporaire <code>tmpfs</code> qui assurent le bon fonctionnement de ces outils. 
Enfin <code>priviledgied: true</code> nous donne les droits administrateur complets sur le système du container.</p>
<p>Le playbook <code>verifier</code> va ensuite nous permettre de tester la bonne exécution du rôle et de ses dépendances.</p>
<h4 id="1-2-ansible-k3s-le-playbook-converge">Le playbook converge<a class="headerlink" href="#1-2-ansible-k3s-le-playbook-converge" title="Permanent link">&para;</a></h4>
<p>Ce playbook représente la façon dont on utilisera en condition réelle notre appel du rôle en ajoutant cependant des prérequis spécifique à notre environnement de test.</p>
<blockquote>
<p><strong>Note</strong> la partie <code>dig_host_docker_internal</code> servira à récupérer l'adresse ip de l'hôte docker pour pouvoir y accéder depuis les pods. C'est une astuce pour contourner le problème de résolution de domaines des pods avec un réseau sur localhost. C'est grâce à <code>network_mode: host</code> que l'on peut faire cela.</p>
</blockquote>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/roles/kubeapps/molecule/default/converge.yml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#1-2-ansible-k3s-__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-1-10">10</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-1-11">11</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-1-12">12</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-1-13">13</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-1-14">14</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-1-15">15</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-1-16">16</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-1-17">17</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-1-18">18</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-1-19">19</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-1-20">20</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-1-21">21</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-1-22">22</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-1-23">23</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-1-24">24</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-1-25">25</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-1-26">26</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-1-27">27</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-1-28">28</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-1-29">29</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-1-30">30</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-1-31">31</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-1-32">32</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-1-33">33</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-1-34">34</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-1-35">35</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-1-36">36</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-1-37">37</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="nn">---</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Converge</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">all</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">  </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">  </span><span class="nt">vars</span><span class="p">:</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="w">    </span><span class="nt">molecule_is_test</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="w">  </span><span class="nt">roles</span><span class="p">:</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">role</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">lookup(&#39;env&#39;,</span><span class="nv"> </span><span class="s">&#39;MOLECULE_PROJECT_DIRECTORY&#39;)</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">basename</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="w">  </span><span class="nt">pre_tasks</span><span class="p">:</span>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ensure test dependencies are installed.</span>
<a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="w">      </span><span class="nt">package</span><span class="p">:</span><span class="w"> </span>
<a id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="w">        </span><span class="nt">name</span><span class="p">:</span>
<a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">iptables</span>
<a id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">curl</span>
<a id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dnsutils</span>
<a id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span>
<a id="__codelineno-1-19" name="__codelineno-1-19"></a><span class="w">        </span><span class="nt">update_cache</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="w">      </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ansible_os_family == &#39;Debian&#39;</span>
<a id="__codelineno-1-21" name="__codelineno-1-21"></a>
<a id="__codelineno-1-22" name="__codelineno-1-22"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install pre-requisites for k8s module</span>
<a id="__codelineno-1-23" name="__codelineno-1-23"></a><span class="w">      </span><span class="nt">ansible.builtin.pip</span><span class="p">:</span>
<a id="__codelineno-1-24" name="__codelineno-1-24"></a><span class="w">        </span><span class="nt">name</span><span class="p">:</span>
<a id="__codelineno-1-25" name="__codelineno-1-25"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">openshift</span>
<a id="__codelineno-1-26" name="__codelineno-1-26"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pyyaml</span>
<a id="__codelineno-1-27" name="__codelineno-1-27"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes</span>
<a id="__codelineno-1-28" name="__codelineno-1-28"></a>
<a id="__codelineno-1-29" name="__codelineno-1-29"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dig host.docker.internal address</span>
<a id="__codelineno-1-30" name="__codelineno-1-30"></a><span class="w">      </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dig +short host.docker.internal</span>
<a id="__codelineno-1-31" name="__codelineno-1-31"></a><span class="w">      </span><span class="nt">register</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dig_host_docker_internal</span>
<a id="__codelineno-1-32" name="__codelineno-1-32"></a><span class="w">      </span><span class="nt">changed_when</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<a id="__codelineno-1-33" name="__codelineno-1-33"></a><span class="w">      </span><span class="nt">tags</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">kubeapps</span><span class="p p-Indicator">]</span>
<a id="__codelineno-1-34" name="__codelineno-1-34"></a>
<a id="__codelineno-1-35" name="__codelineno-1-35"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">ansible.builtin.set_fact</span><span class="p">:</span>
<a id="__codelineno-1-36" name="__codelineno-1-36"></a><span class="w">        </span><span class="nt">kubeapps_internal_acme_network_ip</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">dig_host_docker_internal.stdout</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-1-37" name="__codelineno-1-37"></a><span class="w">      </span><span class="nt">tags</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">kubeapps</span><span class="p p-Indicator">]</span>
</code></pre></div></td></tr></table></div>
<blockquote>
<p>Notes :
- <code>hosts: all</code> permet de jouer le playbook sur tous les hôtes
- <code>role: {{etc...}}</code> résoud le chemin de fichier vers le répertoire du rôle
- Les pré-tâches servent à installer des packages linux et python manquant à notre container utiles pour l'environnement local et les tests.</p>
</blockquote>
<h4 id="1-2-ansible-k3s-le-playbook-verify">Le playbook verify<a class="headerlink" href="#1-2-ansible-k3s-le-playbook-verify" title="Permanent link">&para;</a></h4>
<p>Nous allons ensuite vérifier que k3s est bien prêt avec deux vérifications :</p>
<ul>
<li>Vérification de la bonne initialisation du nœud <strong>master</strong> 
simplement en vérifiant que le retour de la commande contient bien "Ready    master".</li>
</ul>
<p>On utilise pour cette fois la commande <code>kubectl</code> directement. Pour en savoir plus pour cette commande centrale dans l'utilisation d'un cluster kubernetes <a href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands">c'est ici</a></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/roles/kubeapps/molecule/default/verify.yml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#1-2-ansible-k3s-__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-2-10">10</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-2-11">11</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-2-12">12</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-2-13">13</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-2-14">14</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-2-15">15</a></span>
<span class="normal"><a href="#1-2-ansible-k3s-__codelineno-2-16">16</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="nn">---</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Verify</span>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">all</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="w">  </span><span class="nt">gather_facts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Get single node</span>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="w">      </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubectl get nodes</span>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="w">      </span><span class="nt">changed_when</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<a id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="w">      </span><span class="nt">register</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes_nodes</span>
<a id="__codelineno-2-10" name="__codelineno-2-10"></a>
<a id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Print list of running nodes.</span>
<a id="__codelineno-2-12" name="__codelineno-2-12"></a><span class="w">      </span><span class="nt">debug</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">var=kubernetes_nodes.stdout</span>
<a id="__codelineno-2-13" name="__codelineno-2-13"></a>
<a id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Assert master node ready</span>
<a id="__codelineno-2-15" name="__codelineno-2-15"></a><span class="w">      </span><span class="nt">ansible.builtin.assert</span><span class="p">:</span>
<a id="__codelineno-2-16" name="__codelineno-2-16"></a><span class="w">        </span><span class="nt">that</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;&quot;node-0</span><span class="nv">   </span><span class="s">Ready</span><span class="nv">    </span><span class="s">control-plane,master&quot;</span><span class="nv"> </span><span class="s">in</span><span class="nv"> </span><span class="s">kubernetes_nodes.stdout&#39;</span>
</code></pre></div></td></tr></table></div>
<p>Lancer votre premier test avec <code>molecule test</code> et voilà vous avez un playbook offrant un cluster kubernetes prêt à l'emploi tout en suivant rigoureusement le concept du test driven development pour plus de fiabilité.</p>
<blockquote>
<p><strong>Note</strong> : Vous pouvez aussi lancer <code>molecule test --destroy never</code> pour ensuite garder le conteneur et debugger l'état du système après le "provision" ansible avec <code>molecule login</code> (qui équivaut à <code>docker exec -it node-0 bash</code>)</p>
<p><strong>Note</strong> : En cas d'erreur <code>export ANSIBLE_STDOUT_CALLBACK=yaml</code> avant de lancer <code>molecule test</code> pour avoir un meilleur rendu de la possible erreur.</p>
</blockquote>
<p>Ensuite dans la suite du fichier on procède à une vérification des pods de la suite k3s. </p>
<blockquote>
<p>Vous pourrez relancer seulement la suite de vérification avec <code>molecule verify</code> si votre container n'a pas été détruit (<code>--destroy false</code>)</p>
</blockquote>
<p>Nous savons ici que k3s est lancé. En sachant que ce rôle est externe nous n'avons pas besoin de faire plus de tests sur ces composants centraux disposés dans le namespace <code>kube-system</code>.</p>
<p>On valide bien que le service est de type cluster ip. Cela signifie qu'il est exposé dans le cluster avec sa propre adresse. Si le type aurait été vide cela aurait voulu dire soit que quelque chose n'est pas correctement configuré soit que kubernetes n'est pas disposé à attribué une configuration réseau à ce service.</p>
<blockquote>
<p><strong>INFO</strong> Kubernetes utilise l'outil natif de linux <code>iptables</code> pour faire fonctionner cette ressource.</p>
</blockquote>
<h4 id="1-2-ansible-k3s-optionnel-utilisation-avec-les-extensions-vscode"><a href="#5-allez-plus-loin-kubernetes-sur-vscode">Optionnel - Utilisation avec les extensions Vscode</a><a class="headerlink" href="#1-2-ansible-k3s-optionnel-utilisation-avec-les-extensions-vscode" title="Permanent link">&para;</a></h4>
<hr /></section><section class="print-page" id="1-3-ansible-manifests"><h1 id="1-3-ansible-manifests-13-algo-dinstallation-des-manifests">1.3 Algo d'installation des manifests<a class="headerlink" href="#1-3-ansible-manifests-13-algo-dinstallation-des-manifests" title="Permanent link">&para;</a></h1>
<hr />
<p>Nous allons avoir recours ici à deux nouvelles notions de l'écosystème de kubernetes qui sont</p>
<ul>
<li>Les manifests que l'on utilise pour décrire une ressources (déploiement, service, pods, ingress,...) à déployer dans le cluster avec la commande <code>kubectl</code></li>
</ul>
<p>Pour l'exemple cette commande <code>kubectl get pods -n kube-system</code> récupère la liste des pods dans le namespace du système de k3s
Voici le retour qu'elle nous donne :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#1-3-ansible-manifests-__codelineno-0-1"></a>  &quot;local-path-provisioner-84bb864455-8dz4g   1/1     Running     0          7h58m&quot;,
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#1-3-ansible-manifests-__codelineno-0-2"></a>  &quot;svclb-traefik-qv89r                       2/2     Running     0          7h57m&quot;,
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#1-3-ansible-manifests-__codelineno-0-3"></a>  &quot;coredns-574bcc6c46-pr6vq                  1/1     Running     0          7h58m&quot;,
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#1-3-ansible-manifests-__codelineno-0-4"></a>  &quot;metrics-server-ff9dbcb6c-ncr4n            1/1     Running     0          7h58m&quot;,
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#1-3-ansible-manifests-__codelineno-0-5"></a>  &quot;traefik-56c4b88c4b-p4xt6                  1/1     Running     0          7h57m&quot;,
</code></pre></div>
<p>Les commandes kubectl fonctionnent tout le temps de la sorte <code>kubectl &lt;action&gt; &lt;resource&gt; -n &lt;namespace&gt; -o &lt;format&gt;</code></p>
<ul>
<li><code>&lt;action&gt;</code> soit une action CRUD : <code>edit</code>, <code>get</code>, <code>describe</code></li>
<li><code>&lt;resource&gt;</code> pour en savoir plus sur les différentes ressources disponibles <code>kubectl api-resources</code>. Nous aurons majoritairement recours à <code>deployment</code>, <code>service</code>, <code>ingress</code>, <code>pod</code>, <code>secret</code>, <code>configmap</code></li>
<li><code>-o</code> est très pratique quand on veut un vrai détail sur les ressources avec notamment le <code>-o yaml</code></li>
</ul>
<blockquote>
<p>La commande pod est un peu particulière : voici un exemple utilisant le retour au-dessus en exemple : <code>kubectl get pods -n kube-system traefik-56c4b88c4b-p4xt6</code> (on précise le nom complet du pod)</p>
<p>Astuce le flag <code>-A</code> permet de regarder tous les pod sur n'importe quel namespace. Par exemple <code>kubectl get po -A</code> (<code>po</code> est un diminutif de <code>pods</code>, on a aussi par exemple <code>svc</code> pour service)</p>
</blockquote>
<ul>
<li><a href="https://helm.sh/fr/docs/intro/using_helm/">Helm</a> un gestionnaire de paquet pour distribuer des <strong>charts</strong> (ou package) contenant des suites de manifest kubernetes à déployer sur le cluster.
Pour cela nous aurons recours à cette utilisation au travers de k3s et d'un <a href="https://docs.k3s.io/helm#automatically-deploying-manifests-and-helm-charts">module <code>helm.cattle.io/v1</code></a> permettant le deploiement automatique de resources kubernetes.</li>
</ul>
<p><img alt="helm" src="../images/helm-kubernetes.png" /></p>
<p>Donc dans <a href="#playbook-roles-kubeapps">playbook/roles/kubeapps/tasks</a> nous allons travailler sur ces éléments de ansible :</p>
<ul>
<li>
<p><code>tasks/main.yaml</code>: déclenche certaines suites de tâches en fonction de l'état choisi dans les variables de configuration. Elles sont définies dans l'ordre :</p>
</li>
<li>
<p>Les variables par défaut <code>default/main.yaml</code>. On pourra par la suite les surcharger avec celle du playbook (inventories/{env}/all.yaml)</p>
</li>
<li>
<p>Les variables par défaut <code>default/vars.yaml</code> sont comme default/main.yaml mais pour des variables non configurables.</p>
</li>
<li>
<p><code>templates/</code> qui contient des fichiers <code>.j2</code> ou templates <code>jinja</code> représentant plusieurs manifests kubernetes.</p>
</li>
<li>
<p><code>tasks/manifests.yaml</code> : celui-ci va s'occuper de placer les manifests kubernetes dans le répertoire <code>/var/lib/rancher/k3s/server/manifests</code> pour que k3s déploie automatiquement les ressources décrites dans ceux-ci.</p>
</li>
</ul>
<blockquote>
<p>Source pour plus d'informations <a href="https://docs.k3s.io/helm#customizing-packaged-components-with-helmchartconfig">doc k3s</a></p>
</blockquote>
<p>On peut remplir le fichier d'entrée comme ceci :</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/roles/kubeapps/tasks/main.yml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#1-3-ansible-manifests-__codelineno-1-10">10</a></span>
<span class="normal"><a href="#1-3-ansible-manifests-__codelineno-1-11">11</a></span>
<span class="normal"><a href="#1-3-ansible-manifests-__codelineno-1-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="nn">---</span>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">include_tasks</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">manifests.yml</span>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">  </span><span class="nt">tags</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">kubeapps</span><span class="p p-Indicator">]</span>
</code></pre></div></td></tr></table></div>
<blockquote>
<p>Astuce : Voici la commande molecule qui permettra de lancer seulement les taches avec le <code>tags: [kubeapps]</code> ceci une fois notre playbook utilisable :</p>
</blockquote>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#1-3-ansible-manifests-__codelineno-2-1"></a>molecule<span class="w"> </span><span class="nb">test</span><span class="w"> </span>--destroy<span class="w"> </span>never<span class="w"> </span>--<span class="w"> </span>-t<span class="w"> </span>kubeapps
</code></pre></div>
<p>Puis allons configurer une suite de tâches pour installer les manifests qu'ils soient une ressource api ou un chart helm.</p>
<p>On commence par mettre en place une boucle ansible prenant en paramètre une liste de dictionnaires python. Ceux-ci comportes comme sous propriétés qui définissent la façon dont notre programme se comporte :</p>
<ul>
<li><code>src</code> : un fichier manifest au format <code>yaml.j2</code> à déployer sur le noeud. Ce format donne la possibilité d'intégrer les <code>variables</code> et <code>facts</code> ansible. </li>
<li><code>ns</code> : pour un namespace sur lequel ajouter le chart et pouvant aussi être un déploiement Kubernetes dont il va valloir attendre le succès.</li>
<li><code>deploy</code>: Pour préciser le nom du déploiement ci celui-ci n'est pas le même que le namespace </li>
<li><code>condition</code>: Simple booléen pour executé ou non le manifest</li>
</ul>
<blockquote>
<p><strong>Info</strong>: Les facts sont des variables définis dynamiquement à partir de l'environnement ou de ce qu'on décide de conserver de nos traitements pendant le processus ansible</p>
</blockquote>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/roles/kubeapps/tasks/manifests.yml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#1-3-ansible-manifests-__codelineno-3-10">10</a></span>
<span class="normal"><a href="#1-3-ansible-manifests-__codelineno-3-11">11</a></span>
<span class="normal"><a href="#1-3-ansible-manifests-__codelineno-3-12">12</a></span>
<span class="normal"><a href="#1-3-ansible-manifests-__codelineno-3-13">13</a></span>
<span class="normal"><a href="#1-3-ansible-manifests-__codelineno-3-14">14</a></span>
<span class="normal"><a href="#1-3-ansible-manifests-__codelineno-3-15">15</a></span>
<span class="normal"><a href="#1-3-ansible-manifests-__codelineno-3-16">16</a></span>
<span class="normal"><a href="#1-3-ansible-manifests-__codelineno-3-17">17</a></span>
<span class="normal"><a href="#1-3-ansible-manifests-__codelineno-3-18">18</a></span>
<span class="normal"><a href="#1-3-ansible-manifests-__codelineno-3-19">19</a></span>
<span class="normal"><a href="#1-3-ansible-manifests-__codelineno-3-20">20</a></span>
<span class="normal"><a href="#1-3-ansible-manifests-__codelineno-3-21">21</a></span>
<span class="normal"><a href="#1-3-ansible-manifests-__codelineno-3-22">22</a></span>
<span class="normal"><a href="#1-3-ansible-manifests-__codelineno-3-23">23</a></span>
<span class="normal"><a href="#1-3-ansible-manifests-__codelineno-3-24">24</a></span>
<span class="normal"><a href="#1-3-ansible-manifests-__codelineno-3-25">25</a></span>
<span class="normal"><a href="#1-3-ansible-manifests-__codelineno-3-26">26</a></span>
<span class="normal"><a href="#1-3-ansible-manifests-__codelineno-3-27">27</a></span>
<span class="normal"><a href="#1-3-ansible-manifests-__codelineno-3-28">28</a></span>
<span class="normal"><a href="#1-3-ansible-manifests-__codelineno-3-29">29</a></span>
<span class="normal"><a href="#1-3-ansible-manifests-__codelineno-3-30">30</a></span>
<span class="normal"><a href="#1-3-ansible-manifests-__codelineno-3-31">31</a></span>
<span class="normal"><a href="#1-3-ansible-manifests-__codelineno-3-32">32</a></span>
<span class="normal"><a href="#1-3-ansible-manifests-__codelineno-3-33">33</a></span>
<span class="normal"><a href="#1-3-ansible-manifests-__codelineno-3-34">34</a></span>
<span class="normal"><a href="#1-3-ansible-manifests-__codelineno-3-35">35</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-10" name="__codelineno-3-10"></a>---
<a id="__codelineno-3-11" name="__codelineno-3-11"></a>- name: &quot;Deploy {{ item.src }} to k3s crd processor&quot;
<a id="__codelineno-3-12" name="__codelineno-3-12"></a>  ansible.builtin.template:
<a id="__codelineno-3-13" name="__codelineno-3-13"></a>    src: &quot;{{ item.src }}.j2&quot;
<a id="__codelineno-3-14" name="__codelineno-3-14"></a>    dest: &quot;/var/lib/rancher/k3s/server/manifests/{{ item.src }}&quot;
<a id="__codelineno-3-15" name="__codelineno-3-15"></a>    owner: &quot;{{ kubeapps_user }}&quot;
<a id="__codelineno-3-16" name="__codelineno-3-16"></a>    group: &quot;{{ kubeapps_user }}&quot;
<a id="__codelineno-3-17" name="__codelineno-3-17"></a>    mode: &#39;0644&#39;
<a id="__codelineno-3-18" name="__codelineno-3-18"></a>
<a id="__codelineno-3-19" name="__codelineno-3-19"></a>- name: &quot;Wait {{ item.src }} deployment complete&quot;
<a id="__codelineno-3-20" name="__codelineno-3-20"></a>  kubernetes.core.k8s_info:
<a id="__codelineno-3-21" name="__codelineno-3-21"></a>    api_version: v1
<a id="__codelineno-3-22" name="__codelineno-3-22"></a>    kind: Deployment
<a id="__codelineno-3-23" name="__codelineno-3-23"></a>    name: &quot;{{ item.deploy }}&quot;
<a id="__codelineno-3-24" name="__codelineno-3-24"></a>    kubeconfig: /etc/rancher/k3s/k3s.yaml
<a id="__codelineno-3-25" name="__codelineno-3-25"></a>    wait: yes
<a id="__codelineno-3-26" name="__codelineno-3-26"></a>    wait_sleep: 5
<a id="__codelineno-3-27" name="__codelineno-3-27"></a>    wait_timeout: 600
<a id="__codelineno-3-28" name="__codelineno-3-28"></a>    wait_condition:
<a id="__codelineno-3-29" name="__codelineno-3-29"></a>      type: Progressing
<a id="__codelineno-3-30" name="__codelineno-3-30"></a>      status: &quot;True&quot;
<a id="__codelineno-3-31" name="__codelineno-3-31"></a>      reason: &quot;NewReplicaSetAvailable&quot;
<a id="__codelineno-3-32" name="__codelineno-3-32"></a>    # Many times deployment name is the same that namespace
<a id="__codelineno-3-33" name="__codelineno-3-33"></a>    namespace: &quot;{{ item.ns | d(item.deploy) }}&quot;
<a id="__codelineno-3-34" name="__codelineno-3-34"></a>  when: item.deploy | default(false) or item.ns | default(false)
<a id="__codelineno-3-35" name="__codelineno-3-35"></a>  register: deployment_infos
</code></pre></div></td></tr></table></div>
<p>Pour expliquer l'utilisation du module ansible <a href="https://docs.ansible.com/ansible/latest/collections/kubernetes/core/k8s_info_module.html">kubernetes.core.k8s_info</a>. On attend que le retour de la commande <code>kubectl</code> reformatés en json atteigne des conditions.
Ces conditions sont ici testées toutes les 5 secondes (<code>wait_sleep</code>) et vont rendre une erreur si elles ne sont toujours pas bonnes au bout de <code>350s</code>.</p>
<p>Voici ensuite ce qui est rendus entièrement par le <code>deployment_infos</code> dans la directive <code>register</code> qui permet à ansible de stocker ce <strong>fact / variable</strong>.</p>
<p>Voici un exemple de retour pour un déploiement fonctionnel pour mieux comprendre.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#1-3-ansible-manifests-__codelineno-4-1"></a><span class="w">  </span><span class="s">&quot;conditions&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">[</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#1-3-ansible-manifests-__codelineno-4-2"></a><span class="w">      </span><span class="p p-Indicator">{</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#1-3-ansible-manifests-__codelineno-4-3"></a><span class="w">          </span><span class="s">&quot;lastTransitionTime&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;2022-12-05T15:11:56Z&quot;</span><span class="p p-Indicator">,</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#1-3-ansible-manifests-__codelineno-4-4"></a><span class="w">          </span><span class="s">&quot;lastUpdateTime&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;2022-12-05T15:11:56Z&quot;</span><span class="p p-Indicator">,</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#1-3-ansible-manifests-__codelineno-4-5"></a><span class="w">          </span><span class="s">&quot;message&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;Deployment</span><span class="nv"> </span><span class="s">has</span><span class="nv"> </span><span class="s">minimum</span><span class="nv"> </span><span class="s">availability.&quot;</span><span class="p p-Indicator">,</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#1-3-ansible-manifests-__codelineno-4-6"></a><span class="w">          </span><span class="s">&quot;reason&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;MinimumReplicasAvailable&quot;</span><span class="p p-Indicator">,</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#1-3-ansible-manifests-__codelineno-4-7"></a><span class="w">          </span><span class="s">&quot;status&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;True&quot;</span><span class="p p-Indicator">,</span>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#1-3-ansible-manifests-__codelineno-4-8"></a><span class="w">          </span><span class="s">&quot;type&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;Available&quot;</span>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#1-3-ansible-manifests-__codelineno-4-9"></a><span class="w">      </span><span class="p p-Indicator">},</span>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#1-3-ansible-manifests-__codelineno-4-10"></a><span class="w">      </span><span class="p p-Indicator">{</span>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#1-3-ansible-manifests-__codelineno-4-11"></a><span class="w">          </span><span class="s">&quot;lastTransitionTime&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;2022-12-05T15:11:46Z&quot;</span><span class="p p-Indicator">,</span>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#1-3-ansible-manifests-__codelineno-4-12"></a><span class="w">          </span><span class="s">&quot;lastUpdateTime&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;2022-12-05T15:11:56Z&quot;</span><span class="p p-Indicator">,</span>
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#1-3-ansible-manifests-__codelineno-4-13"></a><span class="w">          </span><span class="s">&quot;message&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;ReplicaSet</span><span class="nv"> </span><span class="s">\&quot;dex-5bd6ffdfd\&quot;</span><span class="nv"> </span><span class="s">has</span><span class="nv"> </span><span class="s">successfully</span><span class="nv"> </span><span class="s">progressed.&quot;</span><span class="p p-Indicator">,</span>
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#1-3-ansible-manifests-__codelineno-4-14"></a><span class="w">          </span><span class="s">&quot;reason&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;NewReplicaSetAvailable&quot;</span><span class="p p-Indicator">,</span>
<a id="__codelineno-4-15" name="__codelineno-4-15" href="#1-3-ansible-manifests-__codelineno-4-15"></a><span class="w">          </span><span class="s">&quot;status&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;True&quot;</span><span class="p p-Indicator">,</span>
<a id="__codelineno-4-16" name="__codelineno-4-16" href="#1-3-ansible-manifests-__codelineno-4-16"></a><span class="w">          </span><span class="s">&quot;type&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;Progressing&quot;</span>
<a id="__codelineno-4-17" name="__codelineno-4-17" href="#1-3-ansible-manifests-__codelineno-4-17"></a><span class="w">      </span><span class="p p-Indicator">}</span>
<a id="__codelineno-4-18" name="__codelineno-4-18" href="#1-3-ansible-manifests-__codelineno-4-18"></a><span class="w">  </span><span class="p p-Indicator">]</span><span class="err">,</span>
</code></pre></div>
<p>On remarque que le <code>status</code> à "True" signigie que nous avons réussi, que la <code>reason</code> indique qu'un replica à été créé. Un replica est une instance de pod dans un contexte où l'on peut dupliquer les pod pour répartir la charge.</p>
<blockquote>
<p><strong>Note</strong> la commande k8s_info donne tous les états par lesquels sont passé le pod. On voit ici le passage de <code>Available</code> à <code>Progressing</code> qui signifie que le déploiement est fonctionnel. (le wording est un peu étrange, mais c'est comme ça).</p>
</blockquote>
<p>Revenons à la déclaration de la boucle des manifests pour ajouter le la liste <code>loop</code> que l'on laisse avec des <code>null</code> en propriétés pour l'instant.
De plus le <code>when</code> permettra de ne pas exécuter certains manifests en fonction des conditions que l'on aura définies avec <code>condition</code>.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/roles/kubeapps/tasks/manifests.yml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#1-3-ansible-manifests-__codelineno-5-10">10</a></span>
<span class="normal"><a href="#1-3-ansible-manifests-__codelineno-5-11">11</a></span>
<span class="normal"><a href="#1-3-ansible-manifests-__codelineno-5-12">12</a></span>
<span class="normal"><a href="#1-3-ansible-manifests-__codelineno-5-13">13</a></span>
<span class="normal"><a href="#1-3-ansible-manifests-__codelineno-5-14">14</a></span>
<span class="normal"><a href="#1-3-ansible-manifests-__codelineno-5-15">15</a></span>
<span class="normal"><a href="#1-3-ansible-manifests-__codelineno-5-16">16</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-10" name="__codelineno-5-10"></a><span class="nn">---</span>
<a id="__codelineno-5-11" name="__codelineno-5-11"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">import_tasks</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">manifests.yml</span>
<a id="__codelineno-5-12" name="__codelineno-5-12"></a><span class="w">  </span><span class="nt">tags</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">kubeapps</span><span class="p p-Indicator">]</span>
<a id="__codelineno-5-13" name="__codelineno-5-13"></a><span class="w">  </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">item.condition | default(true)</span>
<a id="__codelineno-5-14" name="__codelineno-5-14"></a><span class="w">  </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt"> apply</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt"> tags</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">kubeapps</span><span class="p p-Indicator">]</span><span class="w"> </span><span class="p p-Indicator">}</span><span class="w"> </span><span class="p p-Indicator">}</span>
<a id="__codelineno-5-15" name="__codelineno-5-15"></a><span class="w">  </span><span class="nt">loop</span><span class="p">:</span>
<a id="__codelineno-5-16" name="__codelineno-5-16"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt"> src</span><span class="p">:</span><span class="w"> </span><span class="nv">~</span><span class="p p-Indicator">,</span><span class="nt"> ns</span><span class="p">:</span><span class="w"> </span><span class="nv">~</span><span class="p p-Indicator">,</span><span class="nt"> condition</span><span class="p">:</span><span class="w"> </span><span class="nv">True</span><span class="p p-Indicator">,</span><span class="nt"> deploy</span><span class="p">:</span><span class="w"> </span><span class="nv">~</span><span class="w"> </span><span class="p p-Indicator">}</span>
</code></pre></div></td></tr></table></div>
<hr /></section><section class="print-page" id="1-4-ansible-pebble"><h1 id="1-4-ansible-pebble-14-autorite-de-certification">1.4 Autorité de certification<a class="headerlink" href="#1-4-ansible-pebble-14-autorite-de-certification" title="Permanent link">&para;</a></h1>
<hr />
<p>Premièrement va falloir que les services soient accessibles depuis l'extérieur du cluster sur notre réseau local.</p>
<p>Ensuite que notre plateforme va adopter un principe zero-trust pour notre réseau. On va donc s'assurer que toutes les communication entre services sont cryptées avec TLS (https). Pour cela on va faire appel à un ensemble d'outils de gestion des certificats dans un cluster kubernetes.</p>
<h4 id="1-4-ansible-pebble-pebble">Pebble<a class="headerlink" href="#1-4-ansible-pebble-pebble" title="Permanent link">&para;</a></h4>
<p>On va recourir à une autorité de certification locale avec l'outil <a href="https://github.com/letsencrypt/pebble">pebble</a>. Il s'agit d'une implémentation de l'acme server de lets encrypt dédiée au test.</p>
<p>Pour rappel Lets-encrypt Acme est un protocole embarquant une autorité de certification générant des certificats pour tls simplement au travers de plusieurs type de "challenges". On peut obtenir des certificats juste en ayant un serveur http disponible sur le réseau (ou internet) ou en ayant accès à l'édition des zones d'un serveur dns (en fonction du fournisseur).</p>
<p>Il est cependant recommandé d'utiliser un serveur acme de test pour éviter de saturer les quotas de Let's-encrypt. Ici nous sommes en local et nos services ne sont pas accessibles depuis internet.</p>
<h4 id="1-4-ansible-pebble-creation-de-notre-autorite-avec-docker-et-le-playbook-prepare-de-molecule">Création de notre autorité avec docker et le playbook prepare de molecule<a class="headerlink" href="#1-4-ansible-pebble-creation-de-notre-autorite-avec-docker-et-le-playbook-prepare-de-molecule" title="Permanent link">&para;</a></h4>
<p>Ce playbook se lance avant le converge soit avant l'exécution de notre rôle et lance un container docker sur notre machine. Comme précisé avant, le <code>network_mode</code> à host nous permet d'hérité du localhost de votre machine et permet d'accéder aux services sur l'autre container sur lequel on installe notre rôle.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/roles/kubeapps/molecule/default/prepare.yml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#1-4-ansible-pebble-__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#1-4-ansible-pebble-__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#1-4-ansible-pebble-__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#1-4-ansible-pebble-__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#1-4-ansible-pebble-__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#1-4-ansible-pebble-__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#1-4-ansible-pebble-__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#1-4-ansible-pebble-__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#1-4-ansible-pebble-__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#1-4-ansible-pebble-__codelineno-0-10">10</a></span>
<span class="normal"><a href="#1-4-ansible-pebble-__codelineno-0-11">11</a></span>
<span class="normal"><a href="#1-4-ansible-pebble-__codelineno-0-12">12</a></span>
<span class="normal"><a href="#1-4-ansible-pebble-__codelineno-0-13">13</a></span>
<span class="normal"><a href="#1-4-ansible-pebble-__codelineno-0-14">14</a></span>
<span class="normal"><a href="#1-4-ansible-pebble-__codelineno-0-15">15</a></span>
<span class="normal"><a href="#1-4-ansible-pebble-__codelineno-0-16">16</a></span>
<span class="normal"><a href="#1-4-ansible-pebble-__codelineno-0-17">17</a></span>
<span class="normal"><a href="#1-4-ansible-pebble-__codelineno-0-18">18</a></span>
<span class="normal"><a href="#1-4-ansible-pebble-__codelineno-0-19">19</a></span>
<span class="normal"><a href="#1-4-ansible-pebble-__codelineno-0-20">20</a></span>
<span class="normal"><a href="#1-4-ansible-pebble-__codelineno-0-21">21</a></span>
<span class="normal"><a href="#1-4-ansible-pebble-__codelineno-0-22">22</a></span>
<span class="normal"><a href="#1-4-ansible-pebble-__codelineno-0-23">23</a></span>
<span class="normal"><a href="#1-4-ansible-pebble-__codelineno-0-24">24</a></span>
<span class="normal"><a href="#1-4-ansible-pebble-__codelineno-0-25">25</a></span>
<span class="normal"><a href="#1-4-ansible-pebble-__codelineno-0-26">26</a></span>
<span class="normal"><a href="#1-4-ansible-pebble-__codelineno-0-27">27</a></span>
<span class="normal"><a href="#1-4-ansible-pebble-__codelineno-0-28">28</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prepare</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">localhost</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">  </span><span class="nt">connection</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">  </span><span class="nt">gather_facts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">  </span><span class="nt">no_log</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">molecule_no_log</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">  </span><span class="nt">collections</span><span class="p">:</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">community.docker</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Start pebble container</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="w">      </span><span class="nt">community.docker.docker_container</span><span class="p">:</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pebble</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;letsencrypt/pebble:latest&quot;</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="w">        </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pebble -config /pebble/pebble-config.json</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">started</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="w">        </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">True</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="w">        </span><span class="nt">network_mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">host</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="w">        </span><span class="nt">volumes</span><span class="p">:</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">playbook_dir</span><span class="nv"> </span><span class="s">}}/pebble:/pebble:ro&quot;</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="w">      </span><span class="nt">register</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">result</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="w">      </span><span class="nt">until</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">result is not failed</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="w">      </span><span class="nt">retries</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="w">      </span><span class="nt">delay</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Wait for pebble to start</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="w">      </span><span class="nt">ansible.builtin.wait_for</span><span class="p">:</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="w">        </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">localhost</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">15000</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="w">        </span><span class="nt">delay</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
</code></pre></div></td></tr></table></div>
<blockquote>
<p><code>playbook_dir</code> référence le dossier ou notre playbook molecule est lancé : <code>playbook/roles/kubeapps/molecule/default/</code></p>
</blockquote>
<p>Ensuite nous avons besoin de deux certificats racines pour initialiser notre autorité de certification. On les récupère sur le <a href="https://github.com/letsencrypt/pebble/">projet github de pebble</a> directement avec cette commande.</p>
<blockquote>
<p><strong>Warning</strong> Attention n'utiliser surtout pas pebble et ces certificats en production</p>
</blockquote>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#1-4-ansible-pebble-__codelineno-1-1"></a>mkdir<span class="w"> </span>-p<span class="w"> </span>playbook/roles/kubeapps/molecule/default/pebble
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#1-4-ansible-pebble-__codelineno-1-2"></a>curl<span class="w"> </span>-L<span class="w"> </span>https://raw.githubusercontent.com/letsencrypt/pebble/main/test/certs/localhost/cert.pem<span class="w"> </span>&gt;<span class="w"> </span>playbook/roles/kubeapps/molecule/default/pebble/cert.pem
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#1-4-ansible-pebble-__codelineno-1-3"></a>curl<span class="w"> </span>-L<span class="w"> </span>https://raw.githubusercontent.com/letsencrypt/pebble/main/test/certs/localhost/key.pem<span class="w"> </span>&gt;<span class="w"> </span>playbook/roles/kubeapps/molecule/default/pebble/key.pem
</code></pre></div>
<p>Puis on crée le fichier de configuration de notre serveur Acme :</p>
<p><a href="../playbook/roles/kubeapps/molecule/default/pebble/pebble-config.json">playbook/roles/kubeapps/molecule/default/pebble/pebble-config.json</a></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#1-4-ansible-pebble-__codelineno-2-1"></a><span class="p">{</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#1-4-ansible-pebble-__codelineno-2-2"></a><span class="w">    </span><span class="nt">&quot;pebble&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#1-4-ansible-pebble-__codelineno-2-3"></a><span class="w">      </span><span class="nt">&quot;listenAddress&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;0.0.0.0:14000&quot;</span><span class="p">,</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#1-4-ansible-pebble-__codelineno-2-4"></a><span class="w">      </span><span class="nt">&quot;managementListenAddress&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;0.0.0.0:15000&quot;</span><span class="p">,</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#1-4-ansible-pebble-__codelineno-2-5"></a><span class="w">      </span><span class="nt">&quot;certificate&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/pebble/cert.pem&quot;</span><span class="p">,</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#1-4-ansible-pebble-__codelineno-2-6"></a><span class="w">      </span><span class="nt">&quot;privateKey&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/pebble/key.pem&quot;</span><span class="p">,</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#1-4-ansible-pebble-__codelineno-2-7"></a><span class="w">      </span><span class="nt">&quot;httpPort&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">80</span><span class="p">,</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#1-4-ansible-pebble-__codelineno-2-8"></a><span class="w">      </span><span class="nt">&quot;tlsPort&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">443</span><span class="p">,</span>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#1-4-ansible-pebble-__codelineno-2-9"></a><span class="w">      </span><span class="nt">&quot;ocspResponderURL&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#1-4-ansible-pebble-__codelineno-2-10"></a><span class="w">      </span><span class="nt">&quot;externalAccountBindingRequired&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#1-4-ansible-pebble-__codelineno-2-11"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#1-4-ansible-pebble-__codelineno-2-12"></a><span class="w">  </span><span class="p">}</span>
</code></pre></div>
<p>Maintenant lorsque l'on lance <code>molecule test</code> nous exécutons dans l'ordre :</p>
<ul>
<li>Le playbook <strong>create.yml</strong> qui lance les plateformes définies dans molecule.yml (le ubuntu2004 pour tester notre rôle)</li>
<li>Le playbook <strong>prepare.yml</strong> que l'on a entièrement créer pour lancer un pebble de test</li>
<li>Le playbook <strong>verify.yml</strong> pour vérifier que l'on a bien lancer notre outils</li>
<li>Le playbook <strong>destroy.yml</strong> qui supprime les containers de platforms</li>
<li>Enfin le playboonk <strong>cleanup.yml</strong> que l'on créer en entier pour supprimer l'instance de pebble définie dans le prepare.</li>
</ul>
<p>Voici le playbook <strong>cleanup.yml</strong> manquant :</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/roles/kubeapps/molecule/default/cleanup.yml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#1-4-ansible-pebble-__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#1-4-ansible-pebble-__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#1-4-ansible-pebble-__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#1-4-ansible-pebble-__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#1-4-ansible-pebble-__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#1-4-ansible-pebble-__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#1-4-ansible-pebble-__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#1-4-ansible-pebble-__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#1-4-ansible-pebble-__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#1-4-ansible-pebble-__codelineno-3-10">10</a></span>
<span class="normal"><a href="#1-4-ansible-pebble-__codelineno-3-11">11</a></span>
<span class="normal"><a href="#1-4-ansible-pebble-__codelineno-3-12">12</a></span>
<span class="normal"><a href="#1-4-ansible-pebble-__codelineno-3-13">13</a></span>
<span class="normal"><a href="#1-4-ansible-pebble-__codelineno-3-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="nn">---</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Cleanup</span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">localhost</span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="w">  </span><span class="nt">connection</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local</span>
<a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="w">  </span><span class="nt">gather_facts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<a id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="w">  </span><span class="nt">no_log</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">molecule_no_log</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="w">  </span><span class="nt">collections</span><span class="p">:</span>
<a id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">community.docker</span>
<a id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>
<a id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Destroy pebble instance(s)</span>
<a id="__codelineno-3-11" name="__codelineno-3-11"></a><span class="w">      </span><span class="nt">docker_container</span><span class="p">:</span>
<a id="__codelineno-3-12" name="__codelineno-3-12"></a><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pebble</span>
<a id="__codelineno-3-13" name="__codelineno-3-13"></a><span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">absent</span>
<a id="__codelineno-3-14" name="__codelineno-3-14"></a><span class="w">      </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">lookup(&#39;env&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;MOLECULE_CLEANUP&#39;</span><span class="nv">) | boolean | d(false)</span><span class="w"> </span><span class="p p-Indicator">}}</span>
</code></pre></div></td></tr></table></div>
<blockquote>
<p>On a choisi de laisser par défaut le container pebble lancé pour pouvoir le relancer avec <code>molecule converge</code> et ne pas avoir à le relancer à chaque fois. Cependant, dans un environnement de CI/CD on peut vouloir supprimer le container après chaque test.</p>
</blockquote>
<hr /></section><section class="print-page" id="1-5-ansible-dns"><h1 id="1-5-ansible-dns-15-mise-en-place-des-communications-reseau-du-cluster">1.5 Mise en place des communications réseau du cluster<a class="headerlink" href="#1-5-ansible-dns-15-mise-en-place-des-communications-reseau-du-cluster" title="Permanent link">&para;</a></h1>
<hr />
<p>Pour détailler sur cette partie essentielle à la bonne compréhension des applications distribuées sur kubernetes on parlera du <strong>dns</strong>.</p>
<p>Dans notre stack on a besoin de deux serveurs de nom, soit un interne <strong>coredns</strong> disponible uniquement dans kubernetes et ses ressources et un serveur de nom global (qui peut être celui d'internet et le réseau local).</p>
<h3 id="1-5-ansible-dns-dnsmasq-pour-resoudre-les-noms-de-domaines-en-local">Dnsmasq pour résoudre les noms de domaines en local<a class="headerlink" href="#1-5-ansible-dns-dnsmasq-pour-resoudre-les-noms-de-domaines-en-local" title="Permanent link">&para;</a></h3>
<p>L'objectif va être de pouvoir utiliser des domaines de test en local. Par exemple on veut utiliser <code>dex.k3s.local</code> pour accéder à l'authentification de notre cluster kubernetes.</p>
<p>L'installation sur <strong>mac</strong> est un peu différente de celle de Linux là voici pour commencer :</p>
<ul>
<li>
<p><code>brew install dnsmasq</code> (si vous n'avez pas encore Homebrew c'est <a href="https://brew.sh/index_fr">ici pour l'installer</a>)</p>
</li>
<li>
<p>Créer le répertoire des configurations <code>mkdir -pv $(brew --prefix)/etc/</code></p>
</li>
<li>
<p>Préparer une variable pointant vers la config dnsmasq :</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#1-5-ansible-dns-__codelineno-0-1"></a><span class="nb">export</span><span class="w"> </span><span class="nv">DNSMASQ_CNF_DIR</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>brew<span class="w"> </span>--prefix<span class="k">)</span><span class="s2">/etc/dnsmasq.conf&quot;</span>
</code></pre></div>
<p>Pour <strong>Linux</strong> :</p>
<ul>
<li>
<p>Commencer par désactiver le résolveur par défaut qui écoute sur le port <code>53</code>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#1-5-ansible-dns-__codelineno-1-1"></a>sudo<span class="w"> </span>systemctl<span class="w"> </span>disable<span class="w"> </span>systemd-resolved
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#1-5-ansible-dns-__codelineno-1-2"></a>sudo<span class="w"> </span>systemctl<span class="w"> </span>stop<span class="w"> </span>systemd-resolved
</code></pre></div></p>
</li>
<li>
<p>Supprimer la configuration du résolveur par défaut</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#1-5-ansible-dns-__codelineno-2-1"></a>ls<span class="w"> </span>-lh<span class="w"> </span>/etc/resolv.conf
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#1-5-ansible-dns-__codelineno-2-2"></a>sudo<span class="w"> </span>rm<span class="w"> </span>/etc/resolv.conf
</code></pre></div>
<ul>
<li>
<p>Installer le package : <code>sudo apt install -y dnsmasq</code></p>
</li>
<li>
<p>Préparer une variable pointant vers la config dnsmasq pour l'étape suivante :</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#1-5-ansible-dns-__codelineno-3-1"></a><span class="nb">export</span><span class="w"> </span><span class="nv">DNSMASQ_CNF_DIR</span><span class="o">=</span><span class="s2">&quot;/etc/dnsmasq.conf&quot;</span>
</code></pre></div>
<p>Pour <strong>Linux</strong> et <strong>Mac</strong> mettons ainsi tout en place :</p>
<ul>
<li>On précise bien que l'on veut résoudre toute les requètes vers le domaine <code>.dev</code> avec l'adresse IP 127.0.0.1 : </li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#1-5-ansible-dns-__codelineno-4-1"></a><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;port=53&#39;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="nv">$DNSMASQ_CNF_DIR</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#1-5-ansible-dns-__codelineno-4-2"></a><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;address=/.k3s.local/127.0.0.1&#39;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="nv">$DNSMASQ_CNF_DIR</span>
</code></pre></div>
<ul>
<li>On ajoute un resolveur avec :</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#1-5-ansible-dns-__codelineno-5-1"></a>sudo<span class="w"> </span>mkdir<span class="w"> </span>-v<span class="w"> </span>/etc/resolver
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#1-5-ansible-dns-__codelineno-5-2"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;nameserver 127.0.0.1&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span>/etc/resolver/k3s.local
</code></pre></div>
<p>Redémarrer dnsmasq :</p>
<ul>
<li>Linux : <code>sudo systemctl restart dnsmasq</code></li>
<li>Mac : <code>sudo brew services restart dnsmasq</code></li>
</ul>
<p>Vérifier que tout fonctionne avec <code>scutil --dns</code> qui devrait donner :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#1-5-ansible-dns-__codelineno-6-1"></a>resolver ...
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#1-5-ansible-dns-__codelineno-6-2"></a>  domain   : k3s.local
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#1-5-ansible-dns-__codelineno-6-3"></a>  nameserver[0] : 127.0.0.1
</code></pre></div>
<h3 id="1-5-ansible-dns-edition-de-coredns-pour-utiliser-les-url-externes">Edition de coredns pour utiliser les url externes<a class="headerlink" href="#1-5-ansible-dns-edition-de-coredns-pour-utiliser-les-url-externes" title="Permanent link">&para;</a></h3>
<p>Par défaut notre réseau est privée dans kubernetes, on ne peut accéder qu'aux serveurs de nom les plus répandus comme google (8.8.8.8) ou cloudflare (1.1.1.1) et celui de <code>coredns</code>. Cela veut dire que l'on accède seulement à internet et à nos pods mais nous avons ici besoin d'accéder à pebble situé sur le réseau local.</p>
<blockquote>
<p><strong>Note</strong> : <strong>Coredns</strong> est l'outil qui fait office d'un des services coeurs de kubernetes au même titre que kube-controller-manager par exemple. Ici il va donc s'agir du composant kube-dns.</p>
</blockquote>
<p>On va donc se préparer à surcharger la configuration par défaut de coredns en appliquant un simple manifest de type <code>ConfigMap</code>. Ce type permet de simplement définir des variables ou le contenu d'un fichier. Ici on va décrire le contenu d'un fichier <code>Corefile</code> qui va être monté au travers d'un volume au container coredns.</p>
<p>Voici la configuration par défaut :</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/roles/kubeapps/templates/core-dns-config-crd.yml.j2</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#1-5-ansible-dns-__codelineno-7-1"> 1</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-7-2"> 2</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-7-3"> 3</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-7-4"> 4</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-7-5"> 5</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-7-6"> 6</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-7-7"> 7</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-7-8"> 8</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-7-9"> 9</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-7-10">10</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-7-11">11</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-7-12">12</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-7-13">13</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-7-14">14</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-7-15">15</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-7-16">16</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-7-17">17</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-7-18">18</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-7-19">19</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-7-20">20</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-7-21">21</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-7-22">22</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-7-23">23</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-7-24">24</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-7-25">25</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
<a id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">coredns</span>
<a id="__codelineno-7-5" name="__codelineno-7-5"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-system</span>
<a id="__codelineno-7-6" name="__codelineno-7-6"></a><span class="nt">data</span><span class="p">:</span>
<a id="__codelineno-7-7" name="__codelineno-7-7"></a><span class="w">  </span><span class="nt">Corefile</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<a id="__codelineno-7-8" name="__codelineno-7-8"></a><span class="w">    </span><span class="no">.:53 {</span>
<a id="__codelineno-7-9" name="__codelineno-7-9"></a><span class="w">        </span><span class="no">errors</span>
<a id="__codelineno-7-10" name="__codelineno-7-10"></a><span class="w">        </span><span class="no">health {</span>
<a id="__codelineno-7-11" name="__codelineno-7-11"></a><span class="w">          </span><span class="no">lameduck 5s</span>
<a id="__codelineno-7-12" name="__codelineno-7-12"></a><span class="w">        </span><span class="no">}</span>
<a id="__codelineno-7-13" name="__codelineno-7-13"></a><span class="w">        </span><span class="no">ready</span>
<a id="__codelineno-7-14" name="__codelineno-7-14"></a><span class="w">        </span><span class="no">kubernetes cluster.local in-addr.arpa ip6.arpa {</span>
<a id="__codelineno-7-15" name="__codelineno-7-15"></a><span class="w">          </span><span class="no">pods insecure</span>
<a id="__codelineno-7-16" name="__codelineno-7-16"></a><span class="w">          </span><span class="no">fallthrough in-addr.arpa ip6.arpa</span>
<a id="__codelineno-7-17" name="__codelineno-7-17"></a><span class="w">          </span><span class="no">ttl 30</span>
<a id="__codelineno-7-18" name="__codelineno-7-18"></a><span class="w">        </span><span class="no">}</span>
<a id="__codelineno-7-19" name="__codelineno-7-19"></a><span class="w">        </span><span class="no">prometheus :9153</span>
<a id="__codelineno-7-20" name="__codelineno-7-20"></a><span class="w">        </span><span class="no">forward . 1.1.1.1</span>
<a id="__codelineno-7-21" name="__codelineno-7-21"></a><span class="w">        </span><span class="no">cache 30</span>
<a id="__codelineno-7-22" name="__codelineno-7-22"></a><span class="w">        </span><span class="no">loop</span>
<a id="__codelineno-7-23" name="__codelineno-7-23"></a><span class="w">        </span><span class="no">reload</span>
<a id="__codelineno-7-24" name="__codelineno-7-24"></a><span class="w">        </span><span class="no">loadbalance</span>
<a id="__codelineno-7-25" name="__codelineno-7-25"></a><span class="w">    </span><span class="no">}</span>
</code></pre></div></td></tr></table></div>
<p>Le ingress <strong>en local</strong> n'est pas accessible depuis nos pods, nous allons donc avoir besoin de son ip pour l'associer aux différents noms de domaines que l'on va utiliser. (<code>dex.k3s.local</code> / <code>kubeapps.k3s.local</code>).</p>
<p>Nous allons ainsi créer une nouvelle suite de tâche pour déduire les adresses réseau requises pour coredns.</p>
<p>On crée un fichier <code>tasks/internal-acme.yml</code> présentant ce code pour récupérer l'addresse ip de l'ingress à l'aide du module <code>k8s_info</code> d'ansible :</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/roles/kubeapps/tasks/internal-acme.yml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#1-5-ansible-dns-__codelineno-8-1"> 1</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-8-2"> 2</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-8-3"> 3</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-8-4"> 4</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-8-5"> 5</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-8-6"> 6</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-8-7"> 7</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-8-8"> 8</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-8-9"> 9</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-8-10">10</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-8-11">11</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-8-12">12</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-8-13">13</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-8-14">14</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-8-15">15</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-8-16">16</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-8-17">17</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-8-18">18</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-8-19">19</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="nn">---</span>
<a id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Get Ingress service infos</span>
<a id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="w">  </span><span class="nt">kubernetes.core.k8s_info</span><span class="p">:</span>
<a id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="w">    </span><span class="nt">api_version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
<a id="__codelineno-8-6" name="__codelineno-8-6"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">traefik</span>
<a id="__codelineno-8-7" name="__codelineno-8-7"></a><span class="w">    </span><span class="nt">kubeconfig</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/rancher/k3s/k3s.yaml</span>
<a id="__codelineno-8-8" name="__codelineno-8-8"></a><span class="w">    </span><span class="nt">wait</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
<a id="__codelineno-8-9" name="__codelineno-8-9"></a><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-system</span>
<a id="__codelineno-8-10" name="__codelineno-8-10"></a><span class="w">  </span><span class="nt">register</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ingress_infos</span>
<a id="__codelineno-8-11" name="__codelineno-8-11"></a>
<a id="__codelineno-8-12" name="__codelineno-8-12"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">check ingress service infos available</span>
<a id="__codelineno-8-13" name="__codelineno-8-13"></a><span class="w">  </span><span class="nt">assert</span><span class="p">:</span>
<a id="__codelineno-8-14" name="__codelineno-8-14"></a><span class="w">    </span><span class="nt">that</span><span class="p">:</span>
<a id="__codelineno-8-15" name="__codelineno-8-15"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ingress_infos.resources | length &gt; 0</span>
<a id="__codelineno-8-16" name="__codelineno-8-16"></a>
<a id="__codelineno-8-17" name="__codelineno-8-17"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Set localhost ip to find local acme</span>
<a id="__codelineno-8-18" name="__codelineno-8-18"></a><span class="w">  </span><span class="nt">set_fact</span><span class="p">:</span>
<a id="__codelineno-8-19" name="__codelineno-8-19"></a><span class="w">    </span><span class="nt">kubeapps_ingress_controller_ip</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">ingress_infos.resources[0].spec.clusterIP</span><span class="nv"> </span><span class="s">}}&quot;</span>
</code></pre></div></td></tr></table></div>
<p>Puis on l'utilise dans nos tâches seulement quand on précise que l'on utilise un acme interne ou spécifique (par exemple on peut utiliser un acme staging externe) :</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/roles/kubeapps/tasks/main.yml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#1-5-ansible-dns-__codelineno-9-1">1</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-9-2">2</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-9-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">import_tasks</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">internal-acme.yml</span>
<a id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="w">  </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubeapps_internal_acme_network_ip is not none</span>
<a id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="w">  </span><span class="nt">tags</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">kubeapps</span><span class="p p-Indicator">]</span>
</code></pre></div></td></tr></table></div>
<p>Maintenant la variable <code>kubeapps_ingress_controller_ip</code> est disponible et prête à être associé à une entrée dns. Cette variable nous sert à détecter que nous sommes bien en local</p>
<p>Venons en donc à la définition des noms d'hôte des applications </p>
<blockquote>
<p>Ils seront déployés dans les étapes suivantes donc n'essayer pas d'y accéder pour l'instant.</p>
</blockquote>
<p>En sachant que le principe de base d'un dns est d'associé une adresse ip à un nom de domaine, nous allons simplement associés les deux addresses <code>k3s.local</code> hériteé de notre dns local (dnsmasq) vers le ingress. Ainsi le trafic interne comme externe en direction de ces adresses arrivera bien au même endroit.</p>
<blockquote>
<p><strong>WARN</strong> Nous faisons cela en réseau local, mais si notre serveur est en ligne nous ne serons pas obligé de le faire car on passera par des dns centraux (typiquement google, cloudflare...) capable de résoudre notre nom de domaines public et ses sous domaines.</p>
</blockquote>
<p>Avant de surcharger la configuration de coredns on va juste définir les variables avec les noms de domaines que l'on va utiliser.</p>
<blockquote>
<p><strong>Note</strong>: Il n'est pas obligé de faire cela tout de suite en sachant que le fichier sera redonné en entier dans une prochaine partie.</p>
</blockquote>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/roles/kubeapps/defaults/main.yml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#1-5-ansible-dns-__codelineno-10-1">1</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-10-2">2</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-10-3">3</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-10-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="nt">kubeapps_user</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">ansible_user</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">d(&#39;root&#39;)</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="nt">kubeapps_internal_acme_host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">acme-internal.k3s.local</span>
<a id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="nt">dex_hostname</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dex.k3s.local</span>
<a id="__codelineno-10-4" name="__codelineno-10-4"></a><span class="nt">kubeapps_hostname</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubeapps.k3s.local</span>
</code></pre></div></td></tr></table></div>
<blockquote>
<p><code>kubeapps_user</code> est définit à <code>ansible_user</code> une variable selon les conventions précisée dans un playbook de production dans le fichier host. Par défaut on le met à <code>root</code> si la variable n'existe pas.</p>
</blockquote>
<p><a href="../1-5-ansible-dns/playbook/roles/kubeapps/templates/core-dns-config-crd.yml.j2#L28">playbook/roles/kubeapps/templates/core-dns-config-crd.yml.j2</a></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/roles/kubeapps/templates/core-dns-config-crd.yml.j2</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#1-5-ansible-dns-__codelineno-11-28">28</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-11-29">29</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-11-30">30</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-11-31">31</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-11-32">32</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-11-33">33</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-11-34">34</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-11-35">35</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-11-36">36</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-11-28" name="__codelineno-11-28"></a>    {% set ingress_hosts_internals = [dex_hostname, kubeapps_hostname] | join(&quot; &quot;) -%}
<a id="__codelineno-11-29" name="__codelineno-11-29"></a>
<a id="__codelineno-11-30" name="__codelineno-11-30"></a>    {{ ingress_hosts_internals }} {
<a id="__codelineno-11-31" name="__codelineno-11-31"></a>      hosts {
<a id="__codelineno-11-32" name="__codelineno-11-32"></a>        {{ kubeapps_ingress_controller_ip }} {{ ingress_hosts_internals }}
<a id="__codelineno-11-33" name="__codelineno-11-33"></a>        fallthrough
<a id="__codelineno-11-34" name="__codelineno-11-34"></a>      }
<a id="__codelineno-11-35" name="__codelineno-11-35"></a>      whoami
<a id="__codelineno-11-36" name="__codelineno-11-36"></a>    }
</code></pre></div></td></tr></table></div>
<p>Enfin on configure l'addresse de notre acme interne pour que l'étape suivante puisse bien accèder à nos urls et que l'outil cert-manager puisse accèder à ce serveur acme.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/roles/kubeapps/templates/core-dns-config-crd.yml.j2</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#1-5-ansible-dns-__codelineno-12-32">32</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-12-33">33</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-12-34">34</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-12-35">35</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-12-36">36</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-12-37">37</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-12-38">38</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-12-32" name="__codelineno-12-32"></a>    {{ kubeapps_internal_acme_host }} {
<a id="__codelineno-12-33" name="__codelineno-12-33"></a>      hosts {
<a id="__codelineno-12-34" name="__codelineno-12-34"></a>        {{ kubeapps_internal_acme_network_ip }} {{ kubeapps_internal_acme_host }}
<a id="__codelineno-12-35" name="__codelineno-12-35"></a>        fallthrough
<a id="__codelineno-12-36" name="__codelineno-12-36"></a>      }
<a id="__codelineno-12-37" name="__codelineno-12-37"></a>      whoami
<a id="__codelineno-12-38" name="__codelineno-12-38"></a>    }
</code></pre></div></td></tr></table></div>
<p>Ainsi nous sommes prêt à faire fonctionner notre acme en local pour les tests. Cependant dans des environnement disponible sur internet nous n'allons pas activé cette partie. Nous réutilisons donc la variable <code>kubeapps_ingress_controller_ip</code> créer dynamiquement dans <code>internal-acme.yml</code> pour installer ou non le manifest kubernetes.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/roles/kubeapps/tasks/main.yml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#1-5-ansible-dns-__codelineno-13-15">15</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-13-16">16</a></span>
<span class="normal"><a href="#1-5-ansible-dns-__codelineno-13-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-13-15" name="__codelineno-13-15"></a><span class="w">  </span><span class="nt">loop</span><span class="p">:</span>
<a id="__codelineno-13-16" name="__codelineno-13-16"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">core-dns-config-crd.yml</span>
<a id="__codelineno-13-17" name="__codelineno-13-17"></a><span class="w">      </span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">kubeapps_ingress_controller_ip</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">defined</span><span class="nv"> </span><span class="s">}}&quot;</span>
</code></pre></div></td></tr></table></div>
<hr /></section><section class="print-page" id="1-6-ansible-cert-manager"><h1 id="1-6-ansible-cert-manager-16-utiliser-notre-autorite-avec-cert-manager">1.6 Utiliser notre autorité avec cert-manager<a class="headerlink" href="#1-6-ansible-cert-manager-16-utiliser-notre-autorite-avec-cert-manager" title="Permanent link">&para;</a></h1>
<hr />
<p>Venons en à l'élement central de notre stack, <code>cert-manager</code>. Il va nous permettre de créer des certificats pour nos services kubernetes.</p>
<p>Cert-manager permet d'utiliser les protocoles acme embarqué dans des outils comme Pebble. Il permet de créer des certificats pour des services http, dns et mTLS.
On l'utilisera avec Pebble pour distribuer les certificats vers les <strong>ingress</strong> avec des ressources secrets contenant respectivement le certificat et la clé de déchiffrage. </p>
<p>Pour résumer en schéma :</p>
<p><img alt="stack" src="../images/ingress-cert-manager.jpg" /></p>
<p>Tout d'abord on ajoute les variables et puis des constantes dans le fichier <code>vars.yml</code> que l'on utilise dans un souci de clarté :</p>
<p>Voici donc des constantes que l'on n'a probablement jamais avoir besoin de changer (toutefois on pourrait le faire si besoin avec un <code>set_fact</code>, mais ce n'est pas très propre)</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/roles/kubeapps/vars/main.yml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-0-10">10</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-0-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="c1"># vars file for role-kubeapps</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="nt">kubeapps_k8s_ingress_class</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">traefik</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="nt">letsencrypt_staging</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://acme-staging-v02.api.letsencrypt.org/directory</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="nt">letsencrypt_prod</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://acme-v02.api.letsencrypt.org/directory</span><span class="w"> </span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="nt">letsencrypt_envs</span><span class="p">:</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">  </span><span class="nt">staging</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">letsencrypt_staging</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">  </span><span class="nt">prod</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">letsencrypt_prod</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="nt">letsencrypt_envs_ca_certs</span><span class="p">:</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="w">  </span><span class="nt">staging</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://letsencrypt.org/certs/staging/letsencrypt-stg-root-x1.pem</span>
</code></pre></div></td></tr></table></div>
<blockquote>
<p><code>letsencrypt_staging</code> et <code>letsencrypt_prod</code> sont anticipé pour l'utilisation de cert-manager sur un cloud.</p>
<p><code>letsencrypt_envs_ca_certs</code> est l'url que l'on ajoutera dans les containers pour activer tls entre eux sur un environnement de test en ligne.</p>
</blockquote>
<p>Les défauts qui utilise les variables prédéfinie précédemment :</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/roles/kubeapps/defaults/main.yml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-1-10">10</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-1-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="nn">---</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="c1"># Kubeapps internal acme server</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="nt">kubeapps_internal_acme_network_ip</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">~</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="nt">kubeapps_internal_acme_host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">acme-internal.k3s.local</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="nt">cert_manager_letsencrypt_env</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">prod</span>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="nt">cert_manager_namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cert-manager</span>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="nt">cert_manager_acme_url</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">letsencrypt_envs[cert_manager_letsencrypt_env]</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="nt">cert_manager_staging_ca_cert_url</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">letsencrypt_envs_ca_certs[cert_manager_letsencrypt_env]</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">d(none)</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="nt">cert_manager_email</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="nt">cert_manager_private_key_secret</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test_secret</span>
</code></pre></div></td></tr></table></div>
<p>Que l'on surcharge tout de suite dans le playbook <strong>converge.yml</strong> :</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/roles/kubeapps/molecule/default/converge.yml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-2-10">10</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-2-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="w">    </span><span class="nt">cert_manager_acme_url</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://{{ kubeapps_internal_acme_host }}:14000/dir</span>
<a id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="w">    </span><span class="nt">cert_manager_staging_ca_cert_url</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://localhost:15000/roots/0</span>
</code></pre></div></td></tr></table></div>
<blockquote>
<p><code>cert_manager_acme_url</code> doit toujours utilisé l'entrée dns que l'on a choisie juste avant et qui est par défaut <code>acme.k3s.local</code>. un nom d'hôte que l'on a choisi pour l'usage local de cert-manager.</p>
<p><strong>WARN</strong> Attention en production ou recette l'adresse email <code>cert_manager_email</code> doit appartenir à un domaine valide (gmail, hotmail, etc...)</p>
</blockquote>
<p>Nous introduisons enfin la variable <code>cert_manager_is_internal</code> qui nous permet de savoir si nous utilisons un Acme spécial autre celui que le Lets-encrypt de production. Effectivement les acme locaux et staging ne sont pas référencés comme digne de confiance sur l'internet global.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/roles/kubeapps/defaults/main.yml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-3-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-14" name="__codelineno-3-14"></a><span class="nt">cert_manager_is_internal</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">(cert_manager_staging_ca_cert_url</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">d(&#39;&#39;))</span><span class="nv"> </span><span class="s">!=</span><span class="nv"> </span><span class="s">&#39;&#39;</span><span class="nv"> </span><span class="s">}}&quot;</span>
</code></pre></div></td></tr></table></div>
<blockquote>
<p>L'idée est que si un url fournissant un certificat est donné avec <code>cert_manager_staging_ca_cert_url</code> alors on considère que l'on est dans un environnement utilisant un Lets-encrypt de test ou recette.</p>
</blockquote>
<h4 id="1-6-ansible-cert-manager-mettons-en-place-une-bonne-pratique">Mettons en place une bonne pratique<a class="headerlink" href="#1-6-ansible-cert-manager-mettons-en-place-une-bonne-pratique" title="Permanent link">&para;</a></h4>
<p>L'objectif est d'éviter du comportement non souhaité lors de l'utilisation de cert-manager et donc de ne pas lancer l'installation de la suite des tâches s'il manque certaine configuration. Cert-manager est un composant cœur dans notre stack car il distribue les certificats pour certain service embarquant des protocoles d'authentification. Nous ne pourrons pas utiliser ces services s'il n'y a pas de certificats et de cryptage des échanges en TLS (v1.2+).</p>
<p>On crée donc un fichier <code>check.yml</code> dans le dossier <code>tasks/</code> de notre rôle pour vérifier les configurations.
Ici on veut être sûr que l'email est renseigné sinon lets-encrypt ne donnera pas de certificat. Enfin on veut dans le cas d'un Acme de recette / test qu'un fichier de certificat d'autorité (CA) soit présent dans le système.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/roles/kubeapps/tasks/checks.yml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-4-10">10</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-4-11">11</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-4-12">12</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-4-13">13</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-4-14">14</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-4-15">15</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-4-16">16</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">check email when cert-manager</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="w">  </span><span class="nt">assert</span><span class="p">:</span>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="w">    </span><span class="nt">that</span><span class="p">:</span>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cert_manager_email | default(false)</span>
<a id="__codelineno-4-5" name="__codelineno-4-5"></a>
<a id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Stat acme ca cert path</span>
<a id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="w">  </span><span class="nt">stat</span><span class="p">:</span>
<a id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">kubeapps_internal_acme_ca_file</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="w">  </span><span class="nt">register</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">acmeca_result</span>
<a id="__codelineno-4-10" name="__codelineno-4-10"></a><span class="w">  </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cert_manager_is_internal</span>
<a id="__codelineno-4-11" name="__codelineno-4-11"></a>
<a id="__codelineno-4-12" name="__codelineno-4-12"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Assert cert is present</span>
<a id="__codelineno-4-13" name="__codelineno-4-13"></a><span class="w">  </span><span class="nt">assert</span><span class="p">:</span>
<a id="__codelineno-4-14" name="__codelineno-4-14"></a><span class="w">    </span><span class="nt">that</span><span class="p">:</span>
<a id="__codelineno-4-15" name="__codelineno-4-15"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">acmeca_result.stat.exists</span>
<a id="__codelineno-4-16" name="__codelineno-4-16"></a><span class="w">  </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cert_manager_is_internal</span>
</code></pre></div></td></tr></table></div>
<blockquote>
<p>Les checks du fichier de certificat prendrons plus sens à la prochaine étape quand on mettra en place trust-manager dans le cluster.</p>
</blockquote>
<p>Puis on active ceci en premier dans le fichier wrapper <code>main.yml</code> :</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/roles/kubeapps/tasks/main.yml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-5-3">3</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-5-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">import_tasks</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">checks.yml</span>
<a id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="w">  </span><span class="nt">tags</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">kubeapps</span><span class="p p-Indicator">]</span>
</code></pre></div></td></tr></table></div>
<p>Et maintenant qu'on a un check sur l'email on l'ajoute dans le converge :</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/roles/kubeapps/molecule/default/converge.yml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-6-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-10" name="__codelineno-6-10"></a><span class="w">    </span><span class="nt">cert_manager_email</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;test@k3s.local&quot;</span>
</code></pre></div></td></tr></table></div>
<p><strong>Puis on installe cert-manager</strong> avec le module helm chart de k3s.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/roles/kubeapps/templates/cert-manager-chart-crd.yml.j2</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-7-1"> 1</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-7-2"> 2</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-7-3"> 3</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-7-4"> 4</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-7-5"> 5</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-7-6"> 6</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-7-7"> 7</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-7-8"> 8</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-7-9"> 9</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-7-10">10</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-7-11">11</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-7-12">12</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-7-13">13</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-7-14">14</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-7-15">15</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-7-16">16</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Namespace</span>
<a id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">cert_manager_namespace</span><span class="w"> </span><span class="p p-Indicator">}}</span>
<a id="__codelineno-7-5" name="__codelineno-7-5"></a><span class="nn">---</span>
<a id="__codelineno-7-6" name="__codelineno-7-6"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">helm.cattle.io/v1</span>
<a id="__codelineno-7-7" name="__codelineno-7-7"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HelmChart</span>
<a id="__codelineno-7-8" name="__codelineno-7-8"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-7-9" name="__codelineno-7-9"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cert-manager</span>
<a id="__codelineno-7-10" name="__codelineno-7-10"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-system</span>
<a id="__codelineno-7-11" name="__codelineno-7-11"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-7-12" name="__codelineno-7-12"></a><span class="w">  </span><span class="nt">chart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cert-manager</span>
<a id="__codelineno-7-13" name="__codelineno-7-13"></a><span class="w">  </span><span class="nt">targetNamespace</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">cert_manager_namespace</span><span class="w"> </span><span class="p p-Indicator">}}</span>
<a id="__codelineno-7-14" name="__codelineno-7-14"></a><span class="w">  </span><span class="nt">repo</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://charts.jetstack.io</span>
<a id="__codelineno-7-15" name="__codelineno-7-15"></a><span class="w">  </span><span class="nt">valuesContent</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|-</span>
<a id="__codelineno-7-16" name="__codelineno-7-16"></a><span class="w">    </span><span class="no">installCRDs: true</span>
</code></pre></div></td></tr></table></div>
<p><code>installCRDs: true</code> permet de rendre disponible des nouveaux types de manifests propre à l'outil, voici la commande pour vérifier qu'ils sont bien installés :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#1-6-ansible-cert-manager-__codelineno-8-1"></a>kubectl<span class="w"> </span>get<span class="w"> </span>crd
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#1-6-ansible-cert-manager-__codelineno-8-2"></a><span class="c1"># Give</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#1-6-ansible-cert-manager-__codelineno-8-3"></a>orders.acme.cert-manager.io<span class="w">            </span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#1-6-ansible-cert-manager-__codelineno-8-4"></a>certificates.cert-manager.io<span class="w">            </span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#1-6-ansible-cert-manager-__codelineno-8-5"></a>certificaterequests.cert-manager.io<span class="w">    </span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#1-6-ansible-cert-manager-__codelineno-8-6"></a>challenges.acme.cert-manager.io
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#1-6-ansible-cert-manager-__codelineno-8-7"></a>clusterissuers.cert-manager.io
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#1-6-ansible-cert-manager-__codelineno-8-8"></a>issuers.cert-manager.io
</code></pre></div>
<p>Ensuite créeons notre <strong>issuer</strong> qui va s'occuper de tout le cycle de vie d'un certificat demandé par un ingress au travers de l'annotation.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#1-6-ansible-cert-manager-__codelineno-9-1"></a><span class="w">      </span><span class="nt">annotations</span><span class="p">:</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#1-6-ansible-cert-manager-__codelineno-9-2"></a><span class="w">        </span><span class="nt">cert-manager.io/cluster-issuer</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">letsencrypt-acme-issuer</span>
</code></pre></div>
<p>Voici le manifest de l'issuer de type acme </p>
<blockquote>
<p><strong>Note</strong> il existe d'autres types d'issuer pour d'autres protocoles comme vault pki, ca, etc...</p>
</blockquote>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/roles/kubeapps/templates/cert-manager-chart-crd.yml.j2</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-10-19">19</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-10-20">20</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-10-21">21</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-10-22">22</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-10-23">23</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-10-24">24</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-10-25">25</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-10-26">26</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-10-27">27</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-10-28">28</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-10-29">29</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-10-30">30</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-10-31">31</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-10-32">32</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-10-33">33</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-10-34">34</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-10-35">35</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-10-19" name="__codelineno-10-19"></a><span class="nn">---</span>
<a id="__codelineno-10-20" name="__codelineno-10-20"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cert-manager.io/v1</span>
<a id="__codelineno-10-21" name="__codelineno-10-21"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterIssuer</span>
<a id="__codelineno-10-22" name="__codelineno-10-22"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-10-23" name="__codelineno-10-23"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">letsencrypt-acme-issuer</span>
<a id="__codelineno-10-24" name="__codelineno-10-24"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-10-25" name="__codelineno-10-25"></a><span class="w">  </span><span class="nt">acme</span><span class="p">:</span>
<a id="__codelineno-10-26" name="__codelineno-10-26"></a><span class="w">    </span><span class="nt">skipTLSVerify</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">kubeapps_internal_acme_network_ip is not none</span><span class="w"> </span><span class="p p-Indicator">}}</span>
<a id="__codelineno-10-27" name="__codelineno-10-27"></a><span class="w">    </span><span class="nt">email</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">cert_manager_email</span><span class="w"> </span><span class="p p-Indicator">}}</span>
<a id="__codelineno-10-28" name="__codelineno-10-28"></a><span class="w">    </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">cert_manager_acme_url</span><span class="w"> </span><span class="p p-Indicator">}}</span>
<a id="__codelineno-10-29" name="__codelineno-10-29"></a><span class="w">    </span><span class="nt">privateKeySecretRef</span><span class="p">:</span>
<a id="__codelineno-10-30" name="__codelineno-10-30"></a><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">acme-account-key</span>
<a id="__codelineno-10-31" name="__codelineno-10-31"></a><span class="w">    </span><span class="nt">solvers</span><span class="p">:</span>
<a id="__codelineno-10-32" name="__codelineno-10-32"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">selector</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
<a id="__codelineno-10-33" name="__codelineno-10-33"></a><span class="w">      </span><span class="nt">http01</span><span class="p">:</span>
<a id="__codelineno-10-34" name="__codelineno-10-34"></a><span class="w">        </span><span class="nt">ingress</span><span class="p">:</span>
<a id="__codelineno-10-35" name="__codelineno-10-35"></a><span class="w">          </span><span class="nt">class</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">kubeapps_k8s_ingress_class</span><span class="w"> </span><span class="p p-Indicator">}}</span>
</code></pre></div></td></tr></table></div>
<blockquote>
<p><strong>Note</strong> Vu que l'on passe par l'ingress pour injecter les point d'accès du challenge acme, il faut bien configuré l'issuer avec la bonne classe d'ingress.</p>
<p><strong>Note</strong> kind: <code>ClusterIssuer</code> permet de créer un issuer qui sera disponible dans tout le cluster. À l'inverse un <code>Issuer</code> est disponible dans un seul namespace.</p>
</blockquote>
<p>Nous voilà prêt il ne reste que à appeler la création du manifest dans notre fichier wrapper <code>main.yml</code> :</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/roles/kubeapps/tasks/main.yml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-11-16">16</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-11-17">17</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-11-18">18</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-11-19">19</a></span>
<span class="normal"><a href="#1-6-ansible-cert-manager-__codelineno-11-20">20</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-11-16" name="__codelineno-11-16"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">include_tasks</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">manifests.yml</span>
<a id="__codelineno-11-17" name="__codelineno-11-17"></a><span class="w">  </span><span class="c1"># ...</span>
<a id="__codelineno-11-18" name="__codelineno-11-18"></a><span class="w">  </span><span class="nt">loop</span><span class="p">:</span>
<a id="__codelineno-11-19" name="__codelineno-11-19"></a><span class="w">    </span><span class="c1"># ...</span>
<a id="__codelineno-11-20" name="__codelineno-11-20"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt"> src</span><span class="p">:</span><span class="w"> </span><span class="nv">cert-manager-chart-crd.yml</span><span class="p p-Indicator">,</span><span class="nt"> deploy</span><span class="p">:</span><span class="w">  </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">cert_manager_namespace</span><span class="nv"> </span><span class="s">}}&quot;</span><span class="w"> </span><span class="p p-Indicator">}</span>
</code></pre></div></td></tr></table></div>
<p>Tout cela ne va cependant pas être suffisant dans le cas du mTLS car on va avoir besoin de faire confiance à notre autorité de certification.</p>
<p>On peut maintenant tester le bon fonctionnement de cert-manager et aussi la partie précédente sur coredns avec <code>molecule test</code></p></section><section class="print-page" id="1-7-ansible-trust-ca"><h1 id="1-7-ansible-trust-ca-17-faire-confiance-a-notre-autorite-de-certification">1.7 Faire confiance à notre autorité de certification<a class="headerlink" href="#1-7-ansible-trust-ca-17-faire-confiance-a-notre-autorite-de-certification" title="Permanent link">&para;</a></h1>
<hr />
<p>On a deux endroits où l'on va faire confiance à notre autorité de certification.</p>
<ul>
<li>Sur notre machine et dans les différents pods ou mTLS </li>
<li>Sur le navigateur</li>
</ul>
<h4 id="1-7-ansible-trust-ca-sur-notre-machine-dans-les-differents-pods-ou-mtls">Sur notre machine dans les différents pods ou mTLS<a class="headerlink" href="#1-7-ansible-trust-ca-sur-notre-machine-dans-les-differents-pods-ou-mtls" title="Permanent link">&para;</a></h4>
<p>Les serveurs acceptent les certificats de notre autorité de certification et se font donc suffisamment confiance entre eux pour établir une connexion TLS.</p>
<p>Pour qu'en interne nos serveur se fassent confiance, nous avons besoin de récupérer le certificat racine de notre autorité de certification et de l'ajouter dans le trust store de nos serveurs. De plus il faut que ce certificat soit présent avant le démarrage de k3s pour valider les requêtes de dex et kubeapps.</p>
<p>On utilise l'url du serveur staging <code>cert_manager_staging_ca_cert_url</code> qui est ici défini sur pebble pour récupérer ce certificat avant de jouer tous les rôles.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/roles/kubeapps/tasks/pre-import-cert.yml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-0-10">10</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-0-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Download certificate file</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="w">  </span><span class="nt">uri</span><span class="p">:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">    </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">cert_manager_staging_ca_cert_url</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">    </span><span class="nt">validate_certs</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">kubeapps_internal_acme_network_ip</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">none</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">    </span><span class="nt">return_content</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">True</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">  </span><span class="nt">register</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ca_file</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Trust cert inside current machine</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">  </span><span class="nt">ansible.builtin.copy</span><span class="p">:</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="w">    </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">kubeapps_internal_acme_ca_file</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="w">    </span><span class="nt">content</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">ca_file.content</span><span class="nv"> </span><span class="s">}}&quot;</span>
</code></pre></div></td></tr></table></div>
<p>Une fois cette configuration stocké nous allons pouvoir l'injecter dans les pods avec des <code>volumes</code>.</p>
<p>Ces volumes sont des espaces de stockage qui seront monté dans les pods et qui seront accessible par les containers.</p>
<p>Voici les objets volumes définis dans le fichier <strong>vars.yml</strong> de notre role kubeapps afin d'éviter qu'ils soient vide. Ils seront override si un <code>cert_manager_staging_ca_cert_url</code> est présent, car on injectera l'autorité dans les pods.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/roles/kubeapps/vars/main.yml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-1-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="c1"># Mounted in acme internal</span>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="nt">kubeapps_internal_acme_ca_file</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/ssl/certs/acmeca.crt</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="nt">kubeapps_internal_acme_ca_in_volume_crt: /etc/ssl/certs/acmeca.crtkubeapps_internal_acme_ca_extra_volumes</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="nt">kubeapps_internal_acme_ca_extra_volumes_mounts</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>
</code></pre></div></td></tr></table></div>
<blockquote>
<p><strong>Note</strong> <code>/etc/ssl/certs/</code> est le répertoire par défaut des certificats sur les images linux, ils sont très souvent supportés par les frameworks et langages de programmation. Ainsi on fera confiance à n'importe quelle requête https vers un serveur configurés avec le certificat signé par celle-ci.</p>
</blockquote>
<p>Ensuite, il nous faut stocker dans des facts ansible le contenu du certificat et des définitions de volumes que l'on va injecter dans nos containers dans le contexte du local.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/roles/kubeapps/tasks/pre-import-cert.yml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-2-13">13</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-2-14">14</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-2-15">15</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-2-16">16</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-2-17">17</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-2-18">18</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-2-19">19</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-2-20">20</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-2-21">21</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-2-22">22</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">set_fact</span><span class="p">:</span>
<a id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="w">    </span><span class="nt">kubeapps_internal_acme_ca_content</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">ca_file.content</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-2-15" name="__codelineno-2-15"></a><span class="w">    </span><span class="nt">kubeapps_internal_acme_ca_extra_volumes</span><span class="p">:</span>
<a id="__codelineno-2-16" name="__codelineno-2-16"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">acme-internal-ca-share</span>
<a id="__codelineno-2-17" name="__codelineno-2-17"></a><span class="w">      </span><span class="nt">configMap</span><span class="p">:</span><span class="w"> </span>
<a id="__codelineno-2-18" name="__codelineno-2-18"></a><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">acme-internal-ca-share</span>
<a id="__codelineno-2-19" name="__codelineno-2-19"></a><span class="w">    </span><span class="nt">kubeapps_internal_acme_ca_extra_volumes_mounts</span><span class="p">:</span>
<a id="__codelineno-2-20" name="__codelineno-2-20"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">acme-internal-ca-share</span>
<a id="__codelineno-2-21" name="__codelineno-2-21"></a><span class="w">        </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">kubeapps_internal_acme_ca_in_volume_crt</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-2-22" name="__codelineno-2-22"></a><span class="w">        </span><span class="nt">subPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ca.crt</span>
</code></pre></div></td></tr></table></div>
<p>Il faut ensuite absolument utiliser cette tâche avant le rôle sinon k3s va s'initialiser sans le certificat de Lets_encrypt digne de confiance et ne validera aucune connextion en TLS. (en particulier dex qui lui permet de controller le cluster avec l'api)</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/roles/kubeapps/molecule/default/converge.yml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-3-41">41</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-3-42">42</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-41" name="__codelineno-3-41"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Import acme certificates</span>
<a id="__codelineno-3-42" name="__codelineno-3-42"></a><span class="w">      </span><span class="nt">include_tasks</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;../../tasks/pre-import-cert.yml&quot;</span>
</code></pre></div></td></tr></table></div>
<p>Nous avons alors besoin de plusieurs choses pour importer notre certificat racine dans le "trust-store" de nos serveurs.</p>
<p>Une ressource Kubernetes <code>configmap</code> (ou <code>secret</code>) pour stocker le certificat racine que l'on a récupéré dans les étapes précédentes dans une variable <code>kubeapps_internal_acme_ca_content</code>.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/roles/kubeapps/templates/trust-bundle-config-crd.yml.j2</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-4-1">1</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-4-2">2</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-4-3">3</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-4-4">4</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-4-5">5</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-4-6">6</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-4-7">7</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-4-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">acme-internal-root-ca</span>
<a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">cert_manager_namespace</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="nt">data</span><span class="p">:</span>
<a id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="w">  </span><span class="nt">ca.crt</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<a id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="w">    </span><span class="no">{{ kubeapps_internal_acme_ca_content | indent(4) }}</span>
</code></pre></div></td></tr></table></div>
<blockquote>
<p><code>indent</code> sert à rajouter les espace à chaque lignes du certificat pour qu'il soit bien formatté dans le fichier yaml.</p>
</blockquote>
<p><strong>Cependant,</strong> nous remarquon avec <code>kubectl get cm -A</code> que la ressource n'est présente que dans le namespace <code>cert-manager</code> or nous avons besoin de la récupérer dans les autres namespaces.</p>
<p>C'est pourquoi nous allons utiliser un module <code>trust-manager</code> fourni par jetstack pour partager cette ressource.</p>
<p>Pour commencer nous allons installer le helm chart de <code>trust-manager</code> avec le template <code>playbook/trust-manager.yml.j2</code> :</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/roles/kubeapps/templates/trust-manager-chart-crd.yml.j2</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-5-1"> 1</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-5-2"> 2</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-5-3"> 3</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-5-4"> 4</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-5-5"> 5</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-5-6"> 6</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-5-7"> 7</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-5-8"> 8</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-5-9"> 9</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-5-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">helm.cattle.io/v1</span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HelmChart</span>
<a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">trust-manager</span>
<a id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-system</span>
<a id="__codelineno-5-6" name="__codelineno-5-6"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="w">  </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.3.0</span>
<a id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="w">  </span><span class="nt">chart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">trust-manager</span>
<a id="__codelineno-5-9" name="__codelineno-5-9"></a><span class="w">  </span><span class="nt">targetNamespace</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">cert_manager_namespace</span><span class="w"> </span><span class="p p-Indicator">}}</span>
<a id="__codelineno-5-10" name="__codelineno-5-10"></a><span class="w">  </span><span class="nt">repo</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://charts.jetstack.io</span>
</code></pre></div></td></tr></table></div>
<blockquote>
<p>Warning : on fixe bien la version du chart car l'équipe de développement précise qu'ils apporteront des changements non rétrocompatibles dans les prochaines versions.</p>
</blockquote>
<p>Puis on ajoute dans après notre <code>configmap</code> le trust-bundle dans un nouveau fichier pour partagé le certificat. Notre configmap s'organise avec le nom <code>acme-internal-ca-share</code> et une sous variable précisant le fichier <code>ca.crt</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/roles/kubeapps/templates/trust-bundle-config-crd.yml.j2</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-6-1"> 1</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-6-2"> 2</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-6-3"> 3</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-6-4"> 4</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-6-5"> 5</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-6-6"> 6</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-6-7"> 7</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-6-8"> 8</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-6-9"> 9</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-6-10">10</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-6-11">11</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-6-12">12</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-6-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="nn">---</span>
<a id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">trust.cert-manager.io/v1alpha1</span>
<a id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Bundle</span>
<a id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">acme-internal-ca-share</span>
<a id="__codelineno-6-6" name="__codelineno-6-6"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-6-7" name="__codelineno-6-7"></a><span class="w">  </span><span class="nt">sources</span><span class="p">:</span>
<a id="__codelineno-6-8" name="__codelineno-6-8"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">configMap</span><span class="p">:</span>
<a id="__codelineno-6-9" name="__codelineno-6-9"></a><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;acme-internal-root-ca&quot;</span>
<a id="__codelineno-6-10" name="__codelineno-6-10"></a><span class="w">      </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ca.crt&quot;</span>
<a id="__codelineno-6-11" name="__codelineno-6-11"></a><span class="w">  </span><span class="nt">target</span><span class="p">:</span>
<a id="__codelineno-6-12" name="__codelineno-6-12"></a><span class="w">    </span><span class="nt">configMap</span><span class="p">:</span>
<a id="__codelineno-6-13" name="__codelineno-6-13"></a><span class="w">      </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ca.crt&quot;</span>
</code></pre></div></td></tr></table></div>
<p>Ensuite, <strong>il est essentiel</strong> d'appeler dans l'ordre tous ces manifests que l'on vient de créer :</p>
<blockquote>
<p><strong>Warning</strong> On les lance bien après l'installation et configuration de notre issuer <code>cert-manager</code> pour éviter des erreurs de dépendances manquantes.</p>
</blockquote>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/roles/kubeapps/tasks/main.yml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-7-17">17</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-7-18">18</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-7-19">19</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-7-20">20</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-7-21">21</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-7-22">22</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-17" name="__codelineno-7-17"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">trust-manager-chart-crd.yml</span>
<a id="__codelineno-7-18" name="__codelineno-7-18"></a><span class="w">      </span><span class="nt">deploy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">trust-manager</span><span class="w"> </span>
<a id="__codelineno-7-19" name="__codelineno-7-19"></a><span class="w">      </span><span class="nt">ns</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">cert_manager_namespace</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-7-20" name="__codelineno-7-20"></a><span class="w">      </span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">cert_manager_is_internal</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-7-21" name="__codelineno-7-21"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">trust-bundle-config-crd.yml</span>
<a id="__codelineno-7-22" name="__codelineno-7-22"></a><span class="w">      </span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">cert_manager_is_internal</span><span class="nv"> </span><span class="s">}}&quot;</span>
</code></pre></div></td></tr></table></div>
<p>Voici un exemple d'utilisation des volumes dans kubernetes :</p>
<p>Import du volume pour le rendre disponible au montage :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#1-7-ansible-trust-ca-__codelineno-8-1"></a><span class="nt">podnameexample</span><span class="p">:</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#1-7-ansible-trust-ca-__codelineno-8-2"></a><span class="w">  </span><span class="nt">extraVolumes</span><span class="p">:</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#1-7-ansible-trust-ca-__codelineno-8-3"></a><span class="w">    </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">kubeapps_internal_acme_ca_extra_volumes | to_nice_yaml | indent(4)</span><span class="w"> </span><span class="p p-Indicator">}}</span>
</code></pre></div>
<p>Montage du volume dans le container :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#1-7-ansible-trust-ca-__codelineno-9-1"></a><span class="nt">podsubcontainerexample</span><span class="p">:</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#1-7-ansible-trust-ca-__codelineno-9-2"></a><span class="w">  </span><span class="nt">extraVolumeMounts</span><span class="p">:</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#1-7-ansible-trust-ca-__codelineno-9-3"></a><span class="w">    </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">kubeapps_internal_acme_ca_extra_volumes_mounts | to_nice_yaml | indent(4)</span><span class="w"> </span><span class="p p-Indicator">}}</span>
</code></pre></div>
<p>Les volumes sont <strong>vide par défaut</strong>, on les renseigne seulement à la fin de la tâche <strong>pre-import-cert</strong> lancée en mode cert-manager interne. Voici un rappel du <code>set_fact</code> pour définir ces volumes :</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/roles/kubeapps/tasks/pre-import-cert.yml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-10-18">18</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-10-19">19</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-10-20">20</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-10-21">21</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-10-22">22</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-10-23">23</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-10-24">24</a></span>
<span class="normal"><a href="#1-7-ansible-trust-ca-__codelineno-10-25">25</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-10-18" name="__codelineno-10-18"></a><span class="w">    </span><span class="nt">kubeapps_internal_acme_ca_extra_volumes</span><span class="p">:</span>
<a id="__codelineno-10-19" name="__codelineno-10-19"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">acme-internal-ca-share</span>
<a id="__codelineno-10-20" name="__codelineno-10-20"></a><span class="w">      </span><span class="nt">configMap</span><span class="p">:</span><span class="w"> </span>
<a id="__codelineno-10-21" name="__codelineno-10-21"></a><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">acme-internal-ca-share</span>
<a id="__codelineno-10-22" name="__codelineno-10-22"></a><span class="w">    </span><span class="nt">kubeapps_internal_acme_ca_extra_volumes_mounts</span><span class="p">:</span>
<a id="__codelineno-10-23" name="__codelineno-10-23"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">acme-internal-ca-share</span>
<a id="__codelineno-10-24" name="__codelineno-10-24"></a><span class="w">      </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">kubeapps_internal_acme_ca_in_volume_crt</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-10-25" name="__codelineno-10-25"></a><span class="w">      </span><span class="nt">subPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ca.crt</span>
</code></pre></div></td></tr></table></div>
<h4 id="1-7-ansible-trust-ca-sur-notre-navigateur">Sur notre navigateur :<a class="headerlink" href="#1-7-ansible-trust-ca-sur-notre-navigateur" title="Permanent link">&para;</a></h4>
<p>Une autorité de certification est toujours initiée à partir d'une paire cryptographique faite d'une clé privée et d'un certificat contenant une clé publique. Comme pour d'autres protocoles comme ssh ou même Ethereum il faut accepter le certificat racine de l'autorité contenant la clé publique.</p>
<p>Vous pouvez le récupérer avec cette commande :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#1-7-ansible-trust-ca-__codelineno-11-1"></a>curl<span class="w"> </span>-k<span class="w"> </span>https://localhost:15000/roots/0<span class="w"> </span>&gt;<span class="w"> </span>~/Downloads/pebble-ca.pem
</code></pre></div>
<p><strong>Mac :</strong></p>
<ul>
<li>Ouvrir Trousseaux d'accès (Keychain Access)</li>
<li>Fichier &gt; Importer des élements</li>
<li>Sélectionner <code>~/Downloads/pebble-ca.pem</code></li>
<li>Clic droit sur "Pebble root ca" et sélectionner "Afficher les informations"</li>
<li>Ouvrir les droits et selectionner <code>Toujours faire confiance</code> quand on utilise ce certificat</li>
</ul>
<p><strong>Sur Linux</strong> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#1-7-ansible-trust-ca-__codelineno-12-1"></a>sudo cp ~/Downloads/pebble-ca.pem /usr/local/share/ca-certificates/pebble-ca.pem
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#1-7-ansible-trust-ca-__codelineno-12-2"></a>sudo chmod 644 /usr/local/share/ca-certificates/pebble-ca.pem
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#1-7-ansible-trust-ca-__codelineno-12-3"></a>sudo update-ca-certificates
</code></pre></div>
<p><strong>*Relancez la page sur votre navigateur</strong></p>
<hr /></section><section class="print-page" id="1-8-ansible-dex"><h1 id="1-8-ansible-dex-18-authentification-et-des-habilitations">1.8 Authentification et des habilitations<a class="headerlink" href="#1-8-ansible-dex-18-authentification-et-des-habilitations" title="Permanent link">&para;</a></h1>
<hr />
<p>Il est inclus dans kubernetes deux façons d'authentifier les utilisateurs au cluster et ses resources api (<code>services</code>, <code>pods</code>, <code>secrets</code>...) :</p>
<ul>
<li>
<p>Les Services accounts utilisés pour authentifier des processus qui se lancent dans les pods. Ils s'utilisent avec un simple token et des droits rattachés.</p>
</li>
<li>
<p>Users et Groups (comme pour linux). Ces ressources sont créé implicitement par un client Open-id Connect fourni sous réserve d'activation par kubernetes.
On optera pour cette méthode en utilisant comme serveur open id : <strong>dex</strong> idp qui consomme plusieurs fournisseurs d'accès externes (ou interne).</p>
</li>
</ul>
<h3 id="1-8-ansible-dex-1-configuration-de-notre-organisation-github-et-application-oauth">1. Configuration de notre organisation github et application oauth<a class="headerlink" href="#1-8-ansible-dex-1-configuration-de-notre-organisation-github-et-application-oauth" title="Permanent link">&para;</a></h3>
<p>Créer une nouvelle organisation <a href="https://github.com/account/organizations/new">ici</a> :</p>
<ul>
<li>Sélectionner le "free plan"</li>
<li>Choisissez un nom à l'organisation</li>
<li>Renseignez votre email</li>
<li>Cocher bien qu'elle vous appartient (rattaché à votre pseudo github)</li>
</ul>
<blockquote>
<p>On peut créer une équipe particulière dans notre organisation qui pourra avoir accès à kubeapps. Le Lien vers le formulaire de création ressemble à ça : https://github.com/orgs/nom-de-ton-organisation/new-team.</p>
</blockquote>
<p>Nommez-les comme vous voulez puis ajoutez la variable dans votre playbook de test (non conseillé en production, utilisez plutôt ansible-vault) :</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/roles/kubeapps/molecule/default/converge.yml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#1-8-ansible-dex-__codelineno-0-14">14</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-0-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="w">    </span><span class="nt">dex_github_client_org</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;esgi-lyon&quot;</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="w">    </span><span class="nt">dex_github_client_team</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ops-team-test&quot;</span>
</code></pre></div></td></tr></table></div>
<h4 id="1-8-ansible-dex-creer-lapplication-github">Créer l'application github<a class="headerlink" href="#1-8-ansible-dex-creer-lapplication-github" title="Permanent link">&para;</a></h4>
<p><a href="https://github.com/organizations/&lt;my-org&gt;/settings/applications/new">créer votre application ici</a></p>
<p>Configuré la comme ceci <strong>pour l'instant</strong> en utilisant les url en local qui ne fonctionnerons pas (pas de tls activé / ni online)</p>
<ul>
<li>Application name : <code>kubeapps-test</code></li>
<li>Homepage URL : <code>https://kubeapps.k3s.local</code></li>
<li>Authorization callback URL : <code>https://dex.k3s.local/callback</code></li>
</ul>
<p>Ensuite noté bien votre <strong>Client Id</strong> et générer un nouveau <strong>Client secret</strong> en plus.</p>
<h4 id="1-8-ansible-dex-configuration">Configuration<a class="headerlink" href="#1-8-ansible-dex-configuration" title="Permanent link">&para;</a></h4>
<p>D'abord comme vu précédemment avec cert-manager on créer les variables par défaut requises par dex :</p>
<p>D'abord des informations globales comme l'espace de nom kubernetes et l'url par lequel on peut accéder au service.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/roles/kubeapps/defaults/main.yml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#1-8-ansible-dex-__codelineno-1-16">16</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-1-17">17</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-1-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="c1"># HelmChart Custom Resource Definition for dex oidc connector</span>
<a id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="nt">dex_namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dex</span>
<a id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="nt">dex_hostname</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dex.k3s.local</span>
</code></pre></div></td></tr></table></div>
<p>Ensuite on précise les informations de connexion à github ainsi que les celles qui permettrons au client de notre openid de se connecter. On laisse ces informations à null dans un but de documentation.</p>
<blockquote>
<p>On prend un raccourci avec le secret, mais dans l'inventaire ansible final on renseignera des secrets plus sécurisés.</p>
</blockquote>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#1-8-ansible-dex-__codelineno-2-1"></a><span class="nt">dex_client_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubeapps</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#1-8-ansible-dex-__codelineno-2-2"></a><span class="nt">dex_client_secret</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ZXhhbXBsZS1hcHAtc2VjcmV0</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#1-8-ansible-dex-__codelineno-2-3"></a><span class="nt">dex_github_client_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">~</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#1-8-ansible-dex-__codelineno-2-4"></a><span class="nt">dex_github_client_secret</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">~</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#1-8-ansible-dex-__codelineno-2-5"></a><span class="nt">dex_github_client_org</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">~</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#1-8-ansible-dex-__codelineno-2-6"></a><span class="nt">dex_github_client_team</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">~</span>
</code></pre></div>
<blockquote>
<p><strong>INFO</strong> Le client open id est ici kubeapps. Pour résumé après ce schéma, kubeapps se sert du <strong>claim open id</strong> <code>groups</code> (qui aura ici comme valeur <code>esgi-lyon:ops-team</code>) renvoyé par dex pour accéder aux ressources du cluster autorisées par son rôle.</p>
<p><strong>Warning</strong> Le <code>dex_client_secret</code> par défaut n'est pas du tout sécurisé et doit être changé en production</p>
</blockquote>
<h4 id="1-8-ansible-dex-encrypter-les-secrets-de-lapplication-github">Encrypter les secrets de l'application github<a class="headerlink" href="#1-8-ansible-dex-encrypter-les-secrets-de-lapplication-github" title="Permanent link">&para;</a></h4>
<p>Nous allons crypter les Informations dangereuses dans un vault ansible que l'on pourra créer avec :</p>
<p>Dans votre rôle <code>playbook/roles/kubeapps</code></p>
<p>D'abord, il faut renseigner un mot de passe dans un fichier <code>$HOME/.ansible/.vault</code>.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#1-8-ansible-dex-__codelineno-3-1"></a><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;your-pass&#39;</span><span class="w"> </span>&gt;<span class="w"> </span><span class="nv">$HOME</span>/.ansible/.vault
</code></pre></div>
<blockquote>
<p>Warning : en bash <code>&gt;</code> écrase le fichier et <code>&gt;&gt;</code> ajoute à la fin du fichier. L'idéal est d'utiliser la commande <code>tee</code> à la place de ces opérandes.</p>
</blockquote>
<p>Puis on peut initier les secrets dans les <code>group_vars</code> pour qu'il soit possible de les identifier comme facts ansible et puis les utiliser au cours de l'exécution du playbook :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#1-8-ansible-dex-__codelineno-4-1"></a>ansible-vault<span class="w"> </span>create<span class="w"> </span>--vault-password-file<span class="w"> </span><span class="nv">$HOME</span>/.ansible/.vault<span class="w"> </span>molecule/default/group_vars/molecule/secrets.yml
</code></pre></div>
<blockquote>
<p><strong>Warning</strong> : Ce mot de passe est utilisé pour décrypter les secrets de votre playbook de test. Il est donc important de le garder secret d'où une localisation à l'extérieur du repo.</p>
<p><strong>Warning</strong> Il est aussi recommandé de le stocker en double dans un gestionnaire de mot de passe ou autre gestionnaire de secret perfectionné (Github action, Hashicorp vault...)</p>
</blockquote>
<p>Vous devrez ensuite renseigner ces secrets afin de cacher les informations sensibles dans votre playbook de test.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/roles/kubeapps/molecule/default/group_vars/molecule/secrets.yml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#1-8-ansible-dex-__codelineno-5-1">1</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-5-2">2</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-5-3">3</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-5-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="nt">cert_manager_email</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test4@k3s.local</span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a>
<a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="nt">dex_github_client_id</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;my-client-id-from-github-oauth-app&quot;</span>
<a id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="nt">dex_github_client_secret</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;my-client-secret-from-github-oauth-app&quot;</span>
</code></pre></div></td></tr></table></div>
<p>Si besoin vous pouvez éditer le fichier avec la commande suivante :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#1-8-ansible-dex-__codelineno-6-1"></a>ansible-vault<span class="w"> </span>edit<span class="w"> </span>molecule/default/group_vars/molecule/secrets.yml<span class="w"> </span>--vault-password-file<span class="w"> </span><span class="nv">$HOME</span>/.ansible/.vault
</code></pre></div>
<p>Puis on configure molecule pour utiliser le fichier de mot de passe et le groupe de variable <strong><code>molecule</code></strong> qui contient nos secrets. Il est implicitement défini quand on crée le dossier <code>group_vars/molecule</code>:</p>
<p>Dans votre configuration de plateforme de test molecule <code>node-0</code> :</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/roles/kubeapps/molecule/default/molecule.yml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#1-8-ansible-dex-__codelineno-7-12">12</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-7-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-12" name="__codelineno-7-12"></a><span class="w">    </span><span class="nt">groups</span><span class="p">:</span>
<a id="__codelineno-7-13" name="__codelineno-7-13"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">molecule</span>
</code></pre></div></td></tr></table></div>
<p>Puis on configure le provisioner ansible pour utiliser le fichier de mot de passe :</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/roles/kubeapps/molecule/default/molecule.yml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#1-8-ansible-dex-__codelineno-8-22">22</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-8-23">23</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-8-24">24</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-8-25">25</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-8-26">26</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-22" name="__codelineno-8-22"></a><span class="nt">provisioner</span><span class="p">:</span>
<a id="__codelineno-8-23" name="__codelineno-8-23"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ansible</span>
<a id="__codelineno-8-24" name="__codelineno-8-24"></a><span class="w">  </span><span class="nt">config_options</span><span class="p">:</span>
<a id="__codelineno-8-25" name="__codelineno-8-25"></a><span class="w">    </span><span class="nt">defaults</span><span class="p">:</span>
<a id="__codelineno-8-26" name="__codelineno-8-26"></a><span class="w">      </span><span class="nt">vault_password_file</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${HOME}/.ansible/.vault</span>
</code></pre></div></td></tr></table></div>
<p>Voilà, maintenant molecule importe les secrets et les rend disponible dans les variables ansible.</p>
<h1 id="1-8-ansible-dex-installation-de-dex">Installation de dex<a class="headerlink" href="#1-8-ansible-dex-installation-de-dex" title="Permanent link">&para;</a></h1>
<p>Voici un schéma pour imager comment ce claim open id va servir à sécuriser l'attribution des droits en plus de la connection au cluster.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#1-8-ansible-dex-__codelineno-9-1"></a>---|   |--------|        |------- |                      |----------|
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#1-8-ansible-dex-__codelineno-9-2"></a>   |   |kubeapps|-- ask-&gt;| dex    |--convert request----&gt;| Github   |
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#1-8-ansible-dex-__codelineno-9-3"></a>k3s|&lt;--|        |&lt;-------| openid |                      | oauth2   |
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#1-8-ansible-dex-__codelineno-9-4"></a>---|   |--------|--------|--------|&lt;-esgi-lyon:ops-team--|----------|
</code></pre></div>
<p>Définissons un manifest utilisant helm pour installer facilement dex sur le cluster kubernetes. Implicitement seront créer des fichiers d'attributions de droit au cluster, le fichier de déploiement des pod et les services exposants des noms et adresses dans le cluster.</p>
<p>On commence par créer le namespace</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/roles/kubeapps/templates/dex-chart-crd.yml.j2</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#1-8-ansible-dex-__codelineno-10-1">1</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-10-2">2</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-10-3">3</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-10-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Namespace</span>
<a id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-10-4" name="__codelineno-10-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">dex_namespace</span><span class="w"> </span><span class="p p-Indicator">}}</span>
</code></pre></div></td></tr></table></div>
<p>Puis on installe le chart helm de dex comme d'habitude avec ce genre de manifest :</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/roles/kubeapps/templates/dex-chart-crd.yml.j2</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#1-8-ansible-dex-__codelineno-11-6"> 6</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-11-7"> 7</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-11-8"> 8</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-11-9"> 9</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-11-10">10</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-11-11">11</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-11-12">12</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-11-13">13</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-11-14">14</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-11-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-11-6" name="__codelineno-11-6"></a><span class="nn">---</span>
<a id="__codelineno-11-7" name="__codelineno-11-7"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">helm.cattle.io/v1</span>
<a id="__codelineno-11-8" name="__codelineno-11-8"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HelmChart</span>
<a id="__codelineno-11-9" name="__codelineno-11-9"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-11-10" name="__codelineno-11-10"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dex</span>
<a id="__codelineno-11-11" name="__codelineno-11-11"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-system</span>
<a id="__codelineno-11-12" name="__codelineno-11-12"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-11-13" name="__codelineno-11-13"></a><span class="w">  </span><span class="nt">chart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dex</span>
<a id="__codelineno-11-14" name="__codelineno-11-14"></a><span class="w">  </span><span class="nt">targetNamespace</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">dex_namespace</span><span class="w"> </span><span class="p p-Indicator">}}</span>
<a id="__codelineno-11-15" name="__codelineno-11-15"></a><span class="w">  </span><span class="nt">repo</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://charts.dexidp.io</span>
</code></pre></div></td></tr></table></div>
<p>Dans le <code>valuesContent</code> nous allons renseigner trois principaux objets de configuration :</p>
<p><strong><code>config</code></strong> qui configure l'application web dex avec :
  - Le <code>issuer</code> est l'url de base de dex. Il est utilisé pour construire les urls de redirection et de callback.
  - Le connecteur github
  - Les informations de stockage, 
  - L'hôte et le port interne sur lequel le serveur web écoute et 
  - Le client openid pour donner le droit à kubeapps de consommer l'authentification de dex</p>
<p>Voici la configuration qui réutilise les variables de notre application oauth github et les credentials définies dans les defaults et le playbook converge.yml :</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/roles/kubeapps/templates/dex-chart-crd.yml.j2</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#1-8-ansible-dex-__codelineno-12-15">15</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-12-16">16</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-12-17">17</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-12-18">18</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-12-19">19</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-12-20">20</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-12-21">21</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-12-22">22</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-12-23">23</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-12-24">24</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-12-25">25</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-12-26">26</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-12-27">27</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-12-28">28</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-12-29">29</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-12-30">30</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-12-31">31</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-12-32">32</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-12-33">33</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-12-34">34</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-12-35">35</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-12-36">36</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-12-37">37</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-12-38">38</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-12-39">39</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-12-40">40</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-12-41">41</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-12-42">42</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-12-43">43</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-12-15" name="__codelineno-12-15"></a><span class="w">  </span><span class="nt">valuesContent</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|-</span>
<a id="__codelineno-12-16" name="__codelineno-12-16"></a><span class="w">    </span><span class="no">config:</span>
<a id="__codelineno-12-17" name="__codelineno-12-17"></a><span class="w">      </span><span class="no">issuer: &quot;https://{{ dex_hostname }}&quot;</span>
<a id="__codelineno-12-18" name="__codelineno-12-18"></a><span class="w">      </span><span class="no">web:</span>
<a id="__codelineno-12-19" name="__codelineno-12-19"></a><span class="w">        </span><span class="no">http: 0.0.0.0:5556</span>
<a id="__codelineno-12-20" name="__codelineno-12-20"></a><span class="w">      </span><span class="no">storage:</span>
<a id="__codelineno-12-21" name="__codelineno-12-21"></a><span class="w">        </span><span class="no">type: kubernetes</span>
<a id="__codelineno-12-22" name="__codelineno-12-22"></a><span class="w">        </span><span class="no">config:</span>
<a id="__codelineno-12-23" name="__codelineno-12-23"></a><span class="w">          </span><span class="no">inCluster: true</span>
<a id="__codelineno-12-24" name="__codelineno-12-24"></a><span class="w">      </span><span class="no">connectors:</span>
<a id="__codelineno-12-25" name="__codelineno-12-25"></a><span class="w">      </span><span class="no">- type: github</span>
<a id="__codelineno-12-26" name="__codelineno-12-26"></a><span class="w">        </span><span class="no">id: github</span>
<a id="__codelineno-12-27" name="__codelineno-12-27"></a><span class="w">        </span><span class="no">name: GitHub</span>
<a id="__codelineno-12-28" name="__codelineno-12-28"></a><span class="w">        </span><span class="no">config:</span>
<a id="__codelineno-12-29" name="__codelineno-12-29"></a><span class="w">          </span><span class="no">clientID: &#39;{{ dex_github_client_id }}&#39;</span>
<a id="__codelineno-12-30" name="__codelineno-12-30"></a><span class="w">          </span><span class="no">clientSecret: &#39;{{ dex_github_client_secret }}&#39;</span>
<a id="__codelineno-12-31" name="__codelineno-12-31"></a><span class="w">          </span><span class="no">redirectURI: &quot;https://{{ dex_hostname }}/callback&quot;</span>
<a id="__codelineno-12-32" name="__codelineno-12-32"></a><span class="w">          </span><span class="no">orgs:</span>
<a id="__codelineno-12-33" name="__codelineno-12-33"></a><span class="w">          </span><span class="no">- name: &#39;{{ dex_github_client_org }}&#39;</span>
<a id="__codelineno-12-34" name="__codelineno-12-34"></a><span class="w">            </span><span class="no">teams: </span>
<a id="__codelineno-12-35" name="__codelineno-12-35"></a><span class="w">            </span><span class="no">- &#39;{{ dex_github_client_team }}&#39;</span>
<a id="__codelineno-12-36" name="__codelineno-12-36"></a><span class="w">      </span><span class="no">oauth2:</span>
<a id="__codelineno-12-37" name="__codelineno-12-37"></a><span class="w">        </span><span class="no">skipApprovalScreen: true</span>
<a id="__codelineno-12-38" name="__codelineno-12-38"></a><span class="w">      </span><span class="no">staticClients:</span>
<a id="__codelineno-12-39" name="__codelineno-12-39"></a><span class="w">      </span><span class="no">- id: &quot;{{ dex_client_id }}&quot;</span>
<a id="__codelineno-12-40" name="__codelineno-12-40"></a><span class="w">        </span><span class="no">redirectURIs:</span>
<a id="__codelineno-12-41" name="__codelineno-12-41"></a><span class="w">        </span><span class="no">- &#39;https://{{ kubeapps_hostname }}/oauth2/callback&#39;</span>
<a id="__codelineno-12-42" name="__codelineno-12-42"></a><span class="w">        </span><span class="no">name: &#39;Kubeapps&#39;</span>
<a id="__codelineno-12-43" name="__codelineno-12-43"></a><span class="w">        </span><span class="no">secret: &quot;{{ dex_client_secret }}&quot;</span>
</code></pre></div></td></tr></table></div>
<p>On n'oublie pas d'ajouter le chart à notre algorithme d'installation des manifests : </p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/roles/kubeapps/tasks/main.yml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#1-8-ansible-dex-__codelineno-13-24">24</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-13-24" name="__codelineno-13-24"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt"> src</span><span class="p">:</span><span class="w"> </span><span class="nv">dex-chart-crd.yml</span><span class="w"> </span><span class="p p-Indicator">,</span><span class="nt"> deploy</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">dex_namespace</span><span class="nv"> </span><span class="s">}}&quot;</span><span class="w"> </span><span class="p p-Indicator">}</span>
</code></pre></div></td></tr></table></div>
<p>Pour rappel il sera créer après ces étapes un deployment pour mettre le pod en place et un service pour l'exposer, celui ci est sur le port 5556 du container.</p>
<p>Ensuite on met en place le ingress pour associer les noms d'hôtes à ce service (port 5556) afin que le trafic externe y soit conduit (reverse proxy).</p>
<p>On utilise ici le certificat délivré par cert-manager au travers d'un secret <code>{{ dex_hostname }}-tls</code> automatiquement créer par l'issuer cert-manager activé avec : <code>cert-manager.io/cluster-issuer: letsencrypt-acme-issuer</code>.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/roles/kubeapps/templates/dex-chart-crd.yml.j2</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#1-8-ansible-dex-__codelineno-14-44">44</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-14-45">45</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-14-46">46</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-14-47">47</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-14-48">48</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-14-49">49</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-14-50">50</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-14-51">51</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-14-52">52</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-14-53">53</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-14-54">54</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-14-55">55</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-14-56">56</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-14-57">57</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-14-58">58</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-14-59">59</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-14-44" name="__codelineno-14-44"></a><span class="w">    </span><span class="nt">ingress</span><span class="p">:</span>
<a id="__codelineno-14-45" name="__codelineno-14-45"></a><span class="w">      </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-14-46" name="__codelineno-14-46"></a><span class="w">      </span><span class="nt">annotations</span><span class="p">:</span>
<a id="__codelineno-14-47" name="__codelineno-14-47"></a><span class="w">        </span><span class="nt">cert-manager.io/cluster-issuer</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">letsencrypt-acme-issuer</span>
<a id="__codelineno-14-48" name="__codelineno-14-48"></a><span class="w">        </span><span class="nt">kubernetes.io/ingress.class</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">kubeapps_k8s_ingress_class</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-14-49" name="__codelineno-14-49"></a><span class="w">        </span><span class="nt">traefik.frontend.passHostHeader</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;true&quot;</span>
<a id="__codelineno-14-50" name="__codelineno-14-50"></a><span class="w">        </span><span class="nt">traefik.ingress.kubernetes.io/router.tls</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;true&quot;</span>
<a id="__codelineno-14-51" name="__codelineno-14-51"></a><span class="w">      </span><span class="nt">hosts</span><span class="p">:</span>
<a id="__codelineno-14-52" name="__codelineno-14-52"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">dex_hostname</span><span class="w"> </span><span class="p p-Indicator">}}</span>
<a id="__codelineno-14-53" name="__codelineno-14-53"></a><span class="w">        </span><span class="nt">paths</span><span class="p">:</span>
<a id="__codelineno-14-54" name="__codelineno-14-54"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/</span>
<a id="__codelineno-14-55" name="__codelineno-14-55"></a><span class="w">            </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ImplementationSpecific</span>
<a id="__codelineno-14-56" name="__codelineno-14-56"></a><span class="w">      </span><span class="nt">tls</span><span class="p">:</span>
<a id="__codelineno-14-57" name="__codelineno-14-57"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">dex_hostname</span><span class="w"> </span><span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">-tls</span>
<a id="__codelineno-14-58" name="__codelineno-14-58"></a><span class="w">          </span><span class="nt">hosts</span><span class="p">:</span>
<a id="__codelineno-14-59" name="__codelineno-14-59"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">dex_hostname</span><span class="w"> </span><span class="p p-Indicator">}}</span>
</code></pre></div></td></tr></table></div>
<blockquote>
<p>Note: <code>traefik.ingress.kubernetes.io/router.tls: "true"</code> est nécessaire pour que traefik redirige les requêtes http vers https.</p>
</blockquote>
<p>Enfin le plus important, il faut intégrer dex dans le flux d'authentification de kubernetes. Pour cela on active le plugin oidc avec de nouveau argument de configuration de k3s.</p>
<p>On ajoute donc les variables dans le fichier meta du rôle pour influencer l'installation de k3s avec ces variables. C'est la principale raison de l'utilisation de la pré-tâche <code>playbook/roles/kubeapps/tasks/pre-import-cert.yml</code> du certificat avant le rôle.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/roles/kubeapps/meta/main.yml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#1-8-ansible-dex-__codelineno-15-53">53</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-15-54">54</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-15-55">55</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-15-56">56</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-15-57">57</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-15-58">58</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-15-59">59</a></span>
<span class="normal"><a href="#1-8-ansible-dex-__codelineno-15-60">60</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-15-53" name="__codelineno-15-53"></a><span class="w">    </span><span class="nt">vars</span><span class="p">:</span>
<a id="__codelineno-15-54" name="__codelineno-15-54"></a><span class="w">      </span><span class="nt">k3s_release_version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1.21</span>
<a id="__codelineno-15-55" name="__codelineno-15-55"></a><span class="w">      </span><span class="nt">k3s_server</span><span class="p">:</span>
<a id="__codelineno-15-56" name="__codelineno-15-56"></a><span class="w">        </span><span class="nt">kube-apiserver-arg=authorization-mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Node,RBAC</span>
<a id="__codelineno-15-57" name="__codelineno-15-57"></a><span class="w">        </span><span class="nt">kube-apiserver-arg=oidc-issuer-url</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://{{</span><span class="nv"> </span><span class="s">dex_hostname</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-15-58" name="__codelineno-15-58"></a><span class="w">        </span><span class="nt">kube-apiserver-arg=oidc-client-id</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">dex_client_id</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-15-59" name="__codelineno-15-59"></a><span class="w">        </span><span class="nt">kube-apiserver-arg=oidc-username-claim</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">email</span>
<a id="__codelineno-15-60" name="__codelineno-15-60"></a><span class="w">        </span><span class="nt">kube-apiserver-arg=oidc-groups-claim</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">groups</span>
</code></pre></div></td></tr></table></div>
<p>On lance notre <code>molecule test</code> pour voir si tous ce déploie bien et si l'url <a href="https://dex.k3s.local/.well-known/openid-configuration">https://dex.k3s.local/.well-known/openid-configuration</a> retourne bien un contenu. </p>
<p>Cela indique que Open id est configuré sur kubernetes et que nous sommes fin prêt à faire fonctionner kubeapps avec dex. Ils peuvent maintenant communiquer en Https et dex peut autoriser des connexion associé au "cluster role" permettant de contrôler kubernetes.</p>
<hr /></section><section class="print-page" id="1-9-ansible-kubeapps"><h1 id="1-9-ansible-kubeapps-19-installation-de-kubeapps">1.9 Installation de kubeapps<a class="headerlink" href="#1-9-ansible-kubeapps-19-installation-de-kubeapps" title="Permanent link">&para;</a></h1>
<hr />
<p>Commençons par construire notre manifest. Pour cela nous avons besoin de définir plusieurs variables pour rendre configurable l'utilisation de notre rôle :</p>
<p>Dans <a href="../1-9-ansible-kubeapps/playbook/roles/kubeapps/defaults/main.yml">playbook/roles/kubeapps/defaults/main.yml</a> on aura donc :</p>
<ul>
<li>
<p><code>kubeapps_namespace</code> pour définir le namespace à créer et sur lequel on déploie kubeapps</p>
</li>
<li>
<p><code>kubeapps_hostname</code> pour choisir à quel url sera disponible kubeapps.</p>
</li>
</ul>
<blockquote>
<p>Par défaut kubeapps sera disponible sur <code>kubeapps.k3s.local</code></p>
</blockquote>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/roles/kubeapps/defaults/main.yml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-0-22">22</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-0-23">23</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-0-24">24</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-0-25">25</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="nn">---</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="c1"># HelmChart Custom Resource Definition for kubeapps variables</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="nt">kubeapps_namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubeapps</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="nt">kubeapps_hostname</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubeapps.k3s.local</span>
</code></pre></div></td></tr></table></div>
<p>Ensuite nous allons utiliser toutes ces variables dans un manifest kubernetes qui inclus deux resources. Un namespace et une définition de dépendance helm avec sa configuration.</p>
<blockquote>
<p><strong>Note</strong> sur le templating jinja dans la moustache <code>{{}}</code> rajouter un <code>-</code> signifie qu'on ignore le format du côté où l'on utilise. Par exemple un retour à la ligne (colonne 0) sera ignorer pour <code>-}}</code>.</p>
</blockquote>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/roles/kubeapps/templates/kubeapps-chart-crd.yml.j2</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-1-10">10</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-1-11">11</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-1-12">12</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-1-13">13</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-1-14">14</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-1-15">15</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-1-16">16</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-1-17">17</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-1-18">18</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-1-19">19</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-1-20">20</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-1-21">21</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-1-22">22</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-1-23">23</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-1-24">24</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Namespace</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">kubeapps_namespace</span><span class="w"> </span><span class="p p-Indicator">}}</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="nn">---</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">helm.cattle.io/v1</span>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HelmChart</span>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubeapps</span>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-system</span>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">  </span><span class="nt">chart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubeapps</span>
<a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="w">  </span><span class="nt">targetNamespace</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">kubeapps_namespace</span><span class="w"> </span><span class="p p-Indicator">}}</span>
<a id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="w">  </span><span class="nt">repo</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://charts.bitnami.com/bitnami</span>
<a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="w">  </span><span class="nt">valuesContent</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|-</span>
<a id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="w">    </span><span class="no">ingress:</span>
<a id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="w">      </span><span class="no">tls: true</span>
<a id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="w">      </span><span class="no">enabled: true</span>
<a id="__codelineno-1-19" name="__codelineno-1-19"></a><span class="w">      </span><span class="no">hostname: &quot;{{ kubeapps_hostname }}&quot;</span>
<a id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="w">      </span><span class="no">annotations:</span>
<a id="__codelineno-1-21" name="__codelineno-1-21"></a><span class="w">        </span><span class="no">cert-manager.io/cluster-issuer: letsencrypt-acme-issuer</span>
<a id="__codelineno-1-22" name="__codelineno-1-22"></a><span class="w">        </span><span class="no">kubernetes.io/ingress.class: &quot;{{ kubeapps_k8s_ingress_class }}&quot;</span>
<a id="__codelineno-1-23" name="__codelineno-1-23"></a><span class="w">        </span><span class="no">traefik.frontend.passHostHeader: &quot;true&quot;</span>
<a id="__codelineno-1-24" name="__codelineno-1-24"></a><span class="w">        </span><span class="no">traefik.ingress.kubernetes.io/router.tls: &quot;true&quot;</span>
</code></pre></div></td></tr></table></div>
<blockquote>
<p><strong>Note</strong> On configure le ingress directement dans la définition helm tout en précisant bien que l'on utilise traefik en sachant que par défaut il est souvent utilisé <code>nginx</code> comme controller ingress</p>
</blockquote>
<p>Nous allons lancer la commande de templating grâce au module <code>template</code> de la collection <strong>builtin</strong> (fonctionnalités incluses par défaut) de ansible.</p>
<p>Celle ci va faire le remplacement des variables utilisées dans les moustaches <code>{{}}</code> et placer le fichier au bon endroit dans notre machine invité. Ici, il se trouvera dans notre container <code>node-0</code> dans le répertoire <code>/var/lib/rancher/k3s/server/manifests/kubeapps-chart-crd.yml</code></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/roles/kubeapps/tasks/main.yml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-2-23">23</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-2-24">24</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-23" name="__codelineno-2-23"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubeapps-chart-crd.yml</span>
<a id="__codelineno-2-24" name="__codelineno-2-24"></a><span class="w">      </span><span class="nt">deploy</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">kubeapps_namespace</span><span class="nv"> </span><span class="s">}}&quot;</span>
</code></pre></div></td></tr></table></div>
<p>Pour vérifier que les pods de kubeapps sont bien prêt :</p>
<ul>
<li>On regarde d'abord si la tâche <code>helm</code> a bien pu se finir</li>
</ul>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#1-9-ansible-kubeapps-__codelineno-3-1"></a>kubectl<span class="w"> </span>get<span class="w"> </span>po<span class="w"> </span>-n<span class="w"> </span>kube-sysem<span class="w"> </span>--watch
</code></pre></div>
Devrait donné au bout de quelque minutes : <code>helm-install-kubeapps-4cdf8</code> avec status <code>COMPLETED</code></p>
<h5 id="1-9-ansible-kubeapps-ensuite-connexion-a-dex-idp-pour-sauthentifier-avec-github">Ensuite connexion à dex Idp pour s'authentifier avec github<a class="headerlink" href="#1-9-ansible-kubeapps-ensuite-connexion-a-dex-idp-pour-sauthentifier-avec-github" title="Permanent link">&para;</a></h5>
<p>Pour ajouter la couche d'authentification kubeapps fait appel à la solution <a href="https://oauth2-proxy.github.io/oauth2-proxy/docs/configuration/oauth_provider#github-auth-provider">oauth2-proxy</a>. Il s'agit donc d'un reverse proxy qui redirige le trafic http d'un client à un serveur implémentant oauth2 avant de permettre la connexion à kubeapps.</p>
<p>Cette authentification est associée à un cookie converti en base64 à partir d'un secret que l'ont définie avec une commande simple : </p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#1-9-ansible-kubeapps-__codelineno-4-1"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;not-good-secret&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>base64
</code></pre></div>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/roles/kubeapps/defaults/main.yml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-5-30">30</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-5-31">31</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-5-32">32</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-30" name="__codelineno-5-30"></a><span class="c1"># ...</span>
<a id="__codelineno-5-31" name="__codelineno-5-31"></a><span class="c1"># Cookie secret</span>
<a id="__codelineno-5-32" name="__codelineno-5-32"></a><span class="nt">kubeapps_oauth_proxy_cookie_secret</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bm90LWdvb2Qtc2VjcmV0Cg==</span>
</code></pre></div></td></tr></table></div>
<p><code>--oidc-issuer-url</code> est obligatoire quand l'on n'utilise pas un fournisseur d'authentification pré-conçu comme github, gitlab, google, etc. Il faut donc le définir avec l'url de <code>dex</code> pour qu'il soit bien consommé par le client openid de oauth2-proxy.</p>
<blockquote>
<p>Note : Pour consulter la configuration d'open id vous pouvez ouvrir l'url <a href="https://dex.k3s.local/.well-known/openid-configuration">dex.k3s.local/.well-known/openid-configuration</a> dans votre navigateur.</p>
</blockquote>
<p>Ensuite on réutilise nos secrets de <strong>dex idp</strong> pour créer et configurer l'accès du container <code>authProxy</code> à open id dans le pod <code>frontend</code> de kubeapps.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/roles/kubeapps/templates/kubeapps-chart-crd.yml.j2</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-6-28">28</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-6-29">29</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-6-30">30</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-6-31">31</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-6-32">32</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-6-33">33</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-6-34">34</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-6-35">35</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-6-36">36</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-6-37">37</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-6-38">38</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-6-39">39</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-6-40">40</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-6-41">41</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-6-42">42</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-28" name="__codelineno-6-28"></a><span class="w">    </span><span class="nt">authProxy</span><span class="p">:</span>
<a id="__codelineno-6-29" name="__codelineno-6-29"></a><span class="w">      </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-6-30" name="__codelineno-6-30"></a><span class="w">      </span><span class="nt">provider</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">oidc</span>
<a id="__codelineno-6-31" name="__codelineno-6-31"></a><span class="w">      </span><span class="nt">clientID</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">dex_client_id</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-6-32" name="__codelineno-6-32"></a><span class="w">      </span><span class="nt">clientSecret</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">dex_client_secret</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-6-33" name="__codelineno-6-33"></a><span class="w">      </span><span class="nt">cookieSecret</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;{{</span><span class="nv"> </span><span class="s">kubeapps_oauth_proxy_cookie_secret</span><span class="nv"> </span><span class="s">}}&#39;</span>
<a id="__codelineno-6-34" name="__codelineno-6-34"></a><span class="w">      </span><span class="nt">cookieRefresh</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5m</span>
<a id="__codelineno-6-35" name="__codelineno-6-35"></a><span class="w">      </span><span class="nt">extraFlags</span><span class="p">:</span>
<a id="__codelineno-6-36" name="__codelineno-6-36"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">--oidc-issuer-url=https://{{ dex_hostname }}</span>
<a id="__codelineno-6-37" name="__codelineno-6-37"></a><span class="w">      </span><span class="nt">extraVolumeMounts</span><span class="p">:</span>
<a id="__codelineno-6-38" name="__codelineno-6-38"></a><span class="w">        </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">kubeapps_internal_acme_ca_extra_volumes_mounts | to_nice_yaml | indent(8)</span><span class="w"> </span><span class="p p-Indicator">}}</span>
<a id="__codelineno-6-39" name="__codelineno-6-39"></a>
<a id="__codelineno-6-40" name="__codelineno-6-40"></a><span class="w">    </span><span class="nt">frontend</span><span class="p">:</span>
<a id="__codelineno-6-41" name="__codelineno-6-41"></a><span class="w">      </span><span class="nt">extraVolumes</span><span class="p">:</span>
<a id="__codelineno-6-42" name="__codelineno-6-42"></a><span class="w">        </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">kubeapps_internal_acme_ca_extra_volumes | to_nice_yaml | indent(8)</span><span class="w"> </span><span class="p p-Indicator">}}</span>
</code></pre></div></td></tr></table></div>
<p>Enfin maintenant que notre chart est déployé avec un combo <strong>oauth-proxy</strong> / <strong>dex</strong> fonctionnel nous allons configurer le contrôle d'accès à l'administration du cluster. Nous utilisons pour cela une ressource <code>ClusterRoleBinding</code> pour lier un groupe d'une organisation github à un rôle <code>cluster-admin</code> qui lui donne tous les droits sur le cluster.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/roles/kubeapps/templates/kubeapps-chart-crd.yml.j2</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-7-1"> 1</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-7-2"> 2</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-7-3"> 3</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-7-4"> 4</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-7-5"> 5</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-7-6"> 6</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-7-7"> 7</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-7-8"> 8</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-7-9"> 9</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-7-10">10</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-7-11">11</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-7-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="nn">---</span>
<a id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1</span>
<a id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterRoleBinding</span>
<a id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-7-5" name="__codelineno-7-5"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubeapps-github-teams</span>
<a id="__codelineno-7-6" name="__codelineno-7-6"></a><span class="nt">roleRef</span><span class="p">:</span>
<a id="__codelineno-7-7" name="__codelineno-7-7"></a><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io</span>
<a id="__codelineno-7-8" name="__codelineno-7-8"></a><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterRole</span>
<a id="__codelineno-7-9" name="__codelineno-7-9"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cluster-admin</span>
<a id="__codelineno-7-10" name="__codelineno-7-10"></a><span class="nt">subjects</span><span class="p">:</span>
<a id="__codelineno-7-11" name="__codelineno-7-11"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Group</span>
<a id="__codelineno-7-12" name="__codelineno-7-12"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">dex_github_client_org</span><span class="nv"> </span><span class="s">}}:{{</span><span class="nv"> </span><span class="s">dex_github_client_team</span><span class="nv"> </span><span class="s">}}&quot;</span>
</code></pre></div></td></tr></table></div>
<p>Nous voilà prêt à tester notre déploiement de kubeapps. Nous allons donc lancer notre test molecule et attendre son exécution :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#1-9-ansible-kubeapps-__codelineno-8-1"></a>molecule<span class="w"> </span><span class="nb">test</span><span class="w"> </span>--destroy<span class="w"> </span>never
</code></pre></div>
<p>Une fois l'exécution terminée, il faut attendre quelques secondes pour que tous les pods soient bien prêts. On peut alors se connecter à l'interface web de kubeapps en se connectant à l'adresse <a href="https://kubeapps.k3s.local">https://kubeapps.k3s.local</a> et en utilisant notre compte github nous allons pouvoir nous connecter.</p>
<p>Voici la page de login attendue :</p>
<p><img alt="kubeapps" src="../images/kubeapps-auth.png" /></p>
<p>Et voici la page de dashboard de kubeapps une fois connecté :</p>
<p><img alt="kubeapps" src="../images/kubeapps-ready.png" /></p>
<h3 id="1-9-ansible-kubeapps-mise-en-place-des-tests-de-kubeapps">Mise en place des tests de kubeapps<a class="headerlink" href="#1-9-ansible-kubeapps-mise-en-place-des-tests-de-kubeapps" title="Permanent link">&para;</a></h3>
<p>Grâce au module ansible <a href="https://docs.ansible.com/ansible/latest/collections/kubernetes/core/k8s_info_module.html">k8s info</a> on teste les pods centraux de kubeapps. Si ces pod sont bien en état <code>ready</code>, c'est que kubeapps est prêt</p>
<blockquote>
<p>On note qu'il est important de préciser à <code>k8s_info</code> la localisation kubeconfig qui se trouve à un endroit un peu exotique avec k3s. Cette config comporte des informations utilisateur et des certificats permettant de se connecter sur le cluster.</p>
</blockquote>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/roles/kubeapps/molecule/default/verify.yml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-9-18">18</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-9-19">19</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-9-20">20</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-9-21">21</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-9-22">22</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-9-23">23</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-9-24">24</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-9-25">25</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-9-26">26</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-9-27">27</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-9-28">28</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-9-29">29</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-9-30">30</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-9-31">31</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-9-32">32</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-9-33">33</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-9-34">34</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-9-35">35</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-9-36">36</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-9-37">37</a></span>
<span class="normal"><a href="#1-9-ansible-kubeapps-__codelineno-9-38">38</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-9-18" name="__codelineno-9-18"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Get Kubeapps service infos</span>
<a id="__codelineno-9-19" name="__codelineno-9-19"></a><span class="w">      </span><span class="nt">kubernetes.core.k8s_info</span><span class="p">:</span>
<a id="__codelineno-9-20" name="__codelineno-9-20"></a><span class="w">        </span><span class="nt">api_version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id="__codelineno-9-21" name="__codelineno-9-21"></a><span class="w">        </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<a id="__codelineno-9-22" name="__codelineno-9-22"></a><span class="w">        </span><span class="nt">label_selectors</span><span class="p">:</span>
<a id="__codelineno-9-23" name="__codelineno-9-23"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app.kubernetes.io/component = frontend</span>
<a id="__codelineno-9-24" name="__codelineno-9-24"></a><span class="w">        </span><span class="nt">kubeconfig</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/rancher/k3s/k3s.yaml</span>
<a id="__codelineno-9-25" name="__codelineno-9-25"></a><span class="w">        </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubeapps</span>
<a id="__codelineno-9-26" name="__codelineno-9-26"></a><span class="w">      </span><span class="nt">register</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubeapps_infos</span>
<a id="__codelineno-9-27" name="__codelineno-9-27"></a>
<a id="__codelineno-9-28" name="__codelineno-9-28"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">ansible.builtin.set_fact</span><span class="p">:</span>
<a id="__codelineno-9-29" name="__codelineno-9-29"></a><span class="w">        </span><span class="nt">containers_statuses</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">(kubeapps_infos.resources</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">last).status.containerStatuses</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-9-30" name="__codelineno-9-30"></a>
<a id="__codelineno-9-31" name="__codelineno-9-31"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">ansible.builtin.debug</span><span class="p">:</span>
<a id="__codelineno-9-32" name="__codelineno-9-32"></a><span class="w">        </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">containers_statuses</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">map(attribute=&#39;name&#39;)</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-9-33" name="__codelineno-9-33"></a>
<a id="__codelineno-9-34" name="__codelineno-9-34"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Assertions on service kubeapps</span><span class="w"> </span>
<a id="__codelineno-9-35" name="__codelineno-9-35"></a><span class="w">      </span><span class="nt">assert</span><span class="p">:</span>
<a id="__codelineno-9-36" name="__codelineno-9-36"></a><span class="w">        </span><span class="nt">that</span><span class="p">:</span>
<a id="__codelineno-9-37" name="__codelineno-9-37"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubeapps_infos.resources | length &gt; 0</span>
<a id="__codelineno-9-38" name="__codelineno-9-38"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">containers_statuses | selectattr(&#39;ready&#39;, &#39;equalto&#39;, true) | list | count == 2</span>
</code></pre></div></td></tr></table></div>
<p>Si votre playbook est déjà passé en entier un <code>molecule verify</code> va suffire pour jouer le playbook <code>verify.yml</code>.</p>
<p>Vous devriez voir passer les assertions et les autres tâches.</p>
<p>Pour autant vous ne verrez pas encore de retour de ce type tout simplement par ce que le code n'est pas complet.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#1-9-ansible-kubeapps-__codelineno-10-1"></a>node-0                     : ok=15 ...
</code></pre></div>
<hr /></section><section class="print-page" id="2-packer-playbook"><h1 id="2-packer-playbook-2-utilisation-de-notre-role-dans-packer">2. Utilisation de notre rôle dans packer<a class="headerlink" href="#2-packer-playbook-2-utilisation-de-notre-role-dans-packer" title="Permanent link">&para;</a></h1>
<hr />
<p>On va ici pré-provisionner une machine virtuelle dans une image azure ARM. On utilisera un playbook appelant le rôle kubeapps sans installer les pods qui ont besoin du réseau externe pour fonctionner. (cert-manager, dex et kubeapps)</p>
<h4 id="2-packer-playbook-playbook-et-inventaire-final">Playbook et inventaire final<a class="headerlink" href="#2-packer-playbook-playbook-et-inventaire-final" title="Permanent link">&para;</a></h4>
<p>Nous allons adapter le rôle en vue de cette fois ci le rendre utilisable par un playbook de préproduction.</p>
<p>Nous allons créer le fichier <code>site.yaml</code> (dans le dossier <code>playbook/</code>) qui va se charger avec la commande <code>ansible-playbook</code> de lancer les rôles dans le bon ordre sur les machines.</p>
<p>Cette étape servira pour utiliser le playbook dans la <a href="#2-packer-playbook-2-créer-une-première-image-virtuelle-pour-le-test">partie 2</a> avec packer</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/site.yaml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#2-packer-playbook-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-0-2">2</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-0-3">3</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-0-4">4</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-0-5">5</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-0-6">6</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-0-7">7</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-0-8">8</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-0-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nn">---</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">all</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">  </span><span class="nt">gather_facts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">True</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">  </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">True</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">  </span><span class="nt">pre_tasks</span><span class="p">:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">include_tasks</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">roles/kubeapps/tasks/pre-import-cert.yml</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">      </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cert_manager_is_internal</span><span class="w">  </span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">  </span><span class="nt">roles</span><span class="p">:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">role</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">roles/kubeapps</span>
</code></pre></div></td></tr></table></div>
<blockquote>
<p><code>include_tasks..</code> : comme pour le playbook converge dans les tests on doit importer un certificat pour faire confiance à un Lets-encrypt de test.</p>
</blockquote>
<p>Ensuite on crée notre inventaire pour azure dans un dossier <code>playbook/inventories/azure/</code>. Un inventaire ansible est constitué d'un groupe de variables (dossier <code>group_vars</code>) et d'un fichier <code>hosts</code> qui va contenir les machines sur lesquelles on va jouer le playbook.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#2-packer-playbook-__codelineno-1-1"></a>mkdir<span class="w"> </span>-p<span class="w"> </span>playbook/inventories/azure/group_vars
</code></pre></div>
<p>Ces variables de groupes font appel à un plugin <code>lookup</code> permettant de lire les secrets d'une ressource keyvault que l'on configurera dans la partie terraform.</p>
<p>On peut ajouter l'installation de la collection dans les requirements du playbook si ce n'est pas déjà fait.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/inventories/azure/group_vars/all.yml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#2-packer-playbook-__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-2-10">10</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-2-11">11</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-2-12">12</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-2-13">13</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-2-14">14</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-2-15">15</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-2-16">16</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-2-17">17</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-2-18">18</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-2-19">19</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-2-20">20</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-2-21">21</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-2-22">22</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-2-23">23</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-2-24">24</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-2-25">25</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-2-26">26</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-2-27">27</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-2-28">28</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-2-29">29</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-2-30">30</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-2-31">31</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-2-32">32</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-2-33">33</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="nn">---</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="nt">cert_manager_email</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">lookup(</span>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="w">  </span><span class="s">&#39;azure.azcollection.azure_keyvault_secret&#39;,</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="w">  </span><span class="s">&#39;cert-manager-email&#39;,</span>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="w">  </span><span class="s">vault_url=vault_url</span>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="w">  </span><span class="s">)</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="nt">dex_client_id</span><span class="p">:</span><span class="w">  </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">lookup(</span>
<a id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="w">  </span><span class="s">&#39;azure.azcollection.azure_keyvault_secret&#39;,</span>
<a id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="w">  </span><span class="s">&#39;dex-client-id&#39;,</span>
<a id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="w">  </span><span class="s">vault_url=vault_url</span>
<a id="__codelineno-2-12" name="__codelineno-2-12"></a><span class="w">  </span><span class="s">)</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="nt">dex_client_secret</span><span class="p">:</span><span class="w">  </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">lookup(</span>
<a id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="w">  </span><span class="s">&#39;azure.azcollection.azure_keyvault_secret&#39;,</span>
<a id="__codelineno-2-15" name="__codelineno-2-15"></a><span class="w">  </span><span class="s">&#39;dex-client-secret&#39;,</span>
<a id="__codelineno-2-16" name="__codelineno-2-16"></a><span class="w">  </span><span class="s">vault_url=vault_url</span>
<a id="__codelineno-2-17" name="__codelineno-2-17"></a><span class="w">  </span><span class="s">)</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-2-18" name="__codelineno-2-18"></a><span class="nt">dex_github_client_id</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">lookup(</span>
<a id="__codelineno-2-19" name="__codelineno-2-19"></a><span class="w">  </span><span class="s">&#39;azure.azcollection.azure_keyvault_secret&#39;,</span>
<a id="__codelineno-2-20" name="__codelineno-2-20"></a><span class="w">  </span><span class="s">&#39;dex-github-client-id&#39;,</span>
<a id="__codelineno-2-21" name="__codelineno-2-21"></a><span class="w">  </span><span class="s">vault_url=vault_url</span>
<a id="__codelineno-2-22" name="__codelineno-2-22"></a><span class="w">  </span><span class="s">)</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-2-23" name="__codelineno-2-23"></a><span class="nt">dex_github_client_secret</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">lookup(</span>
<a id="__codelineno-2-24" name="__codelineno-2-24"></a><span class="w">  </span><span class="s">&#39;azure.azcollection.azure_keyvault_secret&#39;,</span>
<a id="__codelineno-2-25" name="__codelineno-2-25"></a><span class="w">  </span><span class="s">&#39;dex-github-client-secret&#39;,</span>
<a id="__codelineno-2-26" name="__codelineno-2-26"></a><span class="w">  </span><span class="s">vault_url=vault_url</span>
<a id="__codelineno-2-27" name="__codelineno-2-27"></a><span class="w">  </span><span class="s">)</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-2-28" name="__codelineno-2-28"></a>
<a id="__codelineno-2-29" name="__codelineno-2-29"></a><span class="nt">kubeapps_oauth_proxy_cookie_secret</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">lookup(</span>
<a id="__codelineno-2-30" name="__codelineno-2-30"></a><span class="w">  </span><span class="s">&#39;azure.azcollection.azure_keyvault_secret&#39;,</span>
<a id="__codelineno-2-31" name="__codelineno-2-31"></a><span class="w">  </span><span class="s">&#39;kubeapps-oauth-proxy-cookie-secret&#39;,</span>
<a id="__codelineno-2-32" name="__codelineno-2-32"></a><span class="w">  </span><span class="s">vault_url=vault_url</span>
<a id="__codelineno-2-33" name="__codelineno-2-33"></a><span class="w">  </span><span class="s">)</span><span class="nv"> </span><span class="s">}}&quot;</span>
</code></pre></div></td></tr></table></div>
<blockquote>
<p><strong>Note</strong> Nous n'aurons pas besoin d'utiliser les variables de connexion du plugin. Comme nous serons sur une machine azure, celle-ci aura les habilitations requises pour accéder directement aux secrets.</p>
</blockquote>
<p>Puis on définit un fichier <code>hosts</code> pointant directement sur localhost. </p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/inventories/azure/hosts</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#2-packer-playbook-__codelineno-3-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="na">127.0.0.1</span>
</code></pre></div></td></tr></table></div>
<p>Nous allons rester sur localhost avec un provision sur la machine même dans les prochaines étapes packer et terraform.</p>
<h2 id="2-packer-playbook-build-packer">Build packer<a class="headerlink" href="#2-packer-playbook-build-packer" title="Permanent link">&para;</a></h2>
<p>Maintenant que nous savons que notre playbook est fonctionnel nous allons l'intégrer dans la chaine de création de notre image.
Nous passerons donc par l'outil packer de hashicorp une des références dans les infrastructures cloud moderne.</p>
<p>L'objectif est d'utiliser les installations précédentes sur une distribution linux générique pour la rendre prête à l'emploi.</p>
<p>Voici comment le flux de création d'une VM avec packer s'organise :</p>
<ol>
<li>
<p>Validation et parsing d'une <strong>configuration</strong> <a href="https://github.com/hashicorp/hcl">HCL</a></p>
</li>
<li>
<p>Lancement d'un plugin <strong>builder</strong> en fonction de notre infrastructure. Par exemple on peut build des images docker, virtualbox mais aussi des images dédiées à des clouds comme Azure (celui que nous avons choisi).</p>
</li>
<li>
<p>Le plugin créer, initialise les composants système majeurs de la machine puis démarre automatiquement la machine.</p>
</li>
<li>
<p>Une fois la machine prête un système de <strong>communicator</strong> est disponible et nous pouvons lancer des commandes sur celle-ci. Nous utiliserons evidemment SSH.</p>
</li>
<li>
<p>Des <strong>provisionners</strong> sont ensuite joués pour configurer la machine. Nous utiliserons à cette étape le plugin ansible qui va nous permettre d'utiliser le travail précédent.</p>
</li>
<li>
<p>Enfin des <strong>post processors</strong> vont effectuer des traitements après le build une fois l'Iso rendu. Par exemple nous pourrons upload <strong>l'artifact</strong> sur un registre comme <a href="https://cloud.hashicorp.com/products/packer">HCP</a> ou sur un service comme <a href="https://learn.microsoft.com/fr-fr/azure/azure-resource-manager/management/overview">Azure resource manager</a></p>
</li>
</ol>
<h3 id="2-packer-playbook-a-sources">A. Sources<a class="headerlink" href="#2-packer-playbook-a-sources" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://www.packer.io/docs">packer docs</a></li>
<li><a href="https://www.packer.io/guides/packer-on-cicd/pipelineing-builds">packer on ci</a></li>
<li><a href="https://www.packer.io/plugins/builders/azure#authentication-for-azure">authentication</a></li>
<li><a href="https://www.packer.io/plugins/builders/azure/arm">Arm</a></li>
</ul>
<h3 id="2-packer-playbook-installation">Installation<a class="headerlink" href="#2-packer-playbook-installation" title="Permanent link">&para;</a></h3>
<p>Pour installer packer <a href="https://www.packer.io/downloads">c'est ici</a></p>
<blockquote>
<p><strong>Note</strong>: recommandation : extension <code>szTheory.vscode-packer-powertools</code> (elle contient un bon formateur de fichier HCL), <code>hashicorp.hcl</code>.</p>
</blockquote>
<p>Vérifier que packer 1.8+ est bien installé dans votre ligne de commande :
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#2-packer-playbook-__codelineno-4-1"></a>packer<span class="w"> </span>--version
</code></pre></div></p>
<p>Puis nous avons besoin de la ligne commande de azure pour créer notre service principal. Pour cela il faut installer le <a href="https://docs.microsoft.com/fr-fr/cli/azure/install-azure-cli">CLI azure</a></p>
<p>Connectez-vous avec <strong><code>az login</code></strong> à votre compte azure.</p>
<blockquote>
<p><strong>Note</strong> Vous devez avoir un abonnement azure avec du crédit disponible. (exemple : essai de 200$ offert)</p>
</blockquote>
<h5 id="2-packer-playbook-puis-creer-le-groupe-de-ressources-dans-lequel-on-va-creer-tout-nos-composants-azure">Puis créer le <code>groupe de ressources</code> dans lequel on va créer tout nos composants azure :<a class="headerlink" href="#2-packer-playbook-puis-creer-le-groupe-de-ressources-dans-lequel-on-va-creer-tout-nos-composants-azure" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#2-packer-playbook-__codelineno-5-1"></a>az<span class="w"> </span>group<span class="w"> </span>create<span class="w"> </span>--name<span class="w"> </span>kubeapps-group<span class="w"> </span>--location<span class="w"> </span>westeurope
</code></pre></div>
<h3 id="2-packer-playbook-b-initialisez-un-projet-packer">B. Initialisez un projet packer<a class="headerlink" href="#2-packer-playbook-b-initialisez-un-projet-packer" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#2-packer-playbook-__codelineno-6-1"></a>mkdir<span class="w"> </span>infra/
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#2-packer-playbook-__codelineno-6-2"></a><span class="nb">cd</span><span class="w"> </span>infra
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#2-packer-playbook-__codelineno-6-3"></a>touch<span class="w"> </span>vars.json
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#2-packer-playbook-__codelineno-6-4"></a>touch<span class="w"> </span>ubuntu.pkr.hcl
</code></pre></div>
<p>Ajouter ce gitignore recommandé dans le dossier <code>infra/</code></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#2-packer-playbook-__codelineno-7-1"></a>curl<span class="w"> </span>-L<span class="w"> </span>https://github.com/github/gitignore/raw/main/Packer.gitignore<span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>.gitignore
</code></pre></div>
<p>Les variables de configuration et leurs valeurs par défaut :</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">infra/ubuntu.pkr.hcl</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#2-packer-playbook-__codelineno-8-1"> 1</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-8-2"> 2</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-8-3"> 3</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-8-4"> 4</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-8-5"> 5</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-8-6"> 6</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-8-7"> 7</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-8-8"> 8</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-8-9"> 9</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-8-10">10</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-8-11">11</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-8-12">12</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-8-13">13</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-8-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a>variable &quot;resource_group_name&quot; {
<a id="__codelineno-8-2" name="__codelineno-8-2"></a>  type    = string
<a id="__codelineno-8-3" name="__codelineno-8-3"></a>  default = &quot;kubeapps-group&quot;
<a id="__codelineno-8-4" name="__codelineno-8-4"></a>}
<a id="__codelineno-8-5" name="__codelineno-8-5"></a>
<a id="__codelineno-8-6" name="__codelineno-8-6"></a>variable &quot;image_sku&quot; {
<a id="__codelineno-8-7" name="__codelineno-8-7"></a>  type    = string
<a id="__codelineno-8-8" name="__codelineno-8-8"></a>  default = &quot;20_04-daily-lts-gen2&quot;
<a id="__codelineno-8-9" name="__codelineno-8-9"></a>}
<a id="__codelineno-8-10" name="__codelineno-8-10"></a>
<a id="__codelineno-8-11" name="__codelineno-8-11"></a>variable &quot;vm_size&quot; {
<a id="__codelineno-8-12" name="__codelineno-8-12"></a>  type    = string
<a id="__codelineno-8-13" name="__codelineno-8-13"></a>  default = &quot;Standard_D2s_v3&quot;
<a id="__codelineno-8-14" name="__codelineno-8-14"></a>}
</code></pre></div></td></tr></table></div>
<blockquote>
<p>Note: le fichier <code>vars.json</code> sert à passer de nouvelles valeurs pour ces variables avec <code>packer build -var-file=vars.json ubuntu.pkr.hcl</code></p>
</blockquote>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">infra/ubuntu.pkr.hcl</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#2-packer-playbook-__codelineno-9-16">16</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-9-17">17</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-9-18">18</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-9-19">19</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-9-20">20</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-9-21">21</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-9-22">22</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-9-23">23</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-9-24">24</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-9-25">25</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-9-26">26</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-9-27">27</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-9-28">28</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-9-29">29</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-9-16" name="__codelineno-9-16"></a>source &quot;azure-arm&quot; &quot;vm&quot; {
<a id="__codelineno-9-17" name="__codelineno-9-17"></a>  use_azure_cli_auth = true
<a id="__codelineno-9-18" name="__codelineno-9-18"></a>
<a id="__codelineno-9-19" name="__codelineno-9-19"></a>  managed_image_name                = &quot;k3s-pre-paas-az-arm&quot;
<a id="__codelineno-9-20" name="__codelineno-9-20"></a>  managed_image_resource_group_name = var.resource_group_name
<a id="__codelineno-9-21" name="__codelineno-9-21"></a>  build_resource_group_name         = var.resource_group_name
<a id="__codelineno-9-22" name="__codelineno-9-22"></a>  os_type                           = &quot;Linux&quot;
<a id="__codelineno-9-23" name="__codelineno-9-23"></a>  image_publisher                   = &quot;Canonical&quot;
<a id="__codelineno-9-24" name="__codelineno-9-24"></a>  image_offer                       = &quot;0001-com-ubuntu-server-focal-daily&quot;
<a id="__codelineno-9-25" name="__codelineno-9-25"></a>  image_sku                         = var.image_sku
<a id="__codelineno-9-26" name="__codelineno-9-26"></a>
<a id="__codelineno-9-27" name="__codelineno-9-27"></a>  vm_size      = var.vm_size
<a id="__codelineno-9-28" name="__codelineno-9-28"></a>  communicator = &quot;ssh&quot;
<a id="__codelineno-9-29" name="__codelineno-9-29"></a>}
</code></pre></div></td></tr></table></div>
<p>Lors du processus de build packer, <strong>nous ne sommes pas accessible sur internet</strong> ce qui rend impossible l'installation de certificats letsencrypt avec cert-manager. Nous allons donc désactiver l'installation de kubeapps durant le build pour plutôt la lancer avec un script de démarrage qui relancera simplement le playbook avec le tag <code>kubeapps</code>.</p>
<p>Ensuite, on utilise le provisionner ansible qui va installer notre playbook sur la machine azure :</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">infra/ubuntu.pkr.hcl</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#2-packer-playbook-__codelineno-10-31">31</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-10-32">32</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-10-33">33</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-10-34">34</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-10-35">35</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-10-36">36</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-10-37">37</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-10-38">38</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-10-39">39</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-10-40">40</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-10-41">41</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-10-42">42</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-10-43">43</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-10-44">44</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-10-45">45</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-10-46">46</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-10-47">47</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-10-48">48</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-10-49">49</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-10-50">50</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-10-51">51</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-10-52">52</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-10-53">53</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-10-54">54</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-10-55">55</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-10-56">56</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-10-57">57</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-10-58">58</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-10-59">59</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-10-60">60</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-10-61">61</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-10-62">62</a></span>
<span class="normal"><a href="#2-packer-playbook-__codelineno-10-63">63</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-10-31" name="__codelineno-10-31"></a>build {
<a id="__codelineno-10-32" name="__codelineno-10-32"></a>
<a id="__codelineno-10-33" name="__codelineno-10-33"></a>  sources = [&quot;sources.azure-arm.vm&quot;]
<a id="__codelineno-10-34" name="__codelineno-10-34"></a>
<a id="__codelineno-10-35" name="__codelineno-10-35"></a>  provisioner &quot;shell&quot; {
<a id="__codelineno-10-36" name="__codelineno-10-36"></a>    inline = [
<a id="__codelineno-10-37" name="__codelineno-10-37"></a>      &quot;curl https://bootstrap.pypa.io/get-pip.py -o /tmp/get-pip.py&quot;,
<a id="__codelineno-10-38" name="__codelineno-10-38"></a>      &quot;sudo python3 /tmp/get-pip.py&quot;,
<a id="__codelineno-10-39" name="__codelineno-10-39"></a>      &quot;sudo pip3 install --ignore-installed ansible==6.5.0 pyyaml openshift kubernetes&quot;,
<a id="__codelineno-10-40" name="__codelineno-10-40"></a>      &quot;sudo mkdir /playbook &amp;&amp; sudo chown -R packer:packer /playbook&quot;,
<a id="__codelineno-10-41" name="__codelineno-10-41"></a>    ]
<a id="__codelineno-10-42" name="__codelineno-10-42"></a>  }
<a id="__codelineno-10-43" name="__codelineno-10-43"></a>
<a id="__codelineno-10-44" name="__codelineno-10-44"></a>  provisioner &quot;ansible-local&quot; {
<a id="__codelineno-10-45" name="__codelineno-10-45"></a>    command       = &quot;sudo ansible-playbook&quot;
<a id="__codelineno-10-46" name="__codelineno-10-46"></a>    playbook_file = &quot;../playbook/site.yaml&quot;
<a id="__codelineno-10-47" name="__codelineno-10-47"></a>    playbook_dir  = &quot;../playbook/&quot;
<a id="__codelineno-10-48" name="__codelineno-10-48"></a>    extra_arguments = [&quot;--skip-tags kubeapps&quot;]
<a id="__codelineno-10-49" name="__codelineno-10-49"></a>    galaxy_file             = &quot;../playbook/requirements.yaml&quot;
<a id="__codelineno-10-50" name="__codelineno-10-50"></a>    galaxy_command          = &quot;sudo ansible-galaxy&quot;
<a id="__codelineno-10-51" name="__codelineno-10-51"></a>    galaxy_roles_path       = &quot;/usr/share/ansible/roles&quot;
<a id="__codelineno-10-52" name="__codelineno-10-52"></a>    galaxy_collections_path = &quot;/usr/share/ansible/collections&quot;
<a id="__codelineno-10-53" name="__codelineno-10-53"></a>    staging_directory       = &quot;/playbook/&quot;
<a id="__codelineno-10-54" name="__codelineno-10-54"></a>  }
<a id="__codelineno-10-55" name="__codelineno-10-55"></a>
<a id="__codelineno-10-56" name="__codelineno-10-56"></a>  provisioner &quot;shell&quot; {
<a id="__codelineno-10-57" name="__codelineno-10-57"></a>    execute_command = &quot;chmod +x {{ .Path }}; {{ .Vars }} sudo -E sh &#39;{{ .Path }}&#39;&quot;
<a id="__codelineno-10-58" name="__codelineno-10-58"></a>    inline = [
<a id="__codelineno-10-59" name="__codelineno-10-59"></a>      &quot;/usr/sbin/waagent -force -deprovision+user &amp;&amp; export HISTSIZE=0 &amp;&amp; sync&quot;
<a id="__codelineno-10-60" name="__codelineno-10-60"></a>    ]
<a id="__codelineno-10-61" name="__codelineno-10-61"></a>    inline_shebang = &quot;/bin/sh -x&quot;
<a id="__codelineno-10-62" name="__codelineno-10-62"></a>  }
<a id="__codelineno-10-63" name="__codelineno-10-63"></a>}
</code></pre></div></td></tr></table></div>
<blockquote>
<p><strong>Note</strong>: le provisionner shell est nécessaire pour nettoyer l'agent azure qui est installé par défaut sur les images automatiquement générées par ce cloud.</p>
</blockquote>
<p>Toujours dans <code>infra/</code>, on lance le traitement entier avec packer :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#2-packer-playbook-__codelineno-11-1"></a>packer<span class="w"> </span>build<span class="w"> </span>ubuntu.pkr.hcl
</code></pre></div>
<p>Vous pourrez voir le résultat de la création de l'image dans le portail azure dans votre groupe de ressource <code>kubeapps-group</code>.</p>
<hr /></section><section class="print-page" id="3-1-terraform-azure-init"><h1 id="3-1-terraform-azure-init-31-initialisation-du-deploiement-final-sur-azure-avec-terraform">3.1 Initialisation du déploiement final sur Azure avec Terraform<a class="headerlink" href="#3-1-terraform-azure-init-31-initialisation-du-deploiement-final-sur-azure-avec-terraform" title="Permanent link">&para;</a></h1>
<hr />
<p>Ici nous mettons en place le déploiement final sur Azure avec  l'outil d'infrastructure as code Terraform.</p>
<h3 id="3-1-terraform-azure-init-obtenir-un-nom-de-domaine-gratuit-etudiants">Obtenir un nom de domaine gratuit (étudiants)<a class="headerlink" href="#3-1-terraform-azure-init-obtenir-un-nom-de-domaine-gratuit-etudiants" title="Permanent link">&para;</a></h3>
<blockquote>
<p><strong>Warning</strong> Cette étape intermédiaire est indispensable pour la suite du tutoriel.</p>
</blockquote>
<p>Allez sur <a href="https://education.github.com/">https://education.github.com/</a> et valider votre compte étudiant. Normalement votre email étudiant devrait être reconnu très facilement.</p>
<p>Après nous allons utiliser des noms de domaines offert par <strong>name.com</strong> :</p>
<ul>
<li>
<p>Allez à <a href="https://education.github.com/pack/offers#namecom">https://education.github.com/pack/offers#namecom</a></p>
</li>
<li>
<p>Veillez bien à ne pas être connecté à <code>name.com</code> dans le cas où vous seriez déjà inscrit</p>
</li>
<li>
<p>Cliquer Get access by connecting your GitHub account on Name.com et accepter les droits demandés par l'application sur github.</p>
</li>
<li>
<p>Connectez vous à github en cliquant sur le bouton qui devrait être au milieu de la page.</p>
</li>
<li>
<p>Dans <strong>domains</strong> chercher un domaine en <code>.live</code> de votre choix (par exemple <code>paas-tutorial-lesgi.live</code>)</p>
</li>
<li>
<p>Ensuite ajoutez le au panier et aller à checkout en cliquant à nouveau. <a href="https://www.name.com/account/checkout"><code>Panier &gt; Checkout</code></a> Le code promo est censé être appliqué automatiquement grâce à la connexion à Github.</p>
</li>
<li>
<p>Ensuite poursuivez en vous inscrivant à name.com et validez votre email puis valider l'achat qui ne doit rien vous couter si la manipulation à a été faite correctement.</p>
</li>
</ul>
<h2 id="3-1-terraform-azure-init-lancement-de-la-vm-avec-terraform">Lancement de la VM avec Terraform<a class="headerlink" href="#3-1-terraform-azure-init-lancement-de-la-vm-avec-terraform" title="Permanent link">&para;</a></h2>
<p>Introduction sur terraform <a href="https://www.terraform.io/intro/index.html">doc</a></p>
<p>Cet Outil de codage déclaratif ou d'<strong>IaC</strong> (infrastructure as code), Terraform permet d'utiliser un langage de configuration appelé HCL (HashiCorp Configuration Langage) à la place de l'API d'un fournisseur de cloud. On peut ainsi décrire l'infrastructure cloud de manière déclarative et automatisée avec une seule simple ligne de commande. Terraform génère ensuite un plan permettant d'atteindre un état final de l'infrastructure et exécute le plan pour mettre à disposition l'infrastructure.</p>
<p>Terraform permet de faire des infrastructures immuables que l'on peut versionner, partager, installer et détruire à la demande.
Il ne se limite pas seulement à ça, mais à toutes les automatisations mises à disposition par des produits autour du cloud.</p>
<p>https://learn.microsoft.com/en-us/azure/virtual-machines/custom-data</p>
<p><strong>Toujours dans le dossier <code>infra/</code> :</strong></p>
<p>Pour commencer ajouter ce gitignore dans le dossier <code>infra/</code> pour éviter le déchet :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#3-1-terraform-azure-init-__codelineno-0-1"></a>curl<span class="w"> </span>-L<span class="w"> </span>https://github.com/github/gitignore/raw/main/Terraform.gitignore<span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span>.gitignore
</code></pre></div>
<blockquote>
<p><code>-a</code> comme append, on ajoute à la fin du fichier et on n'écrase pas l'existant.</p>
</blockquote>
<h3 id="3-1-terraform-azure-init-nomenclature-de-terraform">Nomenclature de terraform :<a class="headerlink" href="#3-1-terraform-azure-init-nomenclature-de-terraform" title="Permanent link">&para;</a></h3>
<p>Un block <code>data</code> dans un fichier de configuration terraform <code>tf</code> sert à importer des données existantes sur la plateforme.</p>
<p>Un block <code>resource</code> dans un fichier de configuration terraform <code>tf</code> sert à créer des ressources sur la plateforme.</p>
<p>Un block <code>locals</code> dans un fichier de configuration terraform <code>tf</code> sert à définir des variables locales.</p>
<p>Un block <code>provider</code> dans un fichier de configuration terraform <code>tf</code> sert à définir le provider de cloud.</p>
<p>Il existe aussi <code>variable</code> et <code>output</code> qui servent à définir des variables d'entrée et de sortie.</p>
<h3 id="3-1-terraform-azure-init-organisation-des-fichiers-du-dossier-infra">Organisation des fichiers du dossier <code>infra/</code><a class="headerlink" href="#3-1-terraform-azure-init-organisation-des-fichiers-du-dossier-infra" title="Permanent link">&para;</a></h3>
<ol>
<li>Les providers</li>
</ol>
<p>Premièrement, nous allons créer un fichier <code>terraform.tf</code> qui va se charger de définir les ressources terraform de notre infrastructure. On va passer par plusieurs plateformes différentes :</p>
<ul>
<li>
<p><strong><code>github</code></strong> pour définir les équipes accèdant à kubeapps en controlant une organisation github.</p>
</li>
<li>
<p><strong><code>azurerm</code></strong> pour contrôler l'intégralité des ressources azure que l'on peut consulter dans le portail.</p>
</li>
<li>
<p><strong><code>namedotcom</code></strong> pour contrôler les zones du domaine que l'on a obtenu précédemment.</p>
</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">infra/terraform.tf</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-1-10">10</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-1-11">11</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-1-12">12</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-1-13">13</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-1-14">14</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-1-15">15</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-1-16">16</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-1-17">17</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-1-18">18</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-1-19">19</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-1-20">20</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-1-21">21</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-1-22">22</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-1-23">23</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-1-24">24</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-1-25">25</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-1-26">26</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-1-27">27</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-1-28">28</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-1-29">29</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-1-30">30</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-1-31">31</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-1-32">32</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-1-33">33</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-1-34">34</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-1-35">35</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-1-36">36</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-1-37">37</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-1-38">38</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-1-39">39</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-1-40">40</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-1-41">41</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-1-42">42</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="nb">terraform</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="w">  </span><span class="na">required_version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&gt;=0.12&quot;</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">  </span><span class="nb">required_providers</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="w">    </span><span class="nb">azurerm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="w">      </span><span class="na">source</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;hashicorp/azurerm&quot;</span>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="w">      </span><span class="na">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;~&gt;3.37&quot;</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="w">    </span><span class="nb">github</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="w">      </span><span class="na">source</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;integrations/github&quot;</span>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">      </span><span class="na">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;~&gt; 5.0&quot;</span>
<a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="w">    </span><span class="nb">namedotcom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="w">      </span><span class="na">source</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;lexfrei/namedotcom&quot;</span>
<a id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="w">      </span><span class="na">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;1.2.0&quot;</span>
<a id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="w">    </span><span class="nb">time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-19" name="__codelineno-1-19"></a><span class="w">      </span><span class="na">source</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;hashicorp/time&quot;</span>
<a id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="w">      </span><span class="na">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;0.9.1&quot;</span>
<a id="__codelineno-1-21" name="__codelineno-1-21"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-22" name="__codelineno-1-22"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-1-23" name="__codelineno-1-23"></a><span class="p">}</span>
<a id="__codelineno-1-24" name="__codelineno-1-24"></a>
<a id="__codelineno-1-25" name="__codelineno-1-25"></a><span class="kr">provider</span><span class="w"> </span><span class="nv">&quot;github&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-26" name="__codelineno-1-26"></a><span class="w">  </span><span class="na">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.github_token</span>
<a id="__codelineno-1-27" name="__codelineno-1-27"></a><span class="w">  </span><span class="na">owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.github_organization</span>
<a id="__codelineno-1-28" name="__codelineno-1-28"></a><span class="p">}</span>
<a id="__codelineno-1-29" name="__codelineno-1-29"></a>
<a id="__codelineno-1-30" name="__codelineno-1-30"></a><span class="kr">provider</span><span class="w"> </span><span class="nv">&quot;namedotcom&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-31" name="__codelineno-1-31"></a><span class="w">  </span><span class="na">token</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nv">var.namedotcom_token</span>
<a id="__codelineno-1-32" name="__codelineno-1-32"></a><span class="w">  </span><span class="na">username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.namedotcom_username</span>
<a id="__codelineno-1-33" name="__codelineno-1-33"></a><span class="p">}</span>
<a id="__codelineno-1-34" name="__codelineno-1-34"></a>
<a id="__codelineno-1-35" name="__codelineno-1-35"></a><span class="kr">provider</span><span class="w"> </span><span class="nv">&quot;azurerm&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-36" name="__codelineno-1-36"></a><span class="w">  </span><span class="nb">features</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-37" name="__codelineno-1-37"></a><span class="w">    </span><span class="nb">key_vault</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-38" name="__codelineno-1-38"></a><span class="w">      </span><span class="na">purge_soft_delete_on_destroy</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<a id="__codelineno-1-39" name="__codelineno-1-39"></a><span class="w">      </span><span class="na">recover_soft_deleted_key_vaults</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<a id="__codelineno-1-40" name="__codelineno-1-40"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-41" name="__codelineno-1-41"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-1-42" name="__codelineno-1-42"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<blockquote>
<p>Comme nous nous sommes connecté avec <code>az login</code> auparavant, aucuns identifiants n'est requis pour faire fonctionner le provider azurerm.
<strong>Warning</strong> Vérifiez bien toutefois que votre tenant par défaut soit bien celui de votre abonnement avec du crédit. Pour vérifier :</p>
</blockquote>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#3-1-terraform-azure-init-__codelineno-2-1"></a>az<span class="w"> </span>account<span class="w"> </span>list<span class="w"> </span>-o<span class="w"> </span>table<span class="w"> </span>--all<span class="w"> </span>--query<span class="w"> </span><span class="s2">&quot;[].{TenantID: tenantId, Subscription: name, Default: isDefault}&quot;</span><span class="sb">`</span>
</code></pre></div>
<p>Si ce n'est pas le bon vous pouvez le changer avec <code>az login --tenant $ID</code> ou utilisez une variable terraform <code>tenant_id</code> à ajouter au provider <code>azurerm</code></p>
<p>Nous voici prêt pour créer les datasources et les ressources de notre cloud sans encombres.</p>
<hr />
<ol>
<li>Les datasources</li>
</ol>
<p>Nous allons premièrement définir un fichier <code>data.tf</code> accessible tout au long du processus de création des ressources terraform.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">infra/data.tf</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-3-10">10</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-3-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="kr">data</span><span class="w"> </span><span class="nc">&quot;azurerm_resource_group&quot;</span><span class="w"> </span><span class="nv">&quot;paas&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="w">  </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;kubeapps-group&quot;</span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="p">}</span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a>
<a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="kr">data</span><span class="w"> </span><span class="nc">&quot;azurerm_image&quot;</span><span class="w"> </span><span class="nv">&quot;search&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="w">  </span><span class="na">name</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;kubeapps-az-arm&quot;</span>
<a id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="w">  </span><span class="na">resource_group_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">data.azurerm_resource_group.paas.name</span>
<a id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="p">}</span>
<a id="__codelineno-3-9" name="__codelineno-3-9"></a>
<a id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="kr">data</span><span class="w"> </span><span class="nc">&quot;azurerm_client_config&quot;</span><span class="w"> </span><span class="nv">&quot;current&quot;</span><span class="w"> </span><span class="p">{}</span>
<a id="__codelineno-3-11" name="__codelineno-3-11"></a><span class="kr">data</span><span class="w"> </span><span class="nc">&quot;azurerm_subscription&quot;</span><span class="w"> </span><span class="nv">&quot;primary&quot;</span><span class="w"> </span><span class="p">{}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>
<p><code>azurerm_resource_group</code> nous permet de récupérer le groupe de ressource créé précédemment avec la ligne de commande azure.</p>
</li>
<li>
<p><code>azurerm_client_config</code> permet de récupérer les informations de connexion de l'utilisateur courant que l'on a lancé avec <code>az login</code>.</p>
</li>
<li>
<p><code>azurerm_subscription</code> récupère l'identifiant de votre abonnement en cour.</p>
</li>
</ul>
<hr />
<ol>
<li>Les variables d'entrée</li>
</ol>
<p>Pour éviter de commit des secrets sur un git distant et centralisé les configurations importantes, nous allons recourir à des variables terraform.</p>
<blockquote>
<p><code>sensitive</code> permet de cacher la valeur de la variable dans le terminal lors de l'exécution de terraform.</p>
</blockquote>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">infra/variables.tf</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-4-10">10</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-4-11">11</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-4-12">12</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-4-13">13</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-4-14">14</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-4-15">15</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-4-16">16</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-4-17">17</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-4-18">18</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-4-19">19</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-4-20">20</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-4-21">21</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-4-22">22</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-4-23">23</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-4-24">24</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-4-25">25</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-4-26">26</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-4-27">27</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-4-28">28</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-4-29">29</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-4-30">30</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-4-31">31</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-4-32">32</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-4-33">33</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-4-34">34</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-4-35">35</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-4-36">36</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-4-37">37</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-4-38">38</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-4-39">39</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-4-40">40</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-4-41">41</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-4-42">42</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;github_organization&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="w">  </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="p">}</span>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a>
<a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;github_team&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="w">  </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<a id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="p">}</span>
<a id="__codelineno-4-8" name="__codelineno-4-8"></a>
<a id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;github_token&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-10" name="__codelineno-4-10"></a><span class="w">  </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<a id="__codelineno-4-11" name="__codelineno-4-11"></a><span class="w">  </span><span class="na">sensitive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<a id="__codelineno-4-12" name="__codelineno-4-12"></a><span class="p">}</span>
<a id="__codelineno-4-13" name="__codelineno-4-13"></a>
<a id="__codelineno-4-14" name="__codelineno-4-14"></a><span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;cert_manager_letsencrypt_env&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-15" name="__codelineno-4-15"></a><span class="w">  </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<a id="__codelineno-4-16" name="__codelineno-4-16"></a><span class="w">  </span><span class="na">default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;prod&quot;</span>
<a id="__codelineno-4-17" name="__codelineno-4-17"></a><span class="p">}</span>
<a id="__codelineno-4-18" name="__codelineno-4-18"></a>
<a id="__codelineno-4-19" name="__codelineno-4-19"></a><span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;domain&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-20" name="__codelineno-4-20"></a><span class="w">  </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<a id="__codelineno-4-21" name="__codelineno-4-21"></a><span class="p">}</span>
<a id="__codelineno-4-22" name="__codelineno-4-22"></a>
<a id="__codelineno-4-23" name="__codelineno-4-23"></a><span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;domain_ttl&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-24" name="__codelineno-4-24"></a><span class="w">  </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">number</span>
<a id="__codelineno-4-25" name="__codelineno-4-25"></a><span class="w">  </span><span class="na">default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3000</span>
<a id="__codelineno-4-26" name="__codelineno-4-26"></a><span class="p">}</span>
<a id="__codelineno-4-27" name="__codelineno-4-27"></a>
<a id="__codelineno-4-28" name="__codelineno-4-28"></a><span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;namedotcom_token&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-29" name="__codelineno-4-29"></a><span class="w">  </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<a id="__codelineno-4-30" name="__codelineno-4-30"></a><span class="w">  </span><span class="na">sensitive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<a id="__codelineno-4-31" name="__codelineno-4-31"></a><span class="p">}</span>
<a id="__codelineno-4-32" name="__codelineno-4-32"></a>
<a id="__codelineno-4-33" name="__codelineno-4-33"></a><span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;namedotcom_username&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-34" name="__codelineno-4-34"></a><span class="w">  </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<a id="__codelineno-4-35" name="__codelineno-4-35"></a><span class="w">  </span><span class="na">sensitive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<a id="__codelineno-4-36" name="__codelineno-4-36"></a><span class="p">}</span>
<a id="__codelineno-4-37" name="__codelineno-4-37"></a>
<a id="__codelineno-4-38" name="__codelineno-4-38"></a><span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;secrets&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-39" name="__codelineno-4-39"></a><span class="w">  </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">map</span><span class="p">(</span><span class="kt">string</span><span class="p">)</span>
<a id="__codelineno-4-40" name="__codelineno-4-40"></a><span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Define Azure Key Vault secrets&quot;</span>
<a id="__codelineno-4-41" name="__codelineno-4-41"></a><span class="w">  </span><span class="nb">default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>
<a id="__codelineno-4-42" name="__codelineno-4-42"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Pour remplir ces variables dans un fichier nommé <code>votre-env.tfvars</code> (ex prod.tfvars) il nous reste à obtenir certains tokens d'accès aux api (github et namedotcom).</p>
<p><strong>L'application github oauth pour la production</strong> :</p>
<p>Il n'y a malheureusement pas d'automatisation possible avec terraform, il faut donc <a href="https://github.com/organizations/&lt;my-org&gt;/settings/applications/new">créer une nouvelle application github</a> avec les paramètres suivants :</p>
<ul>
<li>Application name : <code>kubeapps-prod</code></li>
<li>Homepage URL : https://kubeapps.<ton-nom-de-domaine>.example</li>
<li>Authorization callback URL : https://dex.<ton-nom-de-domaine>.example/callback</li>
</ul>
<p>Dans <code>exemple.tfvars</code>, on assignera <strong>Client Id</strong> à <code>dex_github_client_id</code> puis générez un nouveau <strong>Client secret</strong> que l'on assignera à <code>dex_github_client_secret</code>.</p>
<p><strong>Identifiants api à name.com</strong> :</p>
<p>Allez <a href="https://www.name.com/account/settings/api">https://www.name.com/account/settings/api</a> et créer un token avec le nom de votre choix.</p>
<p>L'objectif sera de faire pointer notre nom de domaine vers les serveurs de nom de Azure (enregistrement NS) grâce à un module terraform qui utilisera l'api de name.com.</p>
<p>Enfin, voici un exemple du fichier final à réutiliser et remplir avec les vraies valeurs :</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">infra/exemple.tfvars.dist</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-5-1"> 1</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-5-2"> 2</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-5-3"> 3</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-5-4"> 4</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-5-5"> 5</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-5-6"> 6</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-5-7"> 7</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-5-8"> 8</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-5-9"> 9</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-5-10">10</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-5-11">11</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-5-12">12</a></span>
<span class="normal"><a href="#3-1-terraform-azure-init-__codelineno-5-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="na">tenant_id</span><span class="o">=</span><span class="s2">&quot;00000000-0000-0000-0000-000000000000&quot;</span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="na">github_organization</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;github-team&quot;</span>
<a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="na">github_team</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ops-team&quot;</span>
<a id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="na">domain</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;paas-esgi-tutorial.live&quot;</span>
<a id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="na">namedotcom_username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;username&quot;</span>
<a id="__codelineno-5-6" name="__codelineno-5-6"></a><span class="na">namedotcom_token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;</span>
<a id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="na">github_token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ghp_aaaaaaaaaaaaaaaaaaxxxxxxxxxxxx&quot;</span>
<a id="__codelineno-5-8" name="__codelineno-5-8"></a>
<a id="__codelineno-5-9" name="__codelineno-5-9"></a><span class="nb">secrets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-10" name="__codelineno-5-10"></a><span class="w">  </span><span class="na">dex_github_client_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dex-github-oauth2-app-client-id&quot;</span>
<a id="__codelineno-5-11" name="__codelineno-5-11"></a><span class="w">  </span><span class="na">dex_github_client_secret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dex-github-oauth2-app-client-secret&quot;</span>
<a id="__codelineno-5-12" name="__codelineno-5-12"></a><span class="w">  </span><span class="na">cert_manager_email</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;paas-esgi-tutorial.live4@example.com&quot;</span>
<a id="__codelineno-5-13" name="__codelineno-5-13"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Ces variables seront utilisées dans le fichier <code>main.tf</code> pour créer les ressources.</p>
<ol>
<li>Le fichier principal <code>main.tf</code></li>
</ol>
<p>Ici nous allons définir les ressources de nos plusieurs plateformes afin de faire fonctionner un PaaS kubeapps complet et accessible depuis internet.</p>
<p>La première partie va concerner github et les équipes ayant accès au PaaS.</p>
<p>Ensuite dans une seconde dédié aux ressources Azure, nous allons définir :</p>
<ul>
<li>La création de la VM</li>
<li>Création de l'environnement réseau et de sa sécurisation (ports ouverts)</li>
<li>Attribution d'une ip publique pour l'interface réseau de la machine</li>
<li>Créer un stockage de secrets sécurisé pour l'application kubeapps (feature <code>key_vault</code>)</li>
<li>La gestion des zones dns</li>
</ul>
<p>Enfin au milieu de tout ça lors de la création des zones dns dans azure nous ajouterons un enregistrement NS qui pointe vers les serveurs de nom de name.com grâce au provider <code>namedotcom</code>.</p>
<hr /></section><section class="print-page" id="3-2-terraform-security"><h1 id="3-2-terraform-security-32-securisation-de-lorganisation">3.2 Sécurisation de l'organisation<a class="headerlink" href="#3-2-terraform-security-32-securisation-de-lorganisation" title="Permanent link">&para;</a></h1>
<hr />
<h4 id="3-2-terraform-security-creation-du-key-vault-et-des-secrets">Création du key vault et des secrets<a class="headerlink" href="#3-2-terraform-security-creation-du-key-vault-et-des-secrets" title="Permanent link">&para;</a></h4>
<ul>
<li>
<p><a href="https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/key_vault_secret">terraform keyvault</a></p>
</li>
<li>
<p><a href="https://learn.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/tutorial-windows-vm-access-nonaad#grant-access">keyvault azure</a></p>
</li>
</ul>
<p>Dans le datasource <code>data.tf</code> nous allons récupérer les membres de l'organisation github et les membres admin de notre organisation.
Nous utilisons des boucles pour remplir les dictionnaires <code>github_membership.all</code> et <code>github_membership.all_admin</code></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">infra/data.tf</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#3-2-terraform-security-__codelineno-0-13">13</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-0-14">14</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-0-15">15</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-0-16">16</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-0-17">17</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-0-18">18</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-0-19">19</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-0-20">20</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-0-21">21</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-0-22">22</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-0-23">23</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-0-24">24</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-0-25">25</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-0-26">26</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-0-27">27</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-0-28">28</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="kr">data</span><span class="w"> </span><span class="nc">&quot;github_organization&quot;</span><span class="w"> </span><span class="nv">&quot;org&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="w">  </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.github_organization</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="p">}</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="kr">data</span><span class="w"> </span><span class="nc">&quot;github_membership&quot;</span><span class="w"> </span><span class="nv">&quot;all&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="w">  </span><span class="na">for_each</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">toset</span><span class="p">(</span><span class="nv">data.github_organization.org.members</span><span class="p">)</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="w">  </span><span class="na">username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">each.value</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="p">}</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="kr">data</span><span class="w"> </span><span class="nc">&quot;github_membership&quot;</span><span class="w"> </span><span class="nv">&quot;all_admin&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="w">  </span><span class="nb">for_each</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="w">    </span><span class="err">for</span><span class="w"> </span><span class="err">_</span><span class="p">,</span><span class="w"> </span><span class="err">member</span><span class="w"> </span><span class="err">in</span><span class="w"> </span><span class="nv">data.github_membership.all</span><span class="p">:</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="w">    </span><span class="na">_</span><span class="w"> </span><span class="o">=</span><span class="err">&gt;</span><span class="w"> </span><span class="err">member</span><span class="w"> </span><span class="err">if</span><span class="w"> </span><span class="nv">member.role</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s2">&quot;admin&quot;</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="w">  </span><span class="na">username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">each.value.username</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Puis nous allons créer l'équipe github puis assigner comme membre tous les administrateurs de l'organisation à celle-ci.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">infra/main.tf</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#3-2-terraform-security-__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-1-10">10</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-1-11">11</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-1-12">12</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-1-13">13</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-1-14">14</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-1-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="c1">############</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="c1"># Accounts</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="c1">############</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;github_team&quot;</span><span class="w"> </span><span class="nv">&quot;opsteam&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">  </span><span class="na">name</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="nv">var.github_team</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;This is the production team&quot;</span>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="w">  </span><span class="na">privacy</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;closed&quot;</span>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="p">}</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;github_team_membership&quot;</span><span class="w"> </span><span class="nv">&quot;opsteam_members&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="w">  </span><span class="na">for_each</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">data.github_membership.all_admin</span>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">  </span><span class="na">team_id</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nv">github_team.opsteam.id</span>
<a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="w">  </span><span class="na">username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">each.value.username</span>
<a id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="w">  </span><span class="na">role</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;member&quot;</span>
<a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h4 id="3-2-terraform-security-creation-du-key-vault-et-des-secrets_1">Création du key vault et des secrets<a class="headerlink" href="#3-2-terraform-security-creation-du-key-vault-et-des-secrets_1" title="Permanent link">&para;</a></h4>
<p>Pour des raisons essentielles de sécurité nous mettons à disposition de la machine virtuelle un stockage de secrets sécurisé grâce à la ressource terraform <code>azurerm_key_vault</code></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">infra/main.tf</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#3-2-terraform-security-__codelineno-2-17">17</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-2-18">18</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-2-19">19</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-2-20">20</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-2-21">21</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-2-22">22</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-2-23">23</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-2-24">24</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-2-25">25</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-2-26">26</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-2-27">27</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-2-28">28</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-2-29">29</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-2-30">30</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-2-31">31</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-2-32">32</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-2-33">33</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-2-34">34</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-2-35">35</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-2-36">36</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-2-37">37</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-2-38">38</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-2-39">39</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-2-40">40</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-2-41">41</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-2-42">42</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-2-43">43</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-2-44">44</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-2-45">45</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-2-46">46</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-2-47">47</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-2-48">48</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-2-49">49</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-2-50">50</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-2-51">51</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-17" name="__codelineno-2-17"></a><span class="c1">############</span>
<a id="__codelineno-2-18" name="__codelineno-2-18"></a><span class="c1"># Key vault</span>
<a id="__codelineno-2-19" name="__codelineno-2-19"></a><span class="c1">############</span>
<a id="__codelineno-2-20" name="__codelineno-2-20"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;random_id&quot;</span><span class="w"> </span><span class="nv">&quot;kvname&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-21" name="__codelineno-2-21"></a><span class="w">  </span><span class="na">byte_length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5</span>
<a id="__codelineno-2-22" name="__codelineno-2-22"></a><span class="w">  </span><span class="na">prefix</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;keyvault&quot;</span>
<a id="__codelineno-2-23" name="__codelineno-2-23"></a><span class="p">}</span>
<a id="__codelineno-2-24" name="__codelineno-2-24"></a>
<a id="__codelineno-2-25" name="__codelineno-2-25"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;azurerm_key_vault&quot;</span><span class="w"> </span><span class="nv">&quot;paas&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-26" name="__codelineno-2-26"></a><span class="w">  </span><span class="na">name</span><span class="w">                       </span><span class="o">=</span><span class="w"> </span><span class="nv">random_id.kvname.hex</span>
<a id="__codelineno-2-27" name="__codelineno-2-27"></a><span class="w">  </span><span class="na">location</span><span class="w">                   </span><span class="o">=</span><span class="w"> </span><span class="nv">data.azurerm_resource_group.paas.location</span>
<a id="__codelineno-2-28" name="__codelineno-2-28"></a><span class="w">  </span><span class="na">resource_group_name</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="nv">data.azurerm_resource_group.paas.name</span>
<a id="__codelineno-2-29" name="__codelineno-2-29"></a><span class="w">  </span><span class="na">soft_delete_retention_days</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">7</span>
<a id="__codelineno-2-30" name="__codelineno-2-30"></a>
<a id="__codelineno-2-31" name="__codelineno-2-31"></a><span class="w">  </span><span class="na">tenant_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">data.azurerm_client_config.current.tenant_id</span>
<a id="__codelineno-2-32" name="__codelineno-2-32"></a>
<a id="__codelineno-2-33" name="__codelineno-2-33"></a><span class="w">  </span><span class="na">purge_protection_enabled</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="no">false</span>
<a id="__codelineno-2-34" name="__codelineno-2-34"></a><span class="w">  </span><span class="na">enabled_for_disk_encryption</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<a id="__codelineno-2-35" name="__codelineno-2-35"></a><span class="w">  </span><span class="na">enabled_for_deployment</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<a id="__codelineno-2-36" name="__codelineno-2-36"></a>
<a id="__codelineno-2-37" name="__codelineno-2-37"></a><span class="w">  </span><span class="na">sku_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;standard&quot;</span>
<a id="__codelineno-2-38" name="__codelineno-2-38"></a>
<a id="__codelineno-2-39" name="__codelineno-2-39"></a><span class="w">  </span><span class="nb">lifecycle</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-40" name="__codelineno-2-40"></a><span class="w">    </span><span class="na">create_before_destroy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<a id="__codelineno-2-41" name="__codelineno-2-41"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-2-42" name="__codelineno-2-42"></a>
<a id="__codelineno-2-43" name="__codelineno-2-43"></a><span class="w">  </span><span class="nb">access_policy</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-44" name="__codelineno-2-44"></a><span class="w">    </span><span class="na">tenant_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">data.azurerm_client_config.current.tenant_id</span>
<a id="__codelineno-2-45" name="__codelineno-2-45"></a><span class="w">    </span><span class="na">object_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">data.azurerm_client_config.current.object_id</span>
<a id="__codelineno-2-46" name="__codelineno-2-46"></a>
<a id="__codelineno-2-47" name="__codelineno-2-47"></a><span class="w">    </span><span class="na">secret_permissions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-2-48" name="__codelineno-2-48"></a><span class="w">      </span><span class="s2">&quot;Get&quot;, &quot;Set&quot;, &quot;Backup&quot;, &quot;Delete&quot;, &quot;List&quot;, &quot;Purge&quot;, &quot;Recover&quot;, &quot;Restore&quot;</span><span class="p">,</span>
<a id="__codelineno-2-49" name="__codelineno-2-49"></a><span class="w">    </span><span class="p">]</span>
<a id="__codelineno-2-50" name="__codelineno-2-50"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-2-51" name="__codelineno-2-51"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>On nomme donc ce keyvault avec une ressource de nom aléatoire <code>random_id</code> puis on lui associe les informations habituelles du groupe de ressource.</p>
<p><code>soft_delete_retention_days</code> permet de définir le nombre de jours pendant lesquels des secrets supprimés pourront être restaurés.</p>
<p><code>tenant_id</code> permet de définir le propriétaire du keyvault.</p>
<p>Ensuite nous utilisons des propriétés de base pour rendre les secrets accessibles pour différents types d'utilisations, définir le type de keyvault et son cycle de vie.</p>
<p>Le block <code>lifecycle</code> est une fonctionnalité de terraform qui change la façon dont est recréer la ressource avant une modification.</p>
<p>Enfin le plus important est le block <code>access_policy</code> qui permet de définir les permissions de l'utilisateur qui va accéder au keyvault. Ici on les définit pour le <code>tenant id</code> et le <code>principal id</code> contenus dans le client azure courant (utilisateur connecté avec azure cli).</p>
<h5 id="3-2-terraform-security-utilisons-maintenant-le-keyvault-pour-stocker-nos-secrets">Utilisons maintenant le keyvault pour stocker nos secrets<a class="headerlink" href="#3-2-terraform-security-utilisons-maintenant-le-keyvault-pour-stocker-nos-secrets" title="Permanent link">&para;</a></h5>
<p>Pour stocker nos secrets, nous utilisons la ressource <code>azurerm_key_vault_secret</code> qui permet de stocker des secrets dans le keyvault créé précédemment. Nous allons utiliser les secrets créer dans <code>variables.tf</code> ainsi que des mots de passes générés aléatoirement pour certaines configurations de <code>dex</code> et <code>kubeapps</code>.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">infra/main.tf</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#3-2-terraform-security-__codelineno-3-53">53</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-3-54">54</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-3-55">55</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-3-56">56</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-3-57">57</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-3-58">58</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-3-59">59</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-3-60">60</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-3-61">61</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-3-62">62</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-3-63">63</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-3-64">64</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-3-65">65</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-3-66">66</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-3-67">67</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-3-68">68</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-3-69">69</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-3-70">70</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-3-71">71</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-3-72">72</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-3-73">73</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-3-74">74</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-3-75">75</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-3-76">76</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-3-77">77</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-3-78">78</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-3-79">79</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-3-80">80</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-3-81">81</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-3-82">82</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-3-83">83</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-3-84">84</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-3-85">85</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-3-86">86</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-3-87">87</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-3-88">88</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-3-89">89</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-3-90">90</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-3-91">91</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-3-92">92</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-3-93">93</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-3-94">94</a></span>
<span class="normal"><a href="#3-2-terraform-security-__codelineno-3-95">95</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-53" name="__codelineno-3-53"></a><span class="c1"># Kubeapps OAuth Proxy</span>
<a id="__codelineno-3-54" name="__codelineno-3-54"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;random_password&quot;</span><span class="w"> </span><span class="nv">&quot;kubeapps_oauth_proxy_cookie_secret&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-55" name="__codelineno-3-55"></a><span class="w">  </span><span class="na">length</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="m">16</span>
<a id="__codelineno-3-56" name="__codelineno-3-56"></a><span class="w">  </span><span class="na">special</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<a id="__codelineno-3-57" name="__codelineno-3-57"></a><span class="w">  </span><span class="na">override_special</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;!#$%&amp;*()-_=+[]{}&lt;&gt;:?&quot;</span>
<a id="__codelineno-3-58" name="__codelineno-3-58"></a><span class="p">}</span>
<a id="__codelineno-3-59" name="__codelineno-3-59"></a>
<a id="__codelineno-3-60" name="__codelineno-3-60"></a><span class="c1"># Dex oidc client</span>
<a id="__codelineno-3-61" name="__codelineno-3-61"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;random_password&quot;</span><span class="w"> </span><span class="nv">&quot;dex_client_id&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-62" name="__codelineno-3-62"></a><span class="w">  </span><span class="na">length</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="m">16</span>
<a id="__codelineno-3-63" name="__codelineno-3-63"></a><span class="w">  </span><span class="na">special</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">false</span>
<a id="__codelineno-3-64" name="__codelineno-3-64"></a><span class="p">}</span>
<a id="__codelineno-3-65" name="__codelineno-3-65"></a>
<a id="__codelineno-3-66" name="__codelineno-3-66"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;random_password&quot;</span><span class="w"> </span><span class="nv">&quot;dex_client_secret&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-67" name="__codelineno-3-67"></a><span class="w">  </span><span class="na">length</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="m">24</span>
<a id="__codelineno-3-68" name="__codelineno-3-68"></a><span class="w">  </span><span class="na">special</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">false</span>
<a id="__codelineno-3-69" name="__codelineno-3-69"></a><span class="p">}</span>
<a id="__codelineno-3-70" name="__codelineno-3-70"></a>
<a id="__codelineno-3-71" name="__codelineno-3-71"></a><span class="c1"># Vm password</span>
<a id="__codelineno-3-72" name="__codelineno-3-72"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;random_password&quot;</span><span class="w"> </span><span class="nv">&quot;vm_password&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-73" name="__codelineno-3-73"></a><span class="w">  </span><span class="na">length</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="m">16</span>
<a id="__codelineno-3-74" name="__codelineno-3-74"></a><span class="w">  </span><span class="na">special</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<a id="__codelineno-3-75" name="__codelineno-3-75"></a><span class="w">  </span><span class="na">override_special</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;!#$%&amp;*()-_=+[]{}&lt;&gt;:?&quot;</span>
<a id="__codelineno-3-76" name="__codelineno-3-76"></a><span class="p">}</span>
<a id="__codelineno-3-77" name="__codelineno-3-77"></a>
<a id="__codelineno-3-78" name="__codelineno-3-78"></a><span class="nb">locals</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-79" name="__codelineno-3-79"></a><span class="w">  </span><span class="na">final_secrets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">merge</span><span class="p">(</span>
<a id="__codelineno-3-80" name="__codelineno-3-80"></a><span class="w">    </span><span class="nv">var.secrets</span><span class="p">,</span>
<a id="__codelineno-3-81" name="__codelineno-3-81"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-3-82" name="__codelineno-3-82"></a><span class="w">      </span><span class="na">vm_password</span><span class="w">                        </span><span class="o">=</span><span class="w"> </span><span class="nv">random_password.vm_password.result</span>
<a id="__codelineno-3-83" name="__codelineno-3-83"></a><span class="w">      </span><span class="na">dex_client_id</span><span class="w">                      </span><span class="o">=</span><span class="w"> </span><span class="nv">random_password.dex_client_id.result</span>
<a id="__codelineno-3-84" name="__codelineno-3-84"></a><span class="w">      </span><span class="na">dex_client_secret</span><span class="w">                  </span><span class="o">=</span><span class="w"> </span><span class="nv">random_password.dex_client_secret.result</span>
<a id="__codelineno-3-85" name="__codelineno-3-85"></a><span class="w">      </span><span class="na">kubeapps_oauth_proxy_cookie_secret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">random_password.kubeapps_oauth_proxy_cookie_secret.result</span>
<a id="__codelineno-3-86" name="__codelineno-3-86"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-3-87" name="__codelineno-3-87"></a><span class="w">  </span><span class="p">)</span>
<a id="__codelineno-3-88" name="__codelineno-3-88"></a><span class="p">}</span>
<a id="__codelineno-3-89" name="__codelineno-3-89"></a>
<a id="__codelineno-3-90" name="__codelineno-3-90"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;azurerm_key_vault_secret&quot;</span><span class="w"> </span><span class="nv">&quot;paas_all_secrets&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-91" name="__codelineno-3-91"></a><span class="w">  </span><span class="na">for_each</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nv">local.final_secrets</span>
<a id="__codelineno-3-92" name="__codelineno-3-92"></a><span class="w">  </span><span class="na">name</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="nf">replace</span><span class="p">(</span><span class="nv">each.key</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;_&quot;, &quot;-&quot;</span><span class="p">)</span>
<a id="__codelineno-3-93" name="__codelineno-3-93"></a><span class="w">  </span><span class="na">value</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="nv">each.value</span>
<a id="__codelineno-3-94" name="__codelineno-3-94"></a><span class="w">  </span><span class="na">key_vault_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_key_vault.paas.id</span>
<a id="__codelineno-3-95" name="__codelineno-3-95"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<blockquote>
<p>On fusionne les secrets définis dans <code>variables.tf</code> avec les secrets générés aléatoirement pour un appel à la ressource encore plus simple.</p>
<p>Nous utilisons donc une boucle <code>for_each</code> pour éviter la répétition des ressources secrets.</p>
</blockquote>
<hr /></section><section class="print-page" id="3-3-terraform-azure-network-vm"><h1 id="3-3-terraform-azure-network-vm-33-machine-virtuelle-et-reseau">3.3 Machine virtuelle et réseau<a class="headerlink" href="#3-3-terraform-azure-network-vm-33-machine-virtuelle-et-reseau" title="Permanent link">&para;</a></h1>
<h4 id="3-3-terraform-azure-network-vm-creation-de-lenvironnement-reseau">Création de l'environnement réseau<a class="headerlink" href="#3-3-terraform-azure-network-vm-creation-de-lenvironnement-reseau" title="Permanent link">&para;</a></h4>
<p>Ces directives sont essentiellement tirées de la documentation officielle de terraform pour azure. Il faut savoir que l'usage d'azure pour créer une machine nous indique l'utilisation d'un réseau virtuel (DHCP) et d'un sous-réseau afin de la rendre accessible avec une adresse IP privée.</p>
<p><code>azurerm_virtual_network</code> et <code>azurerm_subnet</code> nous permettent de faire ça facilement dans notre groupe de ressources.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">infra/main.tf</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-0-100">100</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-0-101">101</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-0-102">102</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-0-103">103</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-0-104">104</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-0-105">105</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-0-106">106</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-0-107">107</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-0-108">108</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-0-109">109</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-0-110">110</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-0-111">111</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-0-112">112</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-97" name="__codelineno-0-97"></a><span class="c1">############</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a><span class="c1"># Vm Network</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a><span class="c1">############</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;azurerm_virtual_network&quot;</span><span class="w"> </span><span class="nv">&quot;paas&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a><span class="w">  </span><span class="na">name</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;paas-vn&quot;</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a><span class="w">  </span><span class="na">address_space</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;10.0.0.0/16&quot;</span><span class="p">]</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a><span class="w">  </span><span class="na">location</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="nv">data.azurerm_resource_group.paas.location</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a><span class="w">  </span><span class="na">resource_group_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">data.azurerm_resource_group.paas.name</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a><span class="p">}</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;azurerm_subnet&quot;</span><span class="w"> </span><span class="nv">&quot;paas&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a><span class="w">  </span><span class="na">name</span><span class="w">                 </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;paas-sub&quot;</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a><span class="w">  </span><span class="na">resource_group_name</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nv">data.azurerm_resource_group.paas.name</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a><span class="w">  </span><span class="na">virtual_network_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_virtual_network.paas.name</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a><span class="w">  </span><span class="na">address_prefixes</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;10.0.2.0/24&quot;</span><span class="p">]</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">infra/main.tf</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-1-114">114</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-1-115">115</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-1-116">116</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-1-117">117</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-1-118">118</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-1-119">119</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-1-120">120</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-1-121">121</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-1-122">122</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-1-123">123</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-1-124">124</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-1-125">125</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-1-126">126</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-1-127">127</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-1-128">128</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-1-129">129</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-1-130">130</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-1-131">131</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-1-132">132</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-1-133">133</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-1-134">134</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-1-135">135</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-1-136">136</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-1-137">137</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-1-138">138</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-1-139">139</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-1-140">140</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-1-141">141</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-1-142">142</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-1-143">143</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-1-144">144</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-1-145">145</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-1-146">146</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-1-147">147</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-114" name="__codelineno-1-114"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;azurerm_network_security_group&quot;</span><span class="w"> </span><span class="nv">&quot;paas&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-115" name="__codelineno-1-115"></a><span class="w">  </span><span class="na">name</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;paas-security-gp&quot;</span>
<a id="__codelineno-1-116" name="__codelineno-1-116"></a><span class="w">  </span><span class="na">location</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="nv">data.azurerm_resource_group.paas.location</span>
<a id="__codelineno-1-117" name="__codelineno-1-117"></a><span class="w">  </span><span class="na">resource_group_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">data.azurerm_resource_group.paas.name</span>
<a id="__codelineno-1-118" name="__codelineno-1-118"></a>
<a id="__codelineno-1-119" name="__codelineno-1-119"></a><span class="w">  </span><span class="nb">security_rule</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-120" name="__codelineno-1-120"></a><span class="w">    </span><span class="na">name</span><span class="w">                       </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;HTTP&quot;</span>
<a id="__codelineno-1-121" name="__codelineno-1-121"></a><span class="w">    </span><span class="na">priority</span><span class="w">                   </span><span class="o">=</span><span class="w"> </span><span class="m">1000</span>
<a id="__codelineno-1-122" name="__codelineno-1-122"></a><span class="w">    </span><span class="na">direction</span><span class="w">                  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Inbound&quot;</span>
<a id="__codelineno-1-123" name="__codelineno-1-123"></a><span class="w">    </span><span class="na">access</span><span class="w">                     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Allow&quot;</span>
<a id="__codelineno-1-124" name="__codelineno-1-124"></a><span class="w">    </span><span class="na">protocol</span><span class="w">                   </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Tcp&quot;</span>
<a id="__codelineno-1-125" name="__codelineno-1-125"></a><span class="w">    </span><span class="na">source_port_range</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;*&quot;</span>
<a id="__codelineno-1-126" name="__codelineno-1-126"></a><span class="w">    </span><span class="na">destination_port_range</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;80&quot;</span>
<a id="__codelineno-1-127" name="__codelineno-1-127"></a><span class="w">    </span><span class="na">source_address_prefix</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;*&quot;</span>
<a id="__codelineno-1-128" name="__codelineno-1-128"></a><span class="w">    </span><span class="na">destination_address_prefix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;*&quot;</span>
<a id="__codelineno-1-129" name="__codelineno-1-129"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-1-130" name="__codelineno-1-130"></a>
<a id="__codelineno-1-131" name="__codelineno-1-131"></a><span class="w">  </span><span class="nb">security_rule</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-132" name="__codelineno-1-132"></a><span class="w">    </span><span class="na">name</span><span class="w">                       </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;HTTPS&quot;</span>
<a id="__codelineno-1-133" name="__codelineno-1-133"></a><span class="w">    </span><span class="na">priority</span><span class="w">                   </span><span class="o">=</span><span class="w"> </span><span class="m">1001</span>
<a id="__codelineno-1-134" name="__codelineno-1-134"></a><span class="w">    </span><span class="na">direction</span><span class="w">                  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Inbound&quot;</span>
<a id="__codelineno-1-135" name="__codelineno-1-135"></a><span class="w">    </span><span class="na">access</span><span class="w">                     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Allow&quot;</span>
<a id="__codelineno-1-136" name="__codelineno-1-136"></a><span class="w">    </span><span class="na">protocol</span><span class="w">                   </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Tcp&quot;</span>
<a id="__codelineno-1-137" name="__codelineno-1-137"></a><span class="w">    </span><span class="na">source_port_range</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;*&quot;</span>
<a id="__codelineno-1-138" name="__codelineno-1-138"></a><span class="w">    </span><span class="na">destination_port_range</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;443&quot;</span>
<a id="__codelineno-1-139" name="__codelineno-1-139"></a><span class="w">    </span><span class="na">source_address_prefix</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;*&quot;</span>
<a id="__codelineno-1-140" name="__codelineno-1-140"></a><span class="w">    </span><span class="na">destination_address_prefix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;*&quot;</span>
<a id="__codelineno-1-141" name="__codelineno-1-141"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-1-142" name="__codelineno-1-142"></a><span class="p">}</span>
<a id="__codelineno-1-143" name="__codelineno-1-143"></a>
<a id="__codelineno-1-144" name="__codelineno-1-144"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;azurerm_subnet_network_security_group_association&quot;</span><span class="w"> </span><span class="nv">&quot;paas_security_group&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-145" name="__codelineno-1-145"></a><span class="w">  </span><span class="na">subnet_id</span><span class="w">                 </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_subnet.paas.id</span>
<a id="__codelineno-1-146" name="__codelineno-1-146"></a><span class="w">  </span><span class="na">network_security_group_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_network_security_group.paas.id</span>
<a id="__codelineno-1-147" name="__codelineno-1-147"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">infra/main.tf</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-2-149">149</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-2-150">150</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-2-151">151</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-2-152">152</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-2-153">153</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-2-154">154</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-2-155">155</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-2-156">156</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-2-157">157</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-2-158">158</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-2-159">159</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-2-160">160</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-2-161">161</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-2-162">162</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-2-163">163</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-2-164">164</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-2-165">165</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-2-166">166</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-2-167">167</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-2-168">168</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-2-169">169</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-149" name="__codelineno-2-149"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;azurerm_public_ip&quot;</span><span class="w"> </span><span class="nv">&quot;paas&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-150" name="__codelineno-2-150"></a><span class="w">  </span><span class="na">name</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;paas-ip&quot;</span>
<a id="__codelineno-2-151" name="__codelineno-2-151"></a><span class="w">  </span><span class="na">resource_group_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">data.azurerm_resource_group.paas.name</span>
<a id="__codelineno-2-152" name="__codelineno-2-152"></a><span class="w">  </span><span class="na">location</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="nv">data.azurerm_resource_group.paas.location</span>
<a id="__codelineno-2-153" name="__codelineno-2-153"></a><span class="w">  </span><span class="na">allocation_method</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Dynamic&quot;</span>
<a id="__codelineno-2-154" name="__codelineno-2-154"></a><span class="p">}</span>
<a id="__codelineno-2-155" name="__codelineno-2-155"></a>
<a id="__codelineno-2-156" name="__codelineno-2-156"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;azurerm_network_interface&quot;</span><span class="w"> </span><span class="nv">&quot;paas&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-157" name="__codelineno-2-157"></a><span class="w">  </span><span class="na">name</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;paas-nic&quot;</span>
<a id="__codelineno-2-158" name="__codelineno-2-158"></a><span class="w">  </span><span class="na">location</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="nv">data.azurerm_resource_group.paas.location</span>
<a id="__codelineno-2-159" name="__codelineno-2-159"></a><span class="w">  </span><span class="na">resource_group_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">data.azurerm_resource_group.paas.name</span>
<a id="__codelineno-2-160" name="__codelineno-2-160"></a>
<a id="__codelineno-2-161" name="__codelineno-2-161"></a><span class="w">  </span><span class="na">enable_accelerated_networking</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<a id="__codelineno-2-162" name="__codelineno-2-162"></a>
<a id="__codelineno-2-163" name="__codelineno-2-163"></a><span class="w">  </span><span class="nb">ip_configuration</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-164" name="__codelineno-2-164"></a><span class="w">    </span><span class="na">name</span><span class="w">                          </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;paasconfiguration1&quot;</span>
<a id="__codelineno-2-165" name="__codelineno-2-165"></a><span class="w">    </span><span class="na">subnet_id</span><span class="w">                     </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_subnet.paas.id</span>
<a id="__codelineno-2-166" name="__codelineno-2-166"></a><span class="w">    </span><span class="na">private_ip_address_allocation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Dynamic&quot;</span>
<a id="__codelineno-2-167" name="__codelineno-2-167"></a><span class="w">    </span><span class="na">public_ip_address_id</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_public_ip.paas.id</span>
<a id="__codelineno-2-168" name="__codelineno-2-168"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-2-169" name="__codelineno-2-169"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h4 id="3-3-terraform-azure-network-vm-configuration-de-la-zone-dns">Configuration de la zone dns<a class="headerlink" href="#3-3-terraform-azure-network-vm-configuration-de-la-zone-dns" title="Permanent link">&para;</a></h4>
<p>Azure a de très bons outils pour la gestion des zones dns. On va donc utiliser le provider <code>azurerm</code> pour créer une zone et récupérer les serveurs dns associés.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">infra/main.tf</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-3-171">171</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-3-172">172</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-3-173">173</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-3-174">174</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-3-175">175</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-3-176">176</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-3-177">177</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-171" name="__codelineno-3-171"></a><span class="c1">############</span>
<a id="__codelineno-3-172" name="__codelineno-3-172"></a><span class="c1"># Dns</span>
<a id="__codelineno-3-173" name="__codelineno-3-173"></a><span class="c1">############</span>
<a id="__codelineno-3-174" name="__codelineno-3-174"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;azurerm_dns_zone&quot;</span><span class="w"> </span><span class="nv">&quot;paas&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-175" name="__codelineno-3-175"></a><span class="w">  </span><span class="na">name</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="nv">var.domain</span>
<a id="__codelineno-3-176" name="__codelineno-3-176"></a><span class="w">  </span><span class="na">resource_group_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">data.azurerm_resource_group.paas.name</span>
<a id="__codelineno-3-177" name="__codelineno-3-177"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Voici le retour de la ressource créer qui donne tous les serveurs dns requis pour faire fonctionner la zone dns.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#3-3-terraform-azure-network-vm-__codelineno-4-1"></a><span class="p">[</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#3-3-terraform-azure-network-vm-__codelineno-4-2"></a><span class="w">    </span><span class="s2">&quot;ns1-03.azure-dns.com.&quot;</span><span class="p">,</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#3-3-terraform-azure-network-vm-__codelineno-4-3"></a><span class="w">    </span><span class="s2">&quot;ns2-03.azure-dns.net.&quot;</span><span class="p">,</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#3-3-terraform-azure-network-vm-__codelineno-4-4"></a><span class="w">    </span><span class="s2">&quot;ns3-03.azure-dns.org.&quot;</span><span class="p">,</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#3-3-terraform-azure-network-vm-__codelineno-4-5"></a><span class="w">    </span><span class="s2">&quot;ns4-03.azure-dns.info.&quot;</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#3-3-terraform-azure-network-vm-__codelineno-4-6"></a><span class="p">]</span>
</code></pre></div>
<p>Ensuite on arrive facilement à récupérer les serveurs dns puis les reformater (enlever les <code>.</code> à la fin) avant de les injecter dans le fournisseur de noms name.com</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">infra/main.tf</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-5-179">179</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-5-180">180</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-5-181">181</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-5-182">182</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-5-183">183</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-5-184">184</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-5-185">185</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-179" name="__codelineno-5-179"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;namedotcom_domain_nameservers&quot;</span><span class="w"> </span><span class="nv">&quot;namedotcom_paas_ns&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-180" name="__codelineno-5-180"></a><span class="w">  </span><span class="na">domain_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.domain</span>
<a id="__codelineno-5-181" name="__codelineno-5-181"></a><span class="w">  </span><span class="na">nameservers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-5-182" name="__codelineno-5-182"></a><span class="c1">    # Delete ending dot which isn&#39;t valid for namedotcom api</span>
<a id="__codelineno-5-183" name="__codelineno-5-183"></a><span class="w">    </span><span class="err">for</span><span class="w"> </span><span class="err">item</span><span class="w"> </span><span class="err">in</span><span class="w"> </span><span class="nv">azurerm_dns_zone.paas.name_servers</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nf">trimsuffix</span><span class="p">(</span><span class="err">item</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
<a id="__codelineno-5-184" name="__codelineno-5-184"></a><span class="w">  </span><span class="p">]</span>
<a id="__codelineno-5-185" name="__codelineno-5-185"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Enfin on met en place le <strong>wildcard</strong> pour la zone dns afin que tous les sous domaines pointent vers l'ip publique de la vm. Ainsi n'importe quel sous domaine de <code>paas-exemple-tutorial.live</code> pointera vers l'ingress de k3s.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">infra/main.tf</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-6-187">187</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-6-188">188</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-6-189">189</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-6-190">190</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-6-191">191</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-6-192">192</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-6-193">193</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-6-194">194</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-187" name="__codelineno-6-187"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;azurerm_dns_a_record&quot;</span><span class="w"> </span><span class="nv">&quot;paas&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-188" name="__codelineno-6-188"></a><span class="w">  </span><span class="na">depends_on</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nv">namedotcom_domain_nameservers.namedotcom_paas_ns</span><span class="p">]</span>
<a id="__codelineno-6-189" name="__codelineno-6-189"></a><span class="w">  </span><span class="na">name</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;*&quot;</span>
<a id="__codelineno-6-190" name="__codelineno-6-190"></a><span class="w">  </span><span class="na">zone_name</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_dns_zone.paas.name</span>
<a id="__codelineno-6-191" name="__codelineno-6-191"></a><span class="w">  </span><span class="na">resource_group_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">data.azurerm_resource_group.paas.name</span>
<a id="__codelineno-6-192" name="__codelineno-6-192"></a><span class="w">  </span><span class="na">ttl</span><span class="w">                 </span><span class="o">=</span><span class="w"> </span><span class="nv">var.domain_ttl</span>
<a id="__codelineno-6-193" name="__codelineno-6-193"></a><span class="w">  </span><span class="na">target_resource_id</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_public_ip.paas.id</span>
<a id="__codelineno-6-194" name="__codelineno-6-194"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<blockquote>
<p>Warning: N'oublions pas de relié les ressources namedotcom et azure avec <code>depends_on</code>, car ce sont deux fournisseurs de services différents. On évite ainsi des problèmes de synchronisation DNS.</p>
</blockquote>
<p>C'est comme cela que l'on arrive à avoir un nom de domaine comme <code>kubeapps.paas-exemple-tutorial.live</code> qui pointe vers l'ingress de k3s.</p>
<hr />
<h4 id="3-3-terraform-azure-network-vm-creation-de-lidentite-de-la-vm">Création de l'identité de la vm<a class="headerlink" href="#3-3-terraform-azure-network-vm-creation-de-lidentite-de-la-vm" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">infra/main.tf</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-7-195">195</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-7-196">196</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-7-197">197</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-7-198">198</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-7-199">199</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-7-200">200</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-7-201">201</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-7-202">202</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-7-203">203</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-7-204">204</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-7-205">205</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-7-206">206</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-7-207">207</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-7-208">208</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-7-209">209</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-7-210">210</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-7-211">211</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-7-212">212</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-7-213">213</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-7-214">214</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-7-215">215</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-7-216">216</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-195" name="__codelineno-7-195"></a><span class="c1">############</span>
<a id="__codelineno-7-196" name="__codelineno-7-196"></a><span class="c1"># Vm creation</span>
<a id="__codelineno-7-197" name="__codelineno-7-197"></a><span class="c1">############</span>
<a id="__codelineno-7-198" name="__codelineno-7-198"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;azurerm_user_assigned_identity&quot;</span><span class="w"> </span><span class="nv">&quot;paas_vm&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-199" name="__codelineno-7-199"></a><span class="w">  </span><span class="na">location</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="nv">data.azurerm_resource_group.paas.location</span>
<a id="__codelineno-7-200" name="__codelineno-7-200"></a><span class="w">  </span><span class="na">name</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;paas_vm_identity&quot;</span>
<a id="__codelineno-7-201" name="__codelineno-7-201"></a><span class="w">  </span><span class="na">resource_group_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">data.azurerm_resource_group.paas.name</span>
<a id="__codelineno-7-202" name="__codelineno-7-202"></a><span class="p">}</span>
<a id="__codelineno-7-203" name="__codelineno-7-203"></a>
<a id="__codelineno-7-204" name="__codelineno-7-204"></a><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;azurerm_key_vault_access_policy&quot;</span><span class="w"> </span><span class="nv">&quot;paas_vm&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-205" name="__codelineno-7-205"></a><span class="w">  </span><span class="na">key_vault_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_key_vault.paas.id</span>
<a id="__codelineno-7-206" name="__codelineno-7-206"></a><span class="w">  </span><span class="na">tenant_id</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nv">data.azurerm_client_config.current.tenant_id</span>
<a id="__codelineno-7-207" name="__codelineno-7-207"></a><span class="w">  </span><span class="na">object_id</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_user_assigned_identity.paas_vm.principal_id</span>
<a id="__codelineno-7-208" name="__codelineno-7-208"></a>
<a id="__codelineno-7-209" name="__codelineno-7-209"></a><span class="w">  </span><span class="na">key_permissions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;Get&quot;</span><span class="p">,]</span>
<a id="__codelineno-7-210" name="__codelineno-7-210"></a>
<a id="__codelineno-7-211" name="__codelineno-7-211"></a><span class="w">  </span><span class="na">secret_permissions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-7-212" name="__codelineno-7-212"></a><span class="w">    </span><span class="s2">&quot;Get&quot;, &quot;List&quot;, &quot;Recover&quot;, &quot;Restore&quot;</span><span class="p">,</span>
<a id="__codelineno-7-213" name="__codelineno-7-213"></a><span class="w">  </span><span class="p">]</span>
<a id="__codelineno-7-214" name="__codelineno-7-214"></a>
<a id="__codelineno-7-215" name="__codelineno-7-215"></a><span class="w">  </span><span class="na">storage_permissions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">&quot;Get&quot;</span><span class="w"> </span><span class="p">]</span>
<a id="__codelineno-7-216" name="__codelineno-7-216"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>
<p>La ressource <code>azurerm_user_assigned_identity</code> permet de créer une identité et d'ensuite accéder à ses informations de connexion (tenant, service principal...)</p>
</li>
<li>
<p><code>azurerm_key_vault_access_policy</code> défini les permissions de l'identité sur le keyvault. Ici on lui donne les droits de lecture sur les secrets. <code>key_vault_id</code> est obligatoire pour lier la politique au keyvault.</p>
</li>
</ul>
<h4 id="3-3-terraform-azure-network-vm-creation-de-la-vm">Création de la VM<a class="headerlink" href="#3-3-terraform-azure-network-vm-creation-de-la-vm" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">infra/main.tf</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-8-223">223</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-8-224">224</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-8-225">225</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-8-226">226</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-8-227">227</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-8-228">228</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-8-229">229</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-8-230">230</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-8-231">231</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-8-232">232</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-8-233">233</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-8-234">234</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-8-235">235</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-8-236">236</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-8-237">237</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-8-238">238</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-8-239">239</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-8-240">240</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-8-241">241</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-8-242">242</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-8-243">243</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-8-244">244</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-8-245">245</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-8-246">246</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-8-247">247</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-8-248">248</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-8-249">249</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-8-250">250</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-8-251">251</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-8-252">252</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-8-253">253</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-8-254">254</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-8-255">255</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-8-256">256</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-8-257">257</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-8-258">258</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-8-259">259</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-8-260">260</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-8-261">261</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-223" name="__codelineno-8-223"></a>resource &quot;azurerm_virtual_machine&quot; &quot;paas&quot; {
<a id="__codelineno-8-224" name="__codelineno-8-224"></a>  name                  = &quot;paasvm&quot;
<a id="__codelineno-8-225" name="__codelineno-8-225"></a>  location              = data.azurerm_resource_group.paas.location
<a id="__codelineno-8-226" name="__codelineno-8-226"></a>  resource_group_name   = data.azurerm_resource_group.paas.name
<a id="__codelineno-8-227" name="__codelineno-8-227"></a>  network_interface_ids = [azurerm_network_interface.paas.id]
<a id="__codelineno-8-228" name="__codelineno-8-228"></a>  vm_size               = &quot;Standard_DS2_v2&quot;
<a id="__codelineno-8-229" name="__codelineno-8-229"></a>
<a id="__codelineno-8-230" name="__codelineno-8-230"></a>  storage_image_reference {
<a id="__codelineno-8-231" name="__codelineno-8-231"></a>    id = data.azurerm_image.search.id
<a id="__codelineno-8-232" name="__codelineno-8-232"></a>  }
<a id="__codelineno-8-233" name="__codelineno-8-233"></a>
<a id="__codelineno-8-234" name="__codelineno-8-234"></a>  delete_os_disk_on_termination = false
<a id="__codelineno-8-235" name="__codelineno-8-235"></a>
<a id="__codelineno-8-236" name="__codelineno-8-236"></a>  storage_os_disk {
<a id="__codelineno-8-237" name="__codelineno-8-237"></a>    name              = &quot;paasdisk1&quot;
<a id="__codelineno-8-238" name="__codelineno-8-238"></a>    create_option     = &quot;FromImage&quot;
<a id="__codelineno-8-239" name="__codelineno-8-239"></a>    caching           = &quot;ReadWrite&quot;
<a id="__codelineno-8-240" name="__codelineno-8-240"></a>    managed_disk_type = &quot;StandardSSD_LRS&quot;
<a id="__codelineno-8-241" name="__codelineno-8-241"></a>  }
<a id="__codelineno-8-242" name="__codelineno-8-242"></a>
<a id="__codelineno-8-243" name="__codelineno-8-243"></a>  identity {
<a id="__codelineno-8-244" name="__codelineno-8-244"></a>    type = &quot;UserAssigned&quot;
<a id="__codelineno-8-245" name="__codelineno-8-245"></a>    identity_ids = [
<a id="__codelineno-8-246" name="__codelineno-8-246"></a>      azurerm_user_assigned_identity.paas_vm.id
<a id="__codelineno-8-247" name="__codelineno-8-247"></a>    ]
<a id="__codelineno-8-248" name="__codelineno-8-248"></a>  }
<a id="__codelineno-8-249" name="__codelineno-8-249"></a>
<a id="__codelineno-8-250" name="__codelineno-8-250"></a>  os_profile {
<a id="__codelineno-8-251" name="__codelineno-8-251"></a>    computer_name  = &quot;paasvm&quot;
<a id="__codelineno-8-252" name="__codelineno-8-252"></a>    admin_username = &quot;kubeapps&quot;
<a id="__codelineno-8-253" name="__codelineno-8-253"></a>    admin_password = azurerm_key_vault_secret.paas_all_secrets[&quot;vm_password&quot;].value
<a id="__codelineno-8-254" name="__codelineno-8-254"></a>
<a id="__codelineno-8-255" name="__codelineno-8-255"></a>    # ... For later
<a id="__codelineno-8-256" name="__codelineno-8-256"></a>  }
<a id="__codelineno-8-257" name="__codelineno-8-257"></a>
<a id="__codelineno-8-258" name="__codelineno-8-258"></a>  os_profile_linux_config {
<a id="__codelineno-8-259" name="__codelineno-8-259"></a>    disable_password_authentication = false
<a id="__codelineno-8-260" name="__codelineno-8-260"></a>  }
<a id="__codelineno-8-261" name="__codelineno-8-261"></a>}
</code></pre></div></td></tr></table></div>
<ul>
<li>
<p>Tout en haut nous avons associé une interface réseau à la vm, définit le groupe, la zone et l'abonnement CPU azure <a href="https://azure.microsoft.com/fr-fr/pricing/details/virtual-machines/series/">explication des séries</a>. Ici nous avons choisi une machine classique pour des besoins de production.</p>
</li>
<li>
<p><code>storage_image_reference</code> permet d'indiquer l'image à utiliser pour la vm. Ici on utilise notre image que l'on récupère avec un datasource <code>azurerm_image</code>.</p>
</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">infra/data.tf</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-9-5">5</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-9-6">6</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-9-7">7</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-9-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-9-5" name="__codelineno-9-5"></a>data &quot;azurerm_image&quot; &quot;search&quot; {
<a id="__codelineno-9-6" name="__codelineno-9-6"></a>  name                = &quot;kubeapps-az-arm&quot;
<a id="__codelineno-9-7" name="__codelineno-9-7"></a>  resource_group_name = data.azurerm_resource_group.paas.name
<a id="__codelineno-9-8" name="__codelineno-9-8"></a>}
</code></pre></div></td></tr></table></div>
<ul>
<li><code>storage_os_disk</code> défini le type de disque dur, son nom et sa source si on utilise une image existante comme c'est le cas ici.</li>
</ul>
<blockquote>
<p><strong>Warning</strong> <code>delete_os_disk_on_termination = false</code> devrait être mis à true en debug pour éviter de bloquer le <code>terraform destroy</code></p>
</blockquote>
<ul>
<li><code>identity</code> associe à l'identité azure créer précédemment. Cela permettra à la vm de récupérer les secrets du keyvault.</li>
</ul>
<h3 id="3-3-terraform-azure-network-vm-provision-final-de-la-machine-virtuelle">Provision final de la machine virtuelle<a class="headerlink" href="#3-3-terraform-azure-network-vm-provision-final-de-la-machine-virtuelle" title="Permanent link">&para;</a></h3>
<p>Nous allons donc recourrir au <a href="https://cloudinit.readthedocs.io/en/latest/topics/modules.html#ansible">module cloud init ansible</a> déclenché automatiquement au provision azure de la vm grâce à quelques configurations.</p>
<p>Ce fichier cloud-init.yml est un <a href="https://developer.hashicorp.com/terraform/language/functions/templatefile">template terraform</a> qui va être utilisé pour générer un fichier cloud-init.yml final. On peut y injecter des variables au travers de la propriété <code>custom_data</code> du sous module <code>os_profile</code> de <code>azurerm_linux_virtual_machine</code> et de la fonction <code>templatefile</code> de terraform.</p>
<blockquote>
<p><strong>Note</strong> En interne ce fichier sera converti en base64 et injecté dans la vm</p>
</blockquote>
<p>On ajoute donc un objet avec toutes les variables requises au bon fonctionnement du playbook.</p>
<p>On rappelé que <code>vault_url</code> est une variable qui contient l'url du keyvault azure et que l'on va l'utiliser avec ansible et le plugin lookup <a href="https://docs.ansible.com/ansible/devel/collections/azure/azcollection/azure_keyvault_secret_lookup.html"><code>azure_keyvault_secret</code></a> pour récupérer les secrets.</p>
<blockquote>
<p><strong>Note</strong> L'inventaire <a href="#3-3-terraform-azure-network-vm-playbook-inventories">playbook/inventories</a> a été créer dans les étapes précédentes et se trouve dans notre image créer avec <code>packer</code></p>
</blockquote>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">infra/main.tf</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-10-259">259</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-10-260">260</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-10-261">261</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-10-262">262</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-10-263">263</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-10-264">264</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-10-265">265</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-10-266">266</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-10-267">267</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-10-268">268</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-10-269">269</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-10-259" name="__codelineno-10-259"></a><span class="w">    </span><span class="na">custom_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">templatefile</span><span class="p">(</span>
<a id="__codelineno-10-260" name="__codelineno-10-260"></a><span class="w">      </span><span class="s2">&quot;${path.module}/cloud-init.yaml&quot;</span><span class="p">,</span>
<a id="__codelineno-10-261" name="__codelineno-10-261"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-10-262" name="__codelineno-10-262"></a><span class="w">        </span><span class="na">kubeapps_hostname</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;kubeapps.${azurerm_dns_zone.paas.name}&quot;</span>
<a id="__codelineno-10-263" name="__codelineno-10-263"></a><span class="w">        </span><span class="na">dex_hostname</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dex.${azurerm_dns_zone.paas.name}&quot;</span>
<a id="__codelineno-10-264" name="__codelineno-10-264"></a><span class="w">        </span><span class="na">vault_url</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="nv">azurerm_key_vault.paas.vault_uri</span>
<a id="__codelineno-10-265" name="__codelineno-10-265"></a><span class="w">        </span><span class="na">dex_github_client_org</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nv">data.github_organization.org.orgname</span>
<a id="__codelineno-10-266" name="__codelineno-10-266"></a><span class="w">        </span><span class="na">dex_github_client_team</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">github_team.opsteam.name</span>
<a id="__codelineno-10-267" name="__codelineno-10-267"></a><span class="w">        </span><span class="na">cert_manager_letsencrypt_env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.cert_manager_letsencrypt_env</span>
<a id="__codelineno-10-268" name="__codelineno-10-268"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-10-269" name="__codelineno-10-269"></a><span class="w">    </span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>
<p><code>datasource</code> configure le module pour qu'il récupère les informations de la vm azure (notamment les secrets du keyvault)</p>
</li>
<li>
<p><code>ansible</code> permet de construire une commande ansible qui va être exécutée au démarrage de la vm. Il s'agit d'un template terraform</p>
</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">infra/cloud-init.yml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-11-1"> 1</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-11-2"> 2</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-11-3"> 3</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-11-4"> 4</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-11-5"> 5</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-11-6"> 6</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-11-7"> 7</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-11-8"> 8</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-11-9"> 9</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-11-10">10</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-11-11">11</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-11-12">12</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-11-13">13</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-11-14">14</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-11-15">15</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-11-16">16</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-11-17">17</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-11-18">18</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-11-19">19</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-11-20">20</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-11-21">21</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-11-22">22</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-11-23">23</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-11-24">24</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-11-25">25</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-11-26">26</a></span>
<span class="normal"><a href="#3-3-terraform-azure-network-vm-__codelineno-11-27">27</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="c1">#cloud-config</span>
<a id="__codelineno-11-2" name="__codelineno-11-2"></a>
<a id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="nt">datasource</span><span class="p">:</span>
<a id="__codelineno-11-4" name="__codelineno-11-4"></a><span class="w">  </span><span class="nt">Azure</span><span class="p">:</span>
<a id="__codelineno-11-5" name="__codelineno-11-5"></a><span class="w">    </span><span class="nt">apply_network_config</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-11-6" name="__codelineno-11-6"></a><span class="w">    </span><span class="nt">data_dir</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/lib/waagent</span>
<a id="__codelineno-11-7" name="__codelineno-11-7"></a><span class="w">    </span><span class="nt">disk_aliases</span><span class="p">:</span>
<a id="__codelineno-11-8" name="__codelineno-11-8"></a><span class="w">      </span><span class="nt">ephemeral0</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/dev/disk/cloud/azure_resource</span>
<a id="__codelineno-11-9" name="__codelineno-11-9"></a>
<a id="__codelineno-11-10" name="__codelineno-11-10"></a><span class="nt">runcmd</span><span class="p">:</span>
<a id="__codelineno-11-11" name="__codelineno-11-11"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">sleep</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">20</span><span class="p p-Indicator">]</span>
<a id="__codelineno-11-12" name="__codelineno-11-12"></a>
<a id="__codelineno-11-13" name="__codelineno-11-13"></a><span class="nt">ansible</span><span class="p">:</span>
<a id="__codelineno-11-14" name="__codelineno-11-14"></a><span class="w">  </span><span class="nt">install_method</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pip</span>
<a id="__codelineno-11-15" name="__codelineno-11-15"></a><span class="w">  </span><span class="nt">package_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ansible</span>
<a id="__codelineno-11-16" name="__codelineno-11-16"></a><span class="w">  </span><span class="nt">setup_controller</span><span class="p">:</span>
<a id="__codelineno-11-17" name="__codelineno-11-17"></a><span class="w">    </span><span class="nt">run_ansible</span><span class="p">:</span>
<a id="__codelineno-11-18" name="__codelineno-11-18"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">playbook_dir</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/playbook</span>
<a id="__codelineno-11-19" name="__codelineno-11-19"></a><span class="w">        </span><span class="nt">inventory</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/playbook/inventories/azure/hosts</span>
<a id="__codelineno-11-20" name="__codelineno-11-20"></a><span class="w">        </span><span class="nt">playbook_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">site.yaml</span>
<a id="__codelineno-11-21" name="__codelineno-11-21"></a><span class="w">        </span><span class="nt">extra_vars</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;vault_url=${vault_url}</span>
<a id="__codelineno-11-22" name="__codelineno-11-22"></a><span class="w">           </span><span class="s">dex_github_client_org=${dex_github_client_org}</span>
<a id="__codelineno-11-23" name="__codelineno-11-23"></a><span class="w">           </span><span class="s">dex_github_client_team=${dex_github_client_team}</span>
<a id="__codelineno-11-24" name="__codelineno-11-24"></a><span class="w">           </span><span class="s">cert_manager_letsencrypt_env=${cert_manager_letsencrypt_env}</span>
<a id="__codelineno-11-25" name="__codelineno-11-25"></a><span class="w">           </span><span class="s">kubeapps_hostname=${kubeapps_hostname}</span>
<a id="__codelineno-11-26" name="__codelineno-11-26"></a><span class="w">           </span><span class="s">dex_hostname=${dex_hostname}</span><span class="nv"> </span><span class="s">-o</span><span class="nv"> </span><span class="s">&#39;IdentitiesOnly=yes&#39;&quot;</span>
<a id="__codelineno-11-27" name="__codelineno-11-27"></a><span class="w">        </span><span class="nt">connection</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local</span>
</code></pre></div></td></tr></table></div>
<h4 id="3-3-terraform-azure-network-vm-application-de-linfrastructure-finale">Application de l'infrastructure finale<a class="headerlink" href="#3-3-terraform-azure-network-vm-application-de-linfrastructure-finale" title="Permanent link">&para;</a></h4>
<p>Puis appliquer l'infrastructure sans message de confirmation :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#3-3-terraform-azure-network-vm-__codelineno-12-1"></a>terraform<span class="w"> </span>apply<span class="w"> </span>-auto-approve<span class="w"> </span>-var-file<span class="w"> </span>prod.tfvars
</code></pre></div>
<blockquote>
<p><code>-var-file</code> est indispensable pour charger les variables de l'environnement, sans ça vous êtes obligé de rentrer les variables à la main.</p>
</blockquote>
<hr /></section><section class="print-page" id="4-1-helm-chart"><h1 id="4-1-helm-chart-41-creation-du-helm-chart">4.1 Création du Helm chart<a class="headerlink" href="#4-1-helm-chart-41-creation-du-helm-chart" title="Permanent link">&para;</a></h1>
<p>Pour rappel helm est le gestionnaire de packages pour Kubernetes. Il vous aide à piloter Kubernetes à l’aide de cartes de navigation, appelés Charts en anglais. Nous allons donc en créer une pour le microservice que nous avons créé.</p>
<p>Un "chart" est une collection de fichiers organisés dans une structure de répertoire spécifique. Ces fichiers décrivent un ensemble de ressources Kubernetes et leur configuration de manière dynamique.</p>
<p>Une instance exécutée d'une chart avec une configuration spécifique est appelée une release.</p>
<p>Ce chart sert à implémenter les fonctionnalités d'un ensemble de manifests kubernetes <code>deployment,service,ingress</code>. Nous n'allons pas aller trop loin et nous contenter de seulement ces fonctionnalités de déploiement. Nous aurons un chart générique que l'on va utiliser pour chaque micro services.</p>
<blockquote>
<p>Warning: La configuration que nous allons concevoir est très simple et ne prend pas en compte les bonnes pratiques de sécurité au niveau de des utilisateurs de postgresql.</p>
</blockquote>
<h3 id="4-1-helm-chart-installation">Installation<a class="headerlink" href="#4-1-helm-chart-installation" title="Permanent link">&para;</a></h3>
<p>Sur Linux / mac
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#4-1-helm-chart-__codelineno-0-1"></a>curl<span class="w"> </span>https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3<span class="w"> </span><span class="p">|</span><span class="w"> </span>bash
</code></pre></div></p>
<p>Si vous utilisez homebrew : <code>brew install helm</code> </p>
<p>On vérifie avec <code>helm --version</code></p>
<h3 id="4-1-helm-chart-deploiement-des-containers-des-microservices-sur-un-registre">Déploiement des containers des microservices sur un registre<a class="headerlink" href="#4-1-helm-chart-deploiement-des-containers-des-microservices-sur-un-registre" title="Permanent link">&para;</a></h3>
<p>Nous avons besoin pour utiliser un container dans un chart helm et donc dans un pod kube, de les déployer sur un registre. </p>
<blockquote>
<p>Un registre de containers consiste à stocker des images de containers pour pouvoir les utiliser facilement avec une technologie de conteneurisation.</p>
</blockquote>
<p>Nous allons utiliser docker hub pour déployer nos containers de manière publique pour bénéficier de la gratuité du stockage des images.</p>
<p>Tout d'abord rancher (docker) doit être lancé avant de déployer les containers et vous devez vous placer dans votre projet maven / spring boot.</p>
<p>Ensuite, connectez-vous à votre docker hub avec <code>docker login</code> et créez un repository pour chaque microservice. Voici un exemple pour le microservice <code>client</code>.</p>
<p><img alt="docker hub repository" src="../images/docker-hub.png" /></p>
<p>Ensuite dans le dossier d'un microservice lancer la commande maven suivante. (on est toujours sur l'exemple du microservice <code>client</code>)</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#4-1-helm-chart-__codelineno-1-1"></a>mvn<span class="w"> </span>spring-boot:build-image<span class="w"> </span>-Dspring-boot.build-image.imageName<span class="o">=</span>loicroux/client
</code></pre></div>
<p>Le build devrait se terminé par un message comme celui ci :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#4-1-helm-chart-__codelineno-2-1"></a>Successfully built image &#39;docker.io/loicroux/client:latest&#39;
</code></pre></div>
<p>Puis pousser l'image avec un tag de version pour pouvoir la pull avec kubernetes après :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#4-1-helm-chart-__codelineno-3-1"></a>docker<span class="w"> </span>push<span class="w"> </span>loicroux/client:latest
</code></pre></div>
<h3 id="4-1-helm-chart-creation-dun-chart-pour-un-microservice">Création d'un chart pour un microservice<a class="headerlink" href="#4-1-helm-chart-creation-dun-chart-pour-un-microservice" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#4-1-helm-chart-__codelineno-4-1"></a>mkdir<span class="w"> </span>charts
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#4-1-helm-chart-__codelineno-4-2"></a>helm<span class="w"> </span>create<span class="w"> </span>charts/microservice
</code></pre></div>
<p>Dans le répertoire <code>charts/microservice</code> nous avons :</p>
<ul>
<li>un répertoire <code>templates</code> qui contient les fichiers de déploiement. </li>
<li>un fichier <code>Chart.yaml</code> qui contient les informations sur le chart</li>
<li>un fichier <code>values.yaml</code> qui contient les valeurs par défaut du chart</li>
</ul>
<p>Nous allons donc modifier notre <code>values.yaml</code> pour mettre en place plusieurs microservices et les déployer avec un seul chart.
Tout d'abord il va falloir que nos containers soit déployer sur un registre, nous allons utiliser docker hub pour placer des containers générés construit automatiquement par le module <code>buildImage</code> de spring.</p>
<p>Dans ce chart nous allons mettre en places des défauts pour faire fonctionner directement les microservices sur la paas sans configurations supplémentaires.</p>
<p>On change donc seulement les valeurs par défaut du ingress pour qu'il utilise traefik et le cert-manager de notre paas.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">chart/values.yml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#4-1-helm-chart-__codelineno-5-46">46</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-5-47">47</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-5-48">48</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-46" name="__codelineno-5-46"></a><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<a id="__codelineno-5-47" name="__codelineno-5-47"></a><span class="w">    </span><span class="nt">kubernetes.io/ingress.class</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">traefik</span>
<a id="__codelineno-5-48" name="__codelineno-5-48"></a><span class="w">    </span><span class="nt">cert-manager.io/cluster-issuer</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">letsencrypt-acme-issuer</span>
</code></pre></div></td></tr></table></div>
<p>Ensuite, on ajoute la possibilité de configurer le port du container car dans notre helm par défaut il est forcé sur 80 alors que nos microservice utilisent tous des ports différents.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">chart/values.yml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#4-1-helm-chart-__codelineno-6-53">53</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-6-54">54</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-53" name="__codelineno-6-53"></a><span class="nt">container</span><span class="p">:</span>
<a id="__codelineno-6-54" name="__codelineno-6-54"></a><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
</code></pre></div></td></tr></table></div>
<p>Puis dans le template <code>deployment.yaml</code> on place cette configuration dynamique :</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">charts/microservice/templates/deployment.yaml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#4-1-helm-chart-__codelineno-7-38">38</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-7-39">39</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-7-40">40</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-7-41">41</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-38" name="__codelineno-7-38"></a><span class="w">          </span><span class="nt">ports</span><span class="p">:</span>
<a id="__codelineno-7-39" name="__codelineno-7-39"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http</span>
<a id="__codelineno-7-40" name="__codelineno-7-40"></a><span class="w">              </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">.Values.container.port</span><span class="w"> </span><span class="p p-Indicator">}}</span>
<a id="__codelineno-7-41" name="__codelineno-7-41"></a><span class="w">              </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
</code></pre></div></td></tr></table></div>
<p>On va aussi enlever le endpoint de vérification de la santé d'un service car nous n'avons pas de route <code>/actuator/health</code> (module de spring boot) dans nos microservices.</p>
<p><strong>Voici les lignes à supprimer</strong> :</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">charts/microservice/templates/deployment.yaml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#4-1-helm-chart-__codelineno-8-42">42</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-8-43">43</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-8-44">44</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-8-45">45</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-8-46">46</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-8-47">47</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-8-48">48</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-8-49">49</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-42" name="__codelineno-8-42"></a><span class="w">          </span><span class="nt">livenessProbe</span><span class="p">:</span>
<a id="__codelineno-8-43" name="__codelineno-8-43"></a><span class="w">            </span><span class="nt">httpGet</span><span class="p">:</span>
<a id="__codelineno-8-44" name="__codelineno-8-44"></a><span class="w">              </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/</span>
<a id="__codelineno-8-45" name="__codelineno-8-45"></a><span class="w">              </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http</span>
<a id="__codelineno-8-46" name="__codelineno-8-46"></a><span class="w">          </span><span class="nt">readinessProbe</span><span class="p">:</span>
<a id="__codelineno-8-47" name="__codelineno-8-47"></a><span class="w">            </span><span class="nt">httpGet</span><span class="p">:</span>
<a id="__codelineno-8-48" name="__codelineno-8-48"></a><span class="w">              </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/</span>
<a id="__codelineno-8-49" name="__codelineno-8-49"></a><span class="w">              </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http</span>
</code></pre></div></td></tr></table></div>
<h3 id="4-1-helm-chart-mise-en-place-de-la-dependance-du-micro-service-postgres">Mise en place de la dépendance du micro service : postgres<a class="headerlink" href="#4-1-helm-chart-mise-en-place-de-la-dependance-du-micro-service-postgres" title="Permanent link">&para;</a></h3>
<p>Avant de déployer notre microservice on sait que l'on a besoin d'une base de données postgres. On va donc ajouter comme <a href="https://bitnami.com/stack/postgresql/helm">dépendance</a> le chart bitnami de postgres au nôtre.</p>
<p>On va donc modifier le fichier <code>Chart.yaml</code> pour ajouter la dépendance.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">charts/microservice/Chart.yaml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#4-1-helm-chart-__codelineno-9-26">26</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-9-27">27</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-9-28">28</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-9-29">29</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-9-26" name="__codelineno-9-26"></a><span class="nt">dependencies</span><span class="p">:</span>
<a id="__codelineno-9-27" name="__codelineno-9-27"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgresql</span>
<a id="__codelineno-9-28" name="__codelineno-9-28"></a><span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">~12.1.9</span>
<a id="__codelineno-9-29" name="__codelineno-9-29"></a><span class="w">    </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://charts.bitnami.com/bitnami</span>
</code></pre></div></td></tr></table></div>
<blockquote>
<p><code>~</code> Signifie qu'on garde les versions de patch sans passer à la majeure ou mineure suivante.</p>
</blockquote>
<p>Puis on met à jour les dépendances avec la commande <code>helm dependency update charts/microservice</code>.</p>
<blockquote>
<p>Cette commande génère un <code>Chart.lock</code> qui va permettre de bloquer les versions des dépendances.</p>
</blockquote>
<p>Il est temps de configurer un emplacement de stockage permanent pour votre déploiement PostgreSQL. Pour ce faire, vous allez créer un <code>PersistentVolume</code> (PV) et un <code>PersistentVolumeClaim</code> (PVC) dans Kubernetes.</p>
<p>Un PV est une ressource Kubernetes qui est utilisée pour stocker les données de vos applications. Il existe plusieurs types de PV pris en charge par Kubernetes, tels que les répertoires locaux et les fournisseurs de stockage cloud tiers tels qu'Amazon EBS et AzureDisk.</p>
<p>Un PVC est un moyen pour votre application d'utiliser un PV spécifique. Le PVC est utilisé pour monter le PV au pod de votre application.</p>
<p>Pour créer un stockage persistant, vous devrez créer deux nouveaux manifests Kubernetes que l'on place tous les deux dans un template volume.yaml. Le premier manifeste est un PV qui définit le stockage persistant. Le second manifeste est un PVC qui définit la revendication de stockage persistant.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">charts/microservice/templates/persistence.yaml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#4-1-helm-chart-__codelineno-10-1"> 1</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-10-2"> 2</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-10-3"> 3</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-10-4"> 4</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-10-5"> 5</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-10-6"> 6</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-10-7"> 7</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-10-8"> 8</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-10-9"> 9</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-10-10">10</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-10-11">11</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-10-12">12</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-10-13">13</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-10-14">14</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-10-15">15</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-10-16">16</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-10-17">17</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-10-18">18</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-10-19">19</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-10-20">20</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-10-21">21</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-10-22">22</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-10-23">23</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-10-24">24</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-10-25">25</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-10-26">26</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PersistentVolume</span><span class="w"> </span><span class="c1"># Create a PV</span>
<a id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-10-4" name="__codelineno-10-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgresql-data</span><span class="w"> </span><span class="c1"># Sets PV&#39;s name</span>
<a id="__codelineno-10-5" name="__codelineno-10-5"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<a id="__codelineno-10-6" name="__codelineno-10-6"></a><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local</span><span class="w"> </span><span class="c1"># Sets PV&#39;s type to local</span>
<a id="__codelineno-10-7" name="__codelineno-10-7"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-10-8" name="__codelineno-10-8"></a><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">manual</span>
<a id="__codelineno-10-9" name="__codelineno-10-9"></a><span class="w">  </span><span class="nt">capacity</span><span class="p">:</span>
<a id="__codelineno-10-10" name="__codelineno-10-10"></a><span class="w">    </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10Gi</span><span class="w"> </span><span class="c1"># Sets PV Volume</span>
<a id="__codelineno-10-11" name="__codelineno-10-11"></a><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span>
<a id="__codelineno-10-12" name="__codelineno-10-12"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span>
<a id="__codelineno-10-13" name="__codelineno-10-13"></a><span class="w">  </span><span class="nt">hostPath</span><span class="p">:</span>
<a id="__codelineno-10-14" name="__codelineno-10-14"></a><span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/data/volume&quot;</span><span class="w"> </span><span class="c1"># Sets the volume&#39;s path</span>
<a id="__codelineno-10-15" name="__codelineno-10-15"></a><span class="nn">---</span>
<a id="__codelineno-10-16" name="__codelineno-10-16"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id="__codelineno-10-17" name="__codelineno-10-17"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PersistentVolumeClaim</span><span class="w"> </span><span class="c1"># Create PVC</span>
<a id="__codelineno-10-18" name="__codelineno-10-18"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-10-19" name="__codelineno-10-19"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgresql-data-claim</span><span class="w"> </span><span class="c1"># Sets name of PV</span>
<a id="__codelineno-10-20" name="__codelineno-10-20"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-10-21" name="__codelineno-10-21"></a><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">manual</span>
<a id="__codelineno-10-22" name="__codelineno-10-22"></a><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span>
<a id="__codelineno-10-23" name="__codelineno-10-23"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span><span class="w"> </span><span class="c1"># Sets read and write access</span>
<a id="__codelineno-10-24" name="__codelineno-10-24"></a><span class="w">  </span><span class="nt">resources</span><span class="p">:</span>
<a id="__codelineno-10-25" name="__codelineno-10-25"></a><span class="w">    </span><span class="nt">requests</span><span class="p">:</span>
<a id="__codelineno-10-26" name="__codelineno-10-26"></a><span class="w">      </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2Gi</span><span class="w"> </span><span class="c1"># Sets volume size</span>
</code></pre></div></td></tr></table></div>
<h3 id="4-1-helm-chart-helper-et-secrets-dans-helm">Helper et secrets dans helm<a class="headerlink" href="#4-1-helm-chart-helper-et-secrets-dans-helm" title="Permanent link">&para;</a></h3>
<p>Nous avons besoin de pouvoir configurer nos microservices facilement avec des variables et des identifiants divers comme la connexion à la base de données. Pour cela nous allons créer notre propre helper et des manifests kubernetes pour utiliser des secrets.</p>
<p>On va donc remplir un fichier de secret comme ceci :</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">charts/microservice/templates/secrets.yaml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#4-1-helm-chart-__codelineno-11-1">1</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-11-2">2</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-11-3">3</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-11-4">4</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-11-5">5</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-11-6">6</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-11-7">7</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-11-8">8</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-11-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id="__codelineno-11-2" name="__codelineno-11-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Secret</span>
<a id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-11-4" name="__codelineno-11-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">.Values.secret.name</span><span class="w"> </span><span class="p p-Indicator">}}</span>
<a id="__codelineno-11-5" name="__codelineno-11-5"></a><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Opaque</span>
<a id="__codelineno-11-6" name="__codelineno-11-6"></a><span class="nt">data</span><span class="p">:</span>
<a id="__codelineno-11-7" name="__codelineno-11-7"></a><span class="w">  </span><span class="p p-Indicator">{{</span><span class="nv">- range $key</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">$val</span><span class="w"> </span><span class="p p-Indicator">:</span><span class="nv">= .Values.env.secret</span><span class="w"> </span><span class="p p-Indicator">}}</span>
<a id="__codelineno-11-8" name="__codelineno-11-8"></a><span class="w">  </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">$key</span><span class="w"> </span><span class="p p-Indicator">}}:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">$val | b64enc</span><span class="w"> </span><span class="p p-Indicator">}}</span>
<a id="__codelineno-11-9" name="__codelineno-11-9"></a><span class="w">  </span><span class="p p-Indicator">{{</span><span class="nv">- end</span><span class="p p-Indicator">}}</span>
</code></pre></div></td></tr></table></div>
<p>Ensuite ce fichier de template va permettre de définir comme une fonction (helper) qui va récupérer les secrets et les injecter sous forme de variable d'environnement dans les pods.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">charts/microservice/templates/_helpers.tpl</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#4-1-helm-chart-__codelineno-12-1"> 1</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-12-2"> 2</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-12-3"> 3</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-12-4"> 4</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-12-5"> 5</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-12-6"> 6</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-12-7"> 7</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-12-8"> 8</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-12-9"> 9</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-12-10">10</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-12-11">11</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-12-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1"></a>{{/*
<a id="__codelineno-12-2" name="__codelineno-12-2"></a>Create the secrets required for our app as environment var
<a id="__codelineno-12-3" name="__codelineno-12-3"></a>*/}}
<a id="__codelineno-12-4" name="__codelineno-12-4"></a>{{- define &quot;helpers.listEnvVariables&quot;}}
<a id="__codelineno-12-5" name="__codelineno-12-5"></a>{{- range $key, $val := .Values.env.secret }}
<a id="__codelineno-12-6" name="__codelineno-12-6"></a>- name: {{ $key }}
<a id="__codelineno-12-7" name="__codelineno-12-7"></a>  valueFrom:
<a id="__codelineno-12-8" name="__codelineno-12-8"></a>    secretKeyRef:
<a id="__codelineno-12-9" name="__codelineno-12-9"></a>      name: {{ $.Values.secret.name }}
<a id="__codelineno-12-10" name="__codelineno-12-10"></a>      key: {{ $key }}
<a id="__codelineno-12-11" name="__codelineno-12-11"></a>{{- end}}
<a id="__codelineno-12-12" name="__codelineno-12-12"></a>{{- end }}
</code></pre></div></td></tr></table></div>
<p>Puis, il est utilisé dans le fichier de deployment avec la clé <code>containers</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">charts/microservice/templates/deployment.yaml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#4-1-helm-chart-__codelineno-13-36">36</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-13-37">37</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-13-36" name="__codelineno-13-36"></a><span class="w">          </span><span class="nt">env</span><span class="p">:</span>
<a id="__codelineno-13-37" name="__codelineno-13-37"></a><span class="w">            </span><span class="p p-Indicator">{{</span><span class="nv">- include &quot;helpers.listEnvVariables&quot; . | indent 10</span><span class="w"> </span><span class="p p-Indicator">}}</span>
</code></pre></div></td></tr></table></div>
<p>Enfin on ne doit pas oublier de définir les valeurs par défaut dans le fichier <code>values.yaml</code>:</p>
<blockquote>
<p>On prépare d'avance les variables de connection au serveur de base de données que l'on teste en local (rôle kubeapps, <code>molecule test --destroy never</code>)</p>
</blockquote>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">charts/microservice/values.yaml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#4-1-helm-chart-__codelineno-14-17">17</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-14-18">18</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-14-19">19</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-14-20">20</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-14-21">21</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-14-22">22</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-14-23">23</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-14-17" name="__codelineno-14-17"></a><span class="nt">secret</span><span class="p">:</span>
<a id="__codelineno-14-18" name="__codelineno-14-18"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">all-secrets</span>
<a id="__codelineno-14-19" name="__codelineno-14-19"></a><span class="nt">env</span><span class="p">:</span>
<a id="__codelineno-14-20" name="__codelineno-14-20"></a><span class="w">  </span><span class="nt">secret</span><span class="p">:</span>
<a id="__codelineno-14-21" name="__codelineno-14-21"></a><span class="w">    </span><span class="nt">PG_USER</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ekommerce</span>
<a id="__codelineno-14-22" name="__codelineno-14-22"></a><span class="w">    </span><span class="nt">PG_CONNECTION</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">jdbc:postgresql://client-postgresql.default.svc.cluster.local:5432/db</span>
<a id="__codelineno-14-23" name="__codelineno-14-23"></a><span class="w">    </span><span class="nt">PG_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">password</span>
</code></pre></div></td></tr></table></div>
<p>Puis on configure le chart postgres pour qu'il utilise les secrets et le "persistence volume" définis dans le chart microservice.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">charts/microservice/values.yaml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#4-1-helm-chart-__codelineno-15-25">25</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-15-26">26</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-15-27">27</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-15-28">28</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-15-29">29</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-15-30">30</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-15-31">31</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-15-32">32</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-15-33">33</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-15-34">34</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-15-35">35</a></span>
<span class="normal"><a href="#4-1-helm-chart-__codelineno-15-36">36</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-15-25" name="__codelineno-15-25"></a><span class="nt">postgresql</span><span class="p">:</span>
<a id="__codelineno-15-26" name="__codelineno-15-26"></a><span class="w">  </span><span class="nt">auth</span><span class="p">:</span>
<a id="__codelineno-15-27" name="__codelineno-15-27"></a><span class="w">    </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">password</span>
<a id="__codelineno-15-28" name="__codelineno-15-28"></a><span class="w">    </span><span class="nt">enablePostgresUser</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<a id="__codelineno-15-29" name="__codelineno-15-29"></a><span class="w">    </span><span class="nt">database</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">db</span>
<a id="__codelineno-15-30" name="__codelineno-15-30"></a><span class="w">    </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ekommerce</span>
<a id="__codelineno-15-31" name="__codelineno-15-31"></a><span class="w">  </span><span class="nt">volumePermissions</span><span class="p">:</span>
<a id="__codelineno-15-32" name="__codelineno-15-32"></a><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-15-33" name="__codelineno-15-33"></a><span class="w">  </span><span class="nt">primary</span><span class="p">:</span>
<a id="__codelineno-15-34" name="__codelineno-15-34"></a><span class="w">    </span><span class="nt">persistence</span><span class="p">:</span>
<a id="__codelineno-15-35" name="__codelineno-15-35"></a><span class="w">      </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-15-36" name="__codelineno-15-36"></a><span class="w">      </span><span class="nt">existingClaim</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;postgresql-data-claim&quot;</span>
</code></pre></div></td></tr></table></div>
<p>Nous pouvons vérifier avec <code>helm lint charts/microservice</code> si il n'y a pas d'erreurs puis aussi voir le résultat de notre chart avec <code>helm template charts/microservice</code></p></section><section class="print-page" id="4-2-helm-chart-deploy"><h1 id="4-2-helm-chart-deploy-42-deploiement-du-chart">4.2 Déploiement du chart<a class="headerlink" href="#4-2-helm-chart-deploy-42-deploiement-du-chart" title="Permanent link">&para;</a></h1>
<p>Si vous n'avez pas suivi le tutoriel en utilisant un repository git, vous pouvez créer un repository sur github pour votre organisation avec ce type d'url : <a href="https://github.com/organizations/&lt;votre-org&gt;/repositories/new">https://github.com/organizations/<votre-org>/repositories/new</a>. Ceci vous permettra de mettre à disposition un repository helm grâce github pages et ainsi d'utiliser le chart sur le cluster kubernetes.</p>
<blockquote>
<p>Nous utiliserons l'outil CD <a href="https://helm.sh/docs/howto/chart_releaser_action/">chart_releaser_action</a> développé pour automatisé la publication de chart avec github actions (CI/CD)</p>
</blockquote>
<p>On va donc initialiser un repository git et pour l'instant ne pas y ajouter le chart tout de suite :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#4-2-helm-chart-deploy-__codelineno-0-1"></a>git<span class="w"> </span>init
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#4-2-helm-chart-deploy-__codelineno-0-2"></a>git<span class="w"> </span>remote<span class="w"> </span>add<span class="w"> </span>origin<span class="w"> </span>git@github.com:&lt;my-org&gt;/&lt;my-repo&gt;.git
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#4-2-helm-chart-deploy-__codelineno-0-3"></a>git<span class="w"> </span>add<span class="w"> </span>infra<span class="w"> </span>playbook<span class="w"> </span>README.md
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#4-2-helm-chart-deploy-__codelineno-0-4"></a>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;chore: Helm chart&quot;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#4-2-helm-chart-deploy-__codelineno-0-5"></a>git<span class="w"> </span>push
</code></pre></div>
<blockquote>
<p>Note: Par défaut lorsque l'on initialise un repository git, la branche main est créée.</p>
<p>Note : on ne push pas sur la branche main pour le moment car la CI github n'est pas encore mise en place</p>
</blockquote>
<p>Ensuite, on va placer le dossier chart dans un espace temporaire git "stash" pour le commit plus tard</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#4-2-helm-chart-deploy-__codelineno-1-1"></a>git<span class="w"> </span>add<span class="w"> </span>.
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#4-2-helm-chart-deploy-__codelineno-1-2"></a>git<span class="w"> </span>stash
</code></pre></div>
<p>On créer une branche vide et orpheline pour github pages :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#4-2-helm-chart-deploy-__codelineno-2-1"></a>git<span class="w"> </span>checkout<span class="w"> </span>--orphan<span class="w"> </span>gh-pages
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#4-2-helm-chart-deploy-__codelineno-2-2"></a>git<span class="w"> </span>rm<span class="w"> </span>--cached<span class="w"> </span>-r<span class="w"> </span>.
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#4-2-helm-chart-deploy-__codelineno-2-3"></a><span class="nb">echo</span><span class="w">  </span><span class="s2">&quot;## Pages branch for helm charts&quot;</span><span class="w"> </span>&gt;<span class="w"> </span>README.md
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#4-2-helm-chart-deploy-__codelineno-2-4"></a>git<span class="w"> </span>add<span class="w"> </span>README.md
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#4-2-helm-chart-deploy-__codelineno-2-5"></a>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;init gh pages&quot;</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#4-2-helm-chart-deploy-__codelineno-2-6"></a>git<span class="w"> </span>push<span class="w"> </span>-u<span class="w"> </span>origin<span class="w"> </span>gh-pages
</code></pre></div>
<p>On revient sur la branche main et on laisse la nouvelle aux mains de chart releaser action</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#4-2-helm-chart-deploy-__codelineno-3-1"></a>git<span class="w"> </span>checkout<span class="w"> </span>-f<span class="w"> </span>main
</code></pre></div>
<p>Puis on créer un fichier <code>.github/workflows/release.yml</code> dans lequel on met en place l'automatisation de la publication du chart.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#4-2-helm-chart-deploy-__codelineno-4-1"></a>mkdir<span class="w"> </span>-p<span class="w"> </span>.github/workflows
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#4-2-helm-chart-deploy-__codelineno-4-2"></a>touch<span class="w"> </span>.github/workflows/release.yml
</code></pre></div>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">.github/workflows/release.yml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#4-2-helm-chart-deploy-__codelineno-5-25">25</a></span>
<span class="normal"><a href="#4-2-helm-chart-deploy-__codelineno-5-26">26</a></span>
<span class="normal"><a href="#4-2-helm-chart-deploy-__codelineno-5-27">27</a></span>
<span class="normal"><a href="#4-2-helm-chart-deploy-__codelineno-5-28">28</a></span>
<span class="normal"><a href="#4-2-helm-chart-deploy-__codelineno-5-29">29</a></span>
<span class="normal"><a href="#4-2-helm-chart-deploy-__codelineno-5-30">30</a></span>
<span class="normal"><a href="#4-2-helm-chart-deploy-__codelineno-5-31">31</a></span>
<span class="normal"><a href="#4-2-helm-chart-deploy-__codelineno-5-32">32</a></span>
<span class="normal"><a href="#4-2-helm-chart-deploy-__codelineno-5-33">33</a></span>
<span class="normal"><a href="#4-2-helm-chart-deploy-__codelineno-5-34">34</a></span>
<span class="normal"><a href="#4-2-helm-chart-deploy-__codelineno-5-35">35</a></span>
<span class="normal"><a href="#4-2-helm-chart-deploy-__codelineno-5-36">36</a></span>
<span class="normal"><a href="#4-2-helm-chart-deploy-__codelineno-5-37">37</a></span>
<span class="normal"><a href="#4-2-helm-chart-deploy-__codelineno-5-38">38</a></span>
<span class="normal"><a href="#4-2-helm-chart-deploy-__codelineno-5-39">39</a></span>
<span class="normal"><a href="#4-2-helm-chart-deploy-__codelineno-5-40">40</a></span>
<span class="normal"><a href="#4-2-helm-chart-deploy-__codelineno-5-41">41</a></span>
<span class="normal"><a href="#4-2-helm-chart-deploy-__codelineno-5-42">42</a></span>
<span class="normal"><a href="#4-2-helm-chart-deploy-__codelineno-5-43">43</a></span>
<span class="normal"><a href="#4-2-helm-chart-deploy-__codelineno-5-44">44</a></span>
<span class="normal"><a href="#4-2-helm-chart-deploy-__codelineno-5-45">45</a></span>
<span class="normal"><a href="#4-2-helm-chart-deploy-__codelineno-5-46">46</a></span>
<span class="normal"><a href="#4-2-helm-chart-deploy-__codelineno-5-47">47</a></span>
<span class="normal"><a href="#4-2-helm-chart-deploy-__codelineno-5-48">48</a></span>
<span class="normal"><a href="#4-2-helm-chart-deploy-__codelineno-5-49">49</a></span>
<span class="normal"><a href="#4-2-helm-chart-deploy-__codelineno-5-50">50</a></span>
<span class="normal"><a href="#4-2-helm-chart-deploy-__codelineno-5-51">51</a></span>
<span class="normal"><a href="#4-2-helm-chart-deploy-__codelineno-5-52">52</a></span>
<span class="normal"><a href="#4-2-helm-chart-deploy-__codelineno-5-53">53</a></span>
<span class="normal"><a href="#4-2-helm-chart-deploy-__codelineno-5-54">54</a></span>
<span class="normal"><a href="#4-2-helm-chart-deploy-__codelineno-5-55">55</a></span>
<span class="normal"><a href="#4-2-helm-chart-deploy-__codelineno-5-56">56</a></span>
<span class="normal"><a href="#4-2-helm-chart-deploy-__codelineno-5-57">57</a></span>
<span class="normal"><a href="#4-2-helm-chart-deploy-__codelineno-5-58">58</a></span>
<span class="normal"><a href="#4-2-helm-chart-deploy-__codelineno-5-59">59</a></span>
<span class="normal"><a href="#4-2-helm-chart-deploy-__codelineno-5-60">60</a></span>
<span class="normal"><a href="#4-2-helm-chart-deploy-__codelineno-5-61">61</a></span>
<span class="normal"><a href="#4-2-helm-chart-deploy-__codelineno-5-62">62</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-25" name="__codelineno-5-25"></a><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Release Charts</span>
<a id="__codelineno-5-26" name="__codelineno-5-26"></a>
<a id="__codelineno-5-27" name="__codelineno-5-27"></a><span class="nt">on</span><span class="p">:</span>
<a id="__codelineno-5-28" name="__codelineno-5-28"></a><span class="w">  </span><span class="nt">push</span><span class="p">:</span>
<a id="__codelineno-5-29" name="__codelineno-5-29"></a><span class="w">    </span><span class="nt">branches</span><span class="p">:</span>
<a id="__codelineno-5-30" name="__codelineno-5-30"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">main</span>
<a id="__codelineno-5-31" name="__codelineno-5-31"></a><span class="w">    </span><span class="nt">paths</span><span class="p">:</span>
<a id="__codelineno-5-32" name="__codelineno-5-32"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;charts/**&#39;</span>
<a id="__codelineno-5-33" name="__codelineno-5-33"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.github/workflows/release.yml</span>
<a id="__codelineno-5-34" name="__codelineno-5-34"></a>
<a id="__codelineno-5-35" name="__codelineno-5-35"></a><span class="nt">permissions</span><span class="p">:</span>
<a id="__codelineno-5-36" name="__codelineno-5-36"></a><span class="w">  </span><span class="nt">contents</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">write</span>
<a id="__codelineno-5-37" name="__codelineno-5-37"></a><span class="w">  </span><span class="nt">packages</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">write</span>
<a id="__codelineno-5-38" name="__codelineno-5-38"></a><span class="w">  </span><span class="nt">pages</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">write</span>
<a id="__codelineno-5-39" name="__codelineno-5-39"></a><span class="w">  </span><span class="nt">id-token</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">write</span>
<a id="__codelineno-5-40" name="__codelineno-5-40"></a>
<a id="__codelineno-5-41" name="__codelineno-5-41"></a><span class="nt">jobs</span><span class="p">:</span>
<a id="__codelineno-5-42" name="__codelineno-5-42"></a><span class="w">  </span><span class="nt">release</span><span class="p">:</span>
<a id="__codelineno-5-43" name="__codelineno-5-43"></a><span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>
<a id="__codelineno-5-44" name="__codelineno-5-44"></a><span class="w">    </span><span class="nt">steps</span><span class="p">:</span>
<a id="__codelineno-5-45" name="__codelineno-5-45"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Checkout</span>
<a id="__codelineno-5-46" name="__codelineno-5-46"></a><span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/checkout@v3</span>
<a id="__codelineno-5-47" name="__codelineno-5-47"></a><span class="w">        </span><span class="nt">with</span><span class="p">:</span>
<a id="__codelineno-5-48" name="__codelineno-5-48"></a><span class="w">          </span><span class="nt">fetch-depth</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
<a id="__codelineno-5-49" name="__codelineno-5-49"></a>
<a id="__codelineno-5-50" name="__codelineno-5-50"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Configure Git</span>
<a id="__codelineno-5-51" name="__codelineno-5-51"></a><span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<a id="__codelineno-5-52" name="__codelineno-5-52"></a><span class="w">          </span><span class="no">git config user.name &quot;$GITHUB_ACTOR&quot;</span>
<a id="__codelineno-5-53" name="__codelineno-5-53"></a><span class="w">          </span><span class="no">git config user.email &quot;$GITHUB_ACTOR@users.noreply.github.com&quot;</span>
<a id="__codelineno-5-54" name="__codelineno-5-54"></a>
<a id="__codelineno-5-55" name="__codelineno-5-55"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Add repositories workaround</span>
<a id="__codelineno-5-56" name="__codelineno-5-56"></a><span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<a id="__codelineno-5-57" name="__codelineno-5-57"></a><span class="w">          </span><span class="no">helm repo add bitnami https://charts.bitnami.com/bitnami</span>
<a id="__codelineno-5-58" name="__codelineno-5-58"></a>
<a id="__codelineno-5-59" name="__codelineno-5-59"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run chart-releaser</span>
<a id="__codelineno-5-60" name="__codelineno-5-60"></a><span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">helm/chart-releaser-action@v1.4.1</span>
<a id="__codelineno-5-61" name="__codelineno-5-61"></a><span class="w">        </span><span class="nt">env</span><span class="p">:</span>
<a id="__codelineno-5-62" name="__codelineno-5-62"></a><span class="w">          </span><span class="nt">CR_TOKEN</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;${{</span><span class="nv"> </span><span class="s">github.token</span><span class="nv"> </span><span class="s">}}&quot;</span>
</code></pre></div></td></tr></table></div>
<blockquote>
<p>On a bien précisé que le token créer pour un job github action a la <strong>permission d'écrire sur les pages github</strong>.</p>
</blockquote>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#4-2-helm-chart-deploy-__codelineno-6-1"></a>git<span class="w"> </span>add<span class="w"> </span>.
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#4-2-helm-chart-deploy-__codelineno-6-2"></a>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;chore: chart releaser action&quot;</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#4-2-helm-chart-deploy-__codelineno-6-3"></a>git<span class="w"> </span>push
</code></pre></div>
<p>Enfin, on enlève le dossier <code>charts</code> du stash et on le commit :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#4-2-helm-chart-deploy-__codelineno-7-1"></a>git<span class="w"> </span>stash<span class="w"> </span>pop
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#4-2-helm-chart-deploy-__codelineno-7-2"></a>git<span class="w"> </span>add<span class="w"> </span>.
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#4-2-helm-chart-deploy-__codelineno-7-3"></a>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;chore: add chart&quot;</span>
</code></pre></div>
<p>L'objectif est de modifier les fichiers du chart pour que git détecte un changement et déclenche la CD github action.</p>
<p>Notre chart va donc se déployer sur github pages et être disponible à l'adresse suivante : <code>https://my-org.github.io/my-repo</code>. N'hésitez pas à consulter l'avancement du job <a href="https://github.com/esgi-lyon/paas-tutorial/actions/runs/">ici</a> et à suivre le déploiement sur <a href="https://github.com/esgi-lyon/paas-tutorial/deployments">l'onglet deployments</a></p>
<p>Enfin vous pouvez ajouter le repo à helm pour tester que la publication a bien fonctionner :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#4-2-helm-chart-deploy-__codelineno-8-1"></a>helm<span class="w"> </span>repo<span class="w"> </span>add<span class="w"> </span>paas<span class="w"> </span>https://esgi-lyon.github.io/paas-tutorial
</code></pre></div>
<blockquote>
<p>Si vous avez des soucis après cette commande essayez de relancer les déploiements github pages qui peuvent dysfonctionner parfois. Exemple de lien vers les jobs : https://github.com/esgi-lyon/paas-tutorial/actions/workflows/pages/pages-build-deployment</p>
</blockquote>
<h3 id="4-2-helm-chart-deploy-utilisation-finale-de-notre-chart">Utilisation finale de notre chart<a class="headerlink" href="#4-2-helm-chart-deploy-utilisation-finale-de-notre-chart" title="Permanent link">&para;</a></h3>
<p>Sur le lien de votre <a href="https://kubeapps.k3s.local/#/c/default/ns/default/config/repos">kubeapps</a> vous pouvez gérer les repositories helm à utiliser pour découvrir les applications. Nous allons ainsi pouvoir ajouter notre repository helm. </p>
<p>Cliquez sur <code>Add Package Repository</code> puis renseigner les informations suivantes :</p>
<ul>
<li><strong>Name</strong> : paas</li>
<li><strong>Url</strong> : https://esgi-lyon.github.io/paas-tutorial</li>
<li><strong>Type</strong> : Helm</li>
<li><strong>Scope</strong> : Global Repository (accessible depuis tous les namespaces)</li>
</ul>
<p>Enfin vous pouvez rechercher l'application <code>chart</code> dans le <code>Catalog</code> de kubeapps et le déployé dans le namespace de votre choix. Arrêter vous bien à l'étape de configuration du chart avant de le déployer.</p>
<p><strong>Dans la configuration</strong> vous pourrez mettre en place en modifiant les valeurs par défaut :</p>
<ul>
<li>Un container de votre choix, ici j'ai utilisé l'image docker que j'ai créé précédemment pour le microservice client.</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#4-2-helm-chart-deploy-__codelineno-9-1"></a><span class="nt">image</span><span class="p">:</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#4-2-helm-chart-deploy-__codelineno-9-2"></a><span class="w">  </span><span class="nt">pullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IfNotPresent</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#4-2-helm-chart-deploy-__codelineno-9-3"></a><span class="w">  </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">loicroux/client</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#4-2-helm-chart-deploy-__codelineno-9-4"></a><span class="w">  </span><span class="nt">tag</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">latest</span>
</code></pre></div>
<ul>
<li>Le port du container en fonction de la configuration <code>server.port</code> dans le application.yaml de votre microservice. Ici c'est pour le client 8080.</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#4-2-helm-chart-deploy-__codelineno-10-1"></a><span class="nt">container</span><span class="p">:</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#4-2-helm-chart-deploy-__codelineno-10-2"></a><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
</code></pre></div>
<ul>
<li>Un ingress avec un certificat TLS automatique.</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#4-2-helm-chart-deploy-__codelineno-11-1"></a><span class="nt">ingress</span><span class="p">:</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#4-2-helm-chart-deploy-__codelineno-11-2"></a><span class="w">  </span><span class="c1"># ...</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#4-2-helm-chart-deploy-__codelineno-11-3"></a><span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#4-2-helm-chart-deploy-__codelineno-11-4"></a><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#4-2-helm-chart-deploy-__codelineno-11-5"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">client.k3s.local</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#4-2-helm-chart-deploy-__codelineno-11-6"></a><span class="w">      </span><span class="nt">paths</span><span class="p">:</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#4-2-helm-chart-deploy-__codelineno-11-7"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/</span>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#4-2-helm-chart-deploy-__codelineno-11-8"></a><span class="w">          </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ImplementationSpecific</span>
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#4-2-helm-chart-deploy-__codelineno-11-9"></a><span class="w">  </span><span class="nt">tls</span><span class="p">:</span>
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#4-2-helm-chart-deploy-__codelineno-11-10"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">hosts</span><span class="p">:</span>
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#4-2-helm-chart-deploy-__codelineno-11-11"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">client.k3s.local</span>
<a id="__codelineno-11-12" name="__codelineno-11-12" href="#4-2-helm-chart-deploy-__codelineno-11-12"></a><span class="w">      </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">client.k3s.local-tls</span>
</code></pre></div></section><section class="print-page" id="5-allez-plus-loin"><h1 id="5-allez-plus-loin-5-allez-plus-loin">5. Allez plus loin<a class="headerlink" href="#5-allez-plus-loin-5-allez-plus-loin" title="Permanent link">&para;</a></h1>
<h3 id="5-allez-plus-loin-faq">FAQ<a class="headerlink" href="#5-allez-plus-loin-faq" title="Permanent link">&para;</a></h3>
<p>J'ai essayé plusieurs fois le provision de la vm avec des configurations différentes me forçant ainsi à apply / destroy la stack plusieurs fois. Cependant, maintenant je n'arrive plus à accéder à l'url avec une <strong>erreur dns</strong> ?</p>
<p>Il s'agit probablement du cache dns qui vous renvoi l'entrée ip d'une ancienne vm car le time to live n'a pas encore expiré. Pour cela dans chrome nous devons nettoyer ce cache pour faire comme si nous n'étions jamais aller sur le site.
Dans votre navigateur chrome <a href="#5-allez-plus-loin">chrome://net-internals/#dns</a> faites "un clear host cache" et réessayez.</p>
<p>Aussi on peut utiliser un flush cache global si cela ne fonctionne toujorus pas :</p>
<ul>
<li><a href="https://developers.google.com/speed/public-dns/cache?hl=fr">pour le dns de google</a></li>
<li><a href="https://1.1.1.1/purge-cache/">pour le dns de cloudflare</a></li>
</ul>
<blockquote>
<p>Pour faire des tests en cas réel, il est préférable d'utiliser des entrées <code>dex_hostname</code> et <code>kubeapps_hostname</code> différentes que vous n'utilisez pas pour un environnement (staging ou production).</p>
</blockquote>
<h3 id="5-allez-plus-loin-exercice">Exercice<a class="headerlink" href="#5-allez-plus-loin-exercice" title="Permanent link">&para;</a></h3>
<p>Pour vérifier que vous avez bien compris, vous devez maintenant créer l'image packer d'un nouvel environnement staging. (Par défaut packer utilise le rôle configuré sur l'environnement <code>prod</code>). Utilisez cet environnement avec terraform pour provisionner une vm dans un nouveau groupe de ressource.</p>
<p>Il faudra bien veillez à créer les variables manquantes dans packer (nom image) et terraform (data source import image) pour que on puisse encore provisionner une machine de production.</p>
<h3 id="5-allez-plus-loin-kubernetes-sur-vscode">Kubernetes sur Vscode<a class="headerlink" href="#5-allez-plus-loin-kubernetes-sur-vscode" title="Permanent link">&para;</a></h3>
<p>Pour consolider le deboggage de notre environnement de dev ops nous pouvons intégrer notre cluster kubernetes dans l'IDE vscode.</p>
<p>Nous allons chercher la kubeconfig dans notre container qui embarque K3s et le cluster.
Récupérez l'identifiant du container avec :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#5-allez-plus-loin-__codelineno-0-1"></a>docker<span class="w"> </span>ps<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>node-0<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;{print $1}&#39;</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#5-allez-plus-loin-__codelineno-0-2"></a><span class="c1"># ex de retour 61a74719f7c4</span>
</code></pre></div>
<p>Copier la kube config k3s avec :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#5-allez-plus-loin-__codelineno-1-1"></a>docker<span class="w"> </span>cp<span class="w"> </span>61a74719f7c4:/etc/rancher/k3s/k3s.yaml<span class="w"> </span>~/.kube/config
</code></pre></div>
<p>Si vous n'avez pas kubectl en local :</p>
<ul>
<li><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl-macos/">Pour mac</a></li>
<li><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/">Pour Wsl / Linux</a></li>
</ul>
<p>On check ensuite avec <code>kubectl cluster-info</code> qui devrait nous donner les informations du node k3s.</p>
<h5 id="5-allez-plus-loin-ensuite-sur-vscode-utilisez-ces-parametres-utilisateur-pour-voir-et-utiliser-le-cluster">Ensuite sur <code>vscode</code> utilisez ces paramètres utilisateur pour voir et utiliser le cluster<a class="headerlink" href="#5-allez-plus-loin-ensuite-sur-vscode-utilisez-ces-parametres-utilisateur-pour-voir-et-utiliser-le-cluster" title="Permanent link">&para;</a></h5>
<blockquote>
<p>Pour afficher le chemin vers home <code>cd ~ &amp;&amp; pwd &amp;&amp; cd -</code></p>
<p><a href="../5-allez-plus-loin/.vscode/settings.json">.vscode/settings.json</a>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#5-allez-plus-loin-__codelineno-2-1"></a><span class="w">    </span><span class="nt">&quot;vs-kubernetes&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#5-allez-plus-loin-__codelineno-2-2"></a><span class="w">        </span><span class="nt">&quot;vs-kubernetes.knownKubeconfigs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#5-allez-plus-loin-__codelineno-2-3"></a><span class="w">            </span><span class="s2">&quot;&lt;Chemin-vers-home&gt;/.kube/config&quot;</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#5-allez-plus-loin-__codelineno-2-4"></a><span class="w">        </span><span class="p">],</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#5-allez-plus-loin-__codelineno-2-5"></a><span class="w">        </span><span class="nt">&quot;vs-kubernetes.kubeconfig&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;Chemin-vers-home&gt;/.kube/config&quot;</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#5-allez-plus-loin-__codelineno-2-6"></a><span class="w">    </span><span class="p">}</span>
</code></pre></div></p>
</blockquote>
<p>Et voilà vous avez accès à une interface pour contrôler votre cluster directement depuis vscode. Utiliser cette configuration <code>json</code> autant que vous voulez dans les repository de vos applications pour avoir une expérience au plus proche de la production.</p>
<h1 id="5-allez-plus-loin-sources">Sources<a class="headerlink" href="#5-allez-plus-loin-sources" title="Permanent link">&para;</a></h1>
<ul>
<li><a href="https://docs.ansible.com/">ansible docs</a></li>
<li><a href="https://blog.bytebytego.com/p/ep35-what-is-kubernetes">base kubernetes</a> Alex Xu</li>
<li><a href="https://github.com/vmware-tanzu/kubeapps/blob/main/site/content/docs/latest/tutorials/getting-started.md#step-3-start-the-kubeapps-dashboard">start kubeapps</a></li>
<li><a href="https://github.com/vmware-tanzu/kubeapps/blob/main/site/content/docs/latest/howto/OIDC/OAuth2OIDC-oauth2-proxy.md#manual-deployment">oauth kubeapps</a>
_ <a href="https://cert-manager.io/docs/usage/ingress/#supported-annotations">cert-manager annotation</a></li>
<li><a href="https://letsencrypt.org/docs/">doc lets encrypt</a></li>
<li><a href="https://github.com/letsencrypt/pebble#ca-root-and-intermediate-certificates">pebble doc cert recover</a></li>
<li><a href="https://developer.okta.com/docs/concepts/oauth-openid/">open id docs from okta</a></li>
<li><a href="https://dexidp.io/docs/kubernetes/">dex k8s</a></li>
<li><a href="https://dexidp.io/docs/connectors/github/">dex github</a></li>
<li><a href="https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/">k8s dns</a></li>
<li><a href="https://kubernetes.io/docs/tasks/administer-cluster/dns-debugging-resolution/">dns debug kubernetes</a></li>
<li><a href="https://kubernetes.io/docs/reference/access-authn-authz/authentication/">kubernetes open id doc</a></li>
<li><a href="https://registry.terraform.io/providers/integrations/github/latest/docs">terraform github</a></li>
<li><a href="https://registry.terraform.io/providers/hashicorp/azurerm/latest">terrform azure</a></li>
<li><a href="https://learn.microsoft.com/fr-fr/azure/">doc azure</a></li>
<li><a href="https://github.com/helm/chart-releaser">helm chart releaser</a></li>
<li><a href="https://github.com/features/copilot">Github copilot</a></li>
<li><a href="#5-allez-plus-loin-shorturl.at-frtw5">Microservices et architecture monolithique</a></li>
<li><a href="https://geshan.com.np/blog/2021/12/docker-postgres/">Postgres with Docker</a></li>
<li><a href="https://blog.logrocket.com/methods-for-microservice-communication/">Communication microservices</a></li>
</ul></section></div>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "/", "features": ["content.code.copy", "content.action.edit"], "search": "../assets/javascripts/workers/search.e5c33ebb.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.51d95adb.min.js"></script>
      
        <script src="../js/print-site.js"></script>
      
    
  </body>
</html>