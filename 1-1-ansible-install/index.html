
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../0-install/">
      
      
        <link rel="next" href="../1-2-ansible-k3s/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.0.6">
    
    
      
        <title>1.1 Provisionning du paas avec ansible - PaaS Tutorial</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.558e4712.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.2505c338.min.css">
      
      

    
    
    
      
    
    
      <link rel="stylesheet" href="../css/print-site-enum-headings2.css">
    
      <link rel="stylesheet" href="../css/print-site-enum-headings3.css">
    
      <link rel="stylesheet" href="../css/print-site-enum-headings4.css">
    
      <link rel="stylesheet" href="../css/print-site-enum-headings5.css">
    
      <link rel="stylesheet" href="../css/print-site-enum-headings6.css">
    
      <link rel="stylesheet" href="../css/print-site.css">
    
      <link rel="stylesheet" href="../css/print-site-material.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#11-provisionning-du-paas-avec-ansible" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="PaaS Tutorial" class="md-header__button md-logo" aria-label="PaaS Tutorial" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            PaaS Tutorial
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              1.1  Provisionning du paas avec ansible
            
          </span>
        </div>
      </div>
    </div>
    
    
    
    
      <div class="md-header__source">
        <a href="https://github.com/esgi-lyon/paas-tutorial" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="PaaS Tutorial" class="md-nav__button md-logo" aria-label="PaaS Tutorial" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    PaaS Tutorial
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/esgi-lyon/paas-tutorial" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Tutoriel PaaS
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../0-install/" class="md-nav__link">
        Introduction et installation
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          1.1  Provisionning du paas avec ansible
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        1.1  Provisionning du paas avec ansible
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#installer-ansible-et-creation-du-role" class="md-nav__link">
    Installer ansible et création du rôle
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bonus-pour-faire-fonctionner-lextension-vscode-ansible" class="md-nav__link">
    Bonus pour faire fonctionner l'extension VsCode ansible
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#b-playbook-ansible" class="md-nav__link">
    B. Playbook ansible
  </a>
  
    <nav class="md-nav" aria-label="B. Playbook ansible">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#on-commence" class="md-nav__link">
    On Commence :
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#c-initialiser-le-role-installant-un-cluster-kubernetes-k3s" class="md-nav__link">
    C. Initialiser le rôle installant un Cluster kubernetes (k3s)
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../1-2-ansible-k3s/" class="md-nav__link">
        1.2 Présentation de K3s et installation
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../1-3-ansible-manifests/" class="md-nav__link">
        1.3 Algo d'installation des manifests
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../1-4-ansible-pebble/" class="md-nav__link">
        1.4 Autorité de certification
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../1-5-ansible-dns/" class="md-nav__link">
        1.5 Mise en place des communications réseau du cluster
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../1-6-ansible-cert-manager/" class="md-nav__link">
        1.6 Utiliser notre autorité avec cert-manager
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../1-7-ansible-trust-ca/" class="md-nav__link">
        1.7 Faire confiance à notre autorité de certification
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../1-8-ansible-dex/" class="md-nav__link">
        1.8 Authentification et des habilitations
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../1-9-ansible-kubeapps/" class="md-nav__link">
        1.9 Installation de kubeapps
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../2-packer-playbook/" class="md-nav__link">
        2. Utilisation de notre rôle dans packer
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../3-1-terraform-azure-init/" class="md-nav__link">
        3.1 Initialisation du déploiement final sur Azure avec Terraform
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../3-2-terraform-security/" class="md-nav__link">
        3.2 Sécurisation de l'organisation
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../3-3-terraform-azure-network-vm/" class="md-nav__link">
        3.3 Machine virtuelle et réseau
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../4-1-helm-chart/" class="md-nav__link">
        4.1 Création du Helm chart
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../4-2-helm-chart-deploy/" class="md-nav__link">
        4.2 Déploiement du chart
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../5-allez-plus-loin/" class="md-nav__link">
        5. Allez plus loin
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../print_page/" class="md-nav__link">
        Print Site
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#installer-ansible-et-creation-du-role" class="md-nav__link">
    Installer ansible et création du rôle
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bonus-pour-faire-fonctionner-lextension-vscode-ansible" class="md-nav__link">
    Bonus pour faire fonctionner l'extension VsCode ansible
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#b-playbook-ansible" class="md-nav__link">
    B. Playbook ansible
  </a>
  
    <nav class="md-nav" aria-label="B. Playbook ansible">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#on-commence" class="md-nav__link">
    On Commence :
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#c-initialiser-le-role-installant-un-cluster-kubernetes-k3s" class="md-nav__link">
    C. Initialiser le rôle installant un Cluster kubernetes (k3s)
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
    <a href="https://github.com/esgi-lyon/paas-tutorial/edit/main/docs/1-1-ansible-install.md" title="Edit this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4v-2m10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1 2.1 2.1Z"/></svg>
    </a>
  
  



<h1 id="11-provisionning-du-paas-avec-ansible">1.1  Provisionning du paas avec ansible<a class="headerlink" href="#11-provisionning-du-paas-avec-ansible" title="Permanent link">&para;</a></h1>
<hr />
<p>Cette partie très longue présente comment créer le rôle ansible qui va permettre de provisionner un cluster kubernetes sur un serveur linux puis d'y mettre en place la solution de PaaS.</p>
<p>L'objectif d'ansible est de déployer des configurations et des outils sur des machines. À l'aide d'un format de configuration simple
proche de l'algorithmie, nous pourrons amener tous les outils indispensables à la création de notre PaaS.</p>
<h3 id="installer-ansible-et-creation-du-role">Installer ansible et création du rôle<a class="headerlink" href="#installer-ansible-et-creation-du-role" title="Permanent link">&para;</a></h3>
<p>Ansible est un outil dépendant de l'écosystème python. Pour simplifier la gestion des dépendances 
qui risquent de faire conflit avec d'autres installations
de python, nous allons utiliser <code>miniconda</code> installé précédemment.</p>
<p>Molecule est un outil permettant de tester nos suites de configurations ansible contenus dans des rôles ou des tâches.</p>
<p>Créer votre espace de travail :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nb">cd</span><span class="w"> </span>~
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>mkdir<span class="w"> </span>paas-tutorial/
</code></pre></div>
<p>Ensuite on initialise un environnement virtuel python avec sa propre version de <strong>python 3.9</strong> et les dépendances ansible et molecule. Ainsi nos dépendances n'entrent pas en conflit avec d'autres pouvant être incompatible.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>conda<span class="w"> </span>create<span class="w"> </span>-n<span class="w"> </span>playbook-paas<span class="w"> </span><span class="nv">python</span><span class="o">=</span><span class="m">3</span>.9
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>conda<span class="w"> </span>activate<span class="w"> </span>playbook-paas
</code></pre></div>
<p>Installer ansible et molecule préconfiguré pour utiliser docker (rancher desktop).
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>pip<span class="w"> </span>install<span class="w"> </span><span class="s1">&#39;ansible==6.5.0&#39;</span><span class="w"> </span><span class="s1">&#39;molecule[docker]&#39;</span>
</code></pre></div></p>
<p><strong>Sur windows</strong> lancez cette commande pour avoir accès aux dépendances python directement.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="c1"># ~/.bashrc si vous utiliser bash </span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;export PATH=\&quot;</span><span class="nv">$PATH</span><span class="s2">:</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span><span class="s2">/.local/bin\&quot;&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>~/.zshrc
</code></pre></div>
<p>Vérifier que tous fonctionne avec <code>ansible --version</code>.</p>
<p>Vous devriez avoir <code>ansible [core 2.13.4]</code> dans le retour</p>
<h3 id="bonus-pour-faire-fonctionner-lextension-vscode-ansible"><strong>Bonus</strong> pour faire fonctionner l'extension VsCode ansible<a class="headerlink" href="#bonus-pour-faire-fonctionner-lextension-vscode-ansible" title="Permanent link">&para;</a></h3>
<blockquote>
<p><strong>Warning</strong>: Utilisateur du WSL <strong>Pour utiliser vscode, utilisez le impérativement via la ligne de commande linux WSL dans votre projet <code>~/paas-tutorial</code></strong> : <code>code .</code></p>
<p>Vscode : <code>.vscode/settings.json</code>
Remplacez bien le chemin avec le résultat de cette commande <code>which python</code>
miniconda sur wsl, mambaforge sur mac
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="p">{</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="w">    </span><span class="nt">&quot;ansible.python.interpreterPath&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;User-Path&gt;/mambaforge/envs/playbook-paas/bin/python&quot;</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="p">}</span>
</code></pre></div></p>
</blockquote>
<h3 id="b-playbook-ansible">B. Playbook ansible<a class="headerlink" href="#b-playbook-ansible" title="Permanent link">&para;</a></h3>
<p>Un playbook ansible est un projet chargé de lancer plusieurs rôles différents sur des machines disponibles sur le réseau via <strong>ssh</strong>. (localhost par exemple peut être provisioné).</p>
<p>Pour aller plus loin dans le fonctionnement de ansible, cet outil s'appuie intégralement sur l'environnement python installé sur une machine invités (que l'on provisionne). Grâce à python ansible va abstraire la complexité de l'administration système linux avec des <strong>déclarations yaml</strong>, des <strong>templates</strong> pour créer des fichiers dynamiquement, des <strong>structures de contrôles</strong> algorithmique et des variables manipulables avec des <strong>filters</strong>.</p>
<h4 id="on-commence">On Commence :<a class="headerlink" href="#on-commence" title="Permanent link">&para;</a></h4>
<p>On va créer un dossier playbook pour mettre tout ce qui concerne ansible</p>
<p>Aussi, on va geler les versions des dépendances dans un fichier requirements pour qu'un autre environnement puisse facilement retrouver l'état de votre installation sans problèmes de compatibilités.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>mkdir<span class="w"> </span>-p<span class="w"> </span>paas-tutorial/playbook
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="nb">cd</span><span class="w"> </span>paas-tutorial/playbook
</code></pre></div>
<p>Geler les dépendances pour éviter des soucis de compatibilité plus tard.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>pip<span class="w"> </span>freeze<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-E<span class="w"> </span><span class="s2">&quot;ansible|molecule&quot;</span><span class="w"> </span>&gt;<span class="w"> </span>requirements.txt
</code></pre></div>
<blockquote>
<p>Nous allons suivre <strong>l'alternative-directory-layout</strong> recommandé par cette <a href="https://docs.ansible.com/ansible/latest/user_guide/sample_setup.html#alternative-directory-layout">documentation</a></p>
</blockquote>
<p>Voici la suite complète de commande pour créer la structure du playbook.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>touch<span class="w"> </span>site.yml
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>touch<span class="w"> </span>requirements.yaml
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>mkdir<span class="w"> </span>roles/
</code></pre></div>
<p>Ensuite dans <code>requirements.yaml</code> on importe les roles que l'on utilise en dépendances.</p>
<blockquote>
<p>Ansible galaxy est le gestionnaire de paquet pour importer des rôles et des collections ansible dans un playbook.</p>
<p><strong>Note</strong> pour l'instant, il y a un bug avec galaxy nous empêchant de récupérer la bonne version de k3s. On peut forcer l'utilisation directe de git pour récupérer la version 3.3.0</p>
</blockquote>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/requirements.yaml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-8-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-8-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-8-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-8-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-8-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-8-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-8-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-8-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-8-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="nn">---</span>
<a id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="nt">roles</span><span class="p">:</span><span class="w"> </span>
<a id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">xanmanning.k3s</span>
<a id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="w">      </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://github.com/PyratLabs/ansible-role-k3s.git</span>
<a id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="w">      </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v3.3.0</span>
<a id="__codelineno-8-6" name="__codelineno-8-6"></a>
<a id="__codelineno-8-7" name="__codelineno-8-7"></a><span class="nt">collections</span><span class="p">:</span>
<a id="__codelineno-8-8" name="__codelineno-8-8"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">community.general</span>
<a id="__codelineno-8-9" name="__codelineno-8-9"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes.core</span>
<a id="__codelineno-8-10" name="__codelineno-8-10"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">azure.azcollection</span>
</code></pre></div></td></tr></table></div>
<p>Les <strong>collections</strong> vont servir à ajouter des fonctionnalités à ansible et ses directives de tâches. Ici on ajoute les fonctionnalités fondamentales ainsi que celles pour manipuler notre cluster kubernetes (abstraction de la commande <code>kubectl</code>).</p>
<p>Les <strong>roles</strong> correspondent à des suites de tâches qui vont installer et configurer un outil sur une machine. Ici on utilisera un <a href="https://github.com/PyratLabs/ansible-role-k3s">role k3s</a> qui s'occupe de configurer en fonction de nos paramètres le cluster k3s.</p>
<blockquote>
<p><strong>Note</strong> K3s n'utilise pas <code>docker</code> mais <code>containerd</code> pour utiliser les fonctionnalités de conteneur linux.</p>
</blockquote>
<p>Pour installer ces <code>requirements</code> maintenant on lance dans le dossier <code>playbook/</code> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>ansible-galaxy<span class="w"> </span>install<span class="w"> </span>-r<span class="w"> </span>requirements.yaml
</code></pre></div>
<p>Normalement tous est installé correctement et prêt à l'emploi.</p>
<h3 id="c-initialiser-le-role-installant-un-cluster-kubernetes-k3s">C. Initialiser le rôle installant un Cluster kubernetes (k3s)<a class="headerlink" href="#c-initialiser-le-role-installant-un-cluster-kubernetes-k3s" title="Permanent link">&para;</a></h3>
<p>Pour suivre la convention d'ansible nous allons procéder en créant un rôle. Il sera ici interne à notre projet pour simplifier, mais on peut imaginer facilement le déplacer dans un autre repository.
Son objectif sera d'installer un ensemble de solutions pour faire fonctionner kubeapps.</p>
<p>Dans le dossier <code>playbook</code> faites donc :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>mkdir<span class="w"> </span>roles
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="nb">cd</span><span class="w"> </span>roles
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>ansible-galaxy<span class="w"> </span>init<span class="w"> </span>kubeapps
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="nb">cd</span><span class="w"> </span>kubeapps
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="c1"># Créer un scénario de test par défaut</span>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>molecule<span class="w"> </span>init<span class="w"> </span>scenario<span class="w"> </span>-d<span class="w"> </span>docker<span class="w"> </span>default
</code></pre></div>
<p>Vous devriez obtenir cette structure dans le nouveau dossier <code>playbook/</code> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>README.md 
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>defaults/
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>files/     
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>handlers/
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>molecule/default
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>meta/      
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>tasks/     
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>templates/ 
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>tests/    
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a>vars/
</code></pre></div>
<p>Voici ce que va être rendu comme structure de <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_reuse_roles.html"><strong>rôle</strong></a>.</p>
<p>Nous allons ensuite mettre à jour les métadonnées ansible galaxy avec notamment la dépendance kubernetes (rôle k3s). Il y a déjà du contenu présent, ne supprimer rien et ajouter à la ligne 51 la case du tableau <code>dependencies</code>.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/roles/kubeapps/meta/main.yml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-51">51</a></span>
<span class="normal"><a href="#__codelineno-12-52">52</a></span>
<span class="normal"><a href="#__codelineno-12-53">53</a></span>
<span class="normal"><a href="#__codelineno-12-54">54</a></span>
<span class="normal"><a href="#__codelineno-12-55">55</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-12-51" name="__codelineno-12-51"></a><span class="nt">dependencies</span><span class="p">:</span>
<a id="__codelineno-12-52" name="__codelineno-12-52"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">xanmanning.k3s</span>
<a id="__codelineno-12-53" name="__codelineno-12-53"></a><span class="w">      </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v3.3.0</span>
<a id="__codelineno-12-54" name="__codelineno-12-54"></a><span class="w">      </span><span class="nt">vars</span><span class="p">:</span>
<a id="__codelineno-12-55" name="__codelineno-12-55"></a><span class="w">        </span><span class="nt">k3s_release_version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1.21</span>
</code></pre></div></td></tr></table></div>
<blockquote>
<p><code>k3s_release_version</code> est indispensable de ne pas monter au-dessus de la version <code>1.21</code>. Dans le contexte docker in docker, il y a des problèmes de compatibilité avec les fonctionnalités linux récentes (QOS, cgroups, ...).</p>
</blockquote>
<p>Ensuite vous devez obligatoirement définir ces Informations sur les metas du rôles:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">playbook/roles/kubeapps/meta/main.yml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-13-1">1</a></span>
<span class="normal"><a href="#__codelineno-13-2">2</a></span>
<span class="normal"><a href="#__codelineno-13-3">3</a></span>
<span class="normal"><a href="#__codelineno-13-4">4</a></span>
<span class="normal"><a href="#__codelineno-13-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="nt">galaxy_info</span><span class="p">:</span>
<a id="__codelineno-13-2" name="__codelineno-13-2"></a><span class="w">  </span><span class="nt">author</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">loic-roux-404</span>
<a id="__codelineno-13-3" name="__codelineno-13-3"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">paas_tutorial</span>
<a id="__codelineno-13-4" name="__codelineno-13-4"></a><span class="w">  </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubeapps deployment</span>
<a id="__codelineno-13-5" name="__codelineno-13-5"></a><span class="w">  </span><span class="nt">role_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubeapps</span>
</code></pre></div></td></tr></table></div>
<p>Le rôle kubernetes se lancera donc directement avant les tâches de celui de kubeapps.</p>
<hr />





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": ["content.code.copy", "content.action.edit"], "search": "../assets/javascripts/workers/search.e5c33ebb.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.51d95adb.min.js"></script>
      
        <script src="../js/print-site.js"></script>
      
    
  </body>
</html>