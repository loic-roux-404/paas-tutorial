
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../2-packer-playbook/">
      
      
        <link rel="next" href="../3-2-terraform-security/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.0.6">
    
    
      
        <title>3.1 Initialisation du déploiement final sur Azure avec Terraform - PaaS Tutorial</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.558e4712.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.2505c338.min.css">
      
      

    
    
    
      
    
    
      <link rel="stylesheet" href="../css/print-site-enum-headings2.css">
    
      <link rel="stylesheet" href="../css/print-site-enum-headings3.css">
    
      <link rel="stylesheet" href="../css/print-site-enum-headings4.css">
    
      <link rel="stylesheet" href="../css/print-site-enum-headings5.css">
    
      <link rel="stylesheet" href="../css/print-site-enum-headings6.css">
    
      <link rel="stylesheet" href="../css/print-site.css">
    
      <link rel="stylesheet" href="../css/print-site-material.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#31-initialisation-du-deploiement-final-sur-azure-avec-terraform" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="PaaS Tutorial" class="md-header__button md-logo" aria-label="PaaS Tutorial" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            PaaS Tutorial
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              3.1 Initialisation du déploiement final sur Azure avec Terraform
            
          </span>
        </div>
      </div>
    </div>
    
    
    
    
      <div class="md-header__source">
        <a href="https://github.com/esgi-lyon/paas-tutorial" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="PaaS Tutorial" class="md-nav__button md-logo" aria-label="PaaS Tutorial" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    PaaS Tutorial
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/esgi-lyon/paas-tutorial" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Tutoriel PaaS
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../0-install/" class="md-nav__link">
        Introduction et installation
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../1-1-ansible-install/" class="md-nav__link">
        1.1  Provisionning du paas avec ansible
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../1-2-ansible-k3s/" class="md-nav__link">
        1.2 Présentation de K3s et installation
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../1-3-ansible-manifests/" class="md-nav__link">
        1.3 Algo d'installation des manifests
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../1-4-ansible-pebble/" class="md-nav__link">
        1.4 Autorité de certification
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../1-5-ansible-dns/" class="md-nav__link">
        1.5 Mise en place des communications réseau du cluster
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../1-6-ansible-cert-manager/" class="md-nav__link">
        1.6 Utiliser notre autorité avec cert-manager
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../1-7-ansible-trust-ca/" class="md-nav__link">
        1.7 Faire confiance à notre autorité de certification
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../1-8-ansible-dex/" class="md-nav__link">
        1.8 Authentification et des habilitations
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../1-9-ansible-kubeapps/" class="md-nav__link">
        1.9 Installation de kubeapps
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../2-packer-playbook/" class="md-nav__link">
        2. Utilisation de notre rôle dans packer
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          3.1 Initialisation du déploiement final sur Azure avec Terraform
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        3.1 Initialisation du déploiement final sur Azure avec Terraform
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#obtenir-un-nom-de-domaine-gratuit-etudiants" class="md-nav__link">
    Obtenir un nom de domaine gratuit (étudiants)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lancement-de-la-vm-avec-terraform" class="md-nav__link">
    Lancement de la VM avec Terraform
  </a>
  
    <nav class="md-nav" aria-label="Lancement de la VM avec Terraform">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#nomenclature-de-terraform" class="md-nav__link">
    Nomenclature de terraform :
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#organisation-des-fichiers-du-dossier-infra" class="md-nav__link">
    Organisation des fichiers du dossier infra/
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../3-2-terraform-security/" class="md-nav__link">
        3.2 Sécurisation de l'organisation
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../3-3-terraform-azure-network-vm/" class="md-nav__link">
        3.3 Machine virtuelle et réseau
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../4-1-helm-chart/" class="md-nav__link">
        4.1 Création du Helm chart
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../4-2-helm-chart-deploy/" class="md-nav__link">
        4.2 Déploiement du chart
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../5-allez-plus-loin/" class="md-nav__link">
        5. Allez plus loin
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../print_page/" class="md-nav__link">
        Print Site
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#obtenir-un-nom-de-domaine-gratuit-etudiants" class="md-nav__link">
    Obtenir un nom de domaine gratuit (étudiants)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lancement-de-la-vm-avec-terraform" class="md-nav__link">
    Lancement de la VM avec Terraform
  </a>
  
    <nav class="md-nav" aria-label="Lancement de la VM avec Terraform">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#nomenclature-de-terraform" class="md-nav__link">
    Nomenclature de terraform :
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#organisation-des-fichiers-du-dossier-infra" class="md-nav__link">
    Organisation des fichiers du dossier infra/
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
    <a href="https://github.com/esgi-lyon/paas-tutorial/edit/main/docs/3-1-terraform-azure-init.md" title="Edit this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4v-2m10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1 2.1 2.1Z"/></svg>
    </a>
  
  



<h1 id="31-initialisation-du-deploiement-final-sur-azure-avec-terraform">3.1 Initialisation du déploiement final sur Azure avec Terraform<a class="headerlink" href="#31-initialisation-du-deploiement-final-sur-azure-avec-terraform" title="Permanent link">&para;</a></h1>
<hr />
<p>Ici nous mettons en place le déploiement final sur Azure avec  l'outil d'infrastructure as code Terraform.</p>
<h3 id="obtenir-un-nom-de-domaine-gratuit-etudiants">Obtenir un nom de domaine gratuit (étudiants)<a class="headerlink" href="#obtenir-un-nom-de-domaine-gratuit-etudiants" title="Permanent link">&para;</a></h3>
<blockquote>
<p><strong>Warning</strong> Cette étape intermédiaire est indispensable pour la suite du tutoriel.</p>
</blockquote>
<p>Allez sur <a href="https://education.github.com/">https://education.github.com/</a> et valider votre compte étudiant. Normalement votre email étudiant devrait être reconnu très facilement.</p>
<p>Après nous allons utiliser des noms de domaines offert par <strong>name.com</strong> :</p>
<ul>
<li>
<p>Allez à <a href="https://education.github.com/pack/offers#namecom">https://education.github.com/pack/offers#namecom</a></p>
</li>
<li>
<p>Veillez bien à ne pas être connecté à <code>name.com</code> dans le cas où vous seriez déjà inscrit</p>
</li>
<li>
<p>Cliquer Get access by connecting your GitHub account on Name.com et accepter les droits demandés par l'application sur github.</p>
</li>
<li>
<p>Connectez vous à github en cliquant sur le bouton qui devrait être au milieu de la page.</p>
</li>
<li>
<p>Dans <strong>domains</strong> chercher un domaine en <code>.live</code> de votre choix (par exemple <code>paas-tutorial-lesgi.live</code>)</p>
</li>
<li>
<p>Ensuite ajoutez le au panier et aller à checkout en cliquant à nouveau. <a href="https://www.name.com/account/checkout"><code>Panier &gt; Checkout</code></a> Le code promo est censé être appliqué automatiquement grâce à la connexion à Github.</p>
</li>
<li>
<p>Ensuite poursuivez en vous inscrivant à name.com et validez votre email puis valider l'achat qui ne doit rien vous couter si la manipulation à a été faite correctement.</p>
</li>
</ul>
<h2 id="lancement-de-la-vm-avec-terraform">Lancement de la VM avec Terraform<a class="headerlink" href="#lancement-de-la-vm-avec-terraform" title="Permanent link">&para;</a></h2>
<p>Introduction sur terraform <a href="https://www.terraform.io/intro/index.html">doc</a></p>
<p>Cet Outil de codage déclaratif ou d'<strong>IaC</strong> (infrastructure as code), Terraform permet d'utiliser un langage de configuration appelé HCL (HashiCorp Configuration Langage) à la place de l'API d'un fournisseur de cloud. On peut ainsi décrire l'infrastructure cloud de manière déclarative et automatisée avec une seule simple ligne de commande. Terraform génère ensuite un plan permettant d'atteindre un état final de l'infrastructure et exécute le plan pour mettre à disposition l'infrastructure.</p>
<p>Terraform permet de faire des infrastructures immuables que l'on peut versionner, partager, installer et détruire à la demande.
Il ne se limite pas seulement à ça, mais à toutes les automatisations mises à disposition par des produits autour du cloud.</p>
<p>https://learn.microsoft.com/en-us/azure/virtual-machines/custom-data</p>
<p><strong>Toujours dans le dossier <code>infra/</code> :</strong></p>
<p>Pour commencer ajouter ce gitignore dans le dossier <code>infra/</code> pour éviter le déchet :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>curl<span class="w"> </span>-L<span class="w"> </span>https://github.com/github/gitignore/raw/main/Terraform.gitignore<span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span>.gitignore
</code></pre></div>
<blockquote>
<p><code>-a</code> comme append, on ajoute à la fin du fichier et on n'écrase pas l'existant.</p>
</blockquote>
<h3 id="nomenclature-de-terraform">Nomenclature de terraform :<a class="headerlink" href="#nomenclature-de-terraform" title="Permanent link">&para;</a></h3>
<p>Un block <code>data</code> dans un fichier de configuration terraform <code>tf</code> sert à importer des données existantes sur la plateforme.</p>
<p>Un block <code>resource</code> dans un fichier de configuration terraform <code>tf</code> sert à créer des ressources sur la plateforme.</p>
<p>Un block <code>locals</code> dans un fichier de configuration terraform <code>tf</code> sert à définir des variables locales.</p>
<p>Un block <code>provider</code> dans un fichier de configuration terraform <code>tf</code> sert à définir le provider de cloud.</p>
<p>Il existe aussi <code>variable</code> et <code>output</code> qui servent à définir des variables d'entrée et de sortie.</p>
<h3 id="organisation-des-fichiers-du-dossier-infra">Organisation des fichiers du dossier <code>infra/</code><a class="headerlink" href="#organisation-des-fichiers-du-dossier-infra" title="Permanent link">&para;</a></h3>
<ol>
<li>Les providers</li>
</ol>
<p>Premièrement, nous allons créer un fichier <code>terraform.tf</code> qui va se charger de définir les ressources terraform de notre infrastructure. On va passer par plusieurs plateformes différentes :</p>
<ul>
<li>
<p><strong><code>github</code></strong> pour définir les équipes accèdant à kubeapps en controlant une organisation github.</p>
</li>
<li>
<p><strong><code>azurerm</code></strong> pour contrôler l'intégralité des ressources azure que l'on peut consulter dans le portail.</p>
</li>
<li>
<p><strong><code>namedotcom</code></strong> pour contrôler les zones du domaine que l'on a obtenu précédemment.</p>
</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">infra/terraform.tf</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-1-10">10</a></span>
<span class="normal"><a href="#__codelineno-1-11">11</a></span>
<span class="normal"><a href="#__codelineno-1-12">12</a></span>
<span class="normal"><a href="#__codelineno-1-13">13</a></span>
<span class="normal"><a href="#__codelineno-1-14">14</a></span>
<span class="normal"><a href="#__codelineno-1-15">15</a></span>
<span class="normal"><a href="#__codelineno-1-16">16</a></span>
<span class="normal"><a href="#__codelineno-1-17">17</a></span>
<span class="normal"><a href="#__codelineno-1-18">18</a></span>
<span class="normal"><a href="#__codelineno-1-19">19</a></span>
<span class="normal"><a href="#__codelineno-1-20">20</a></span>
<span class="normal"><a href="#__codelineno-1-21">21</a></span>
<span class="normal"><a href="#__codelineno-1-22">22</a></span>
<span class="normal"><a href="#__codelineno-1-23">23</a></span>
<span class="normal"><a href="#__codelineno-1-24">24</a></span>
<span class="normal"><a href="#__codelineno-1-25">25</a></span>
<span class="normal"><a href="#__codelineno-1-26">26</a></span>
<span class="normal"><a href="#__codelineno-1-27">27</a></span>
<span class="normal"><a href="#__codelineno-1-28">28</a></span>
<span class="normal"><a href="#__codelineno-1-29">29</a></span>
<span class="normal"><a href="#__codelineno-1-30">30</a></span>
<span class="normal"><a href="#__codelineno-1-31">31</a></span>
<span class="normal"><a href="#__codelineno-1-32">32</a></span>
<span class="normal"><a href="#__codelineno-1-33">33</a></span>
<span class="normal"><a href="#__codelineno-1-34">34</a></span>
<span class="normal"><a href="#__codelineno-1-35">35</a></span>
<span class="normal"><a href="#__codelineno-1-36">36</a></span>
<span class="normal"><a href="#__codelineno-1-37">37</a></span>
<span class="normal"><a href="#__codelineno-1-38">38</a></span>
<span class="normal"><a href="#__codelineno-1-39">39</a></span>
<span class="normal"><a href="#__codelineno-1-40">40</a></span>
<span class="normal"><a href="#__codelineno-1-41">41</a></span>
<span class="normal"><a href="#__codelineno-1-42">42</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="nb">terraform</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="w">  </span><span class="na">required_version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&gt;=0.12&quot;</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">  </span><span class="nb">required_providers</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="w">    </span><span class="nb">azurerm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="w">      </span><span class="na">source</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;hashicorp/azurerm&quot;</span>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="w">      </span><span class="na">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;~&gt;3.37&quot;</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="w">    </span><span class="nb">github</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="w">      </span><span class="na">source</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;integrations/github&quot;</span>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">      </span><span class="na">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;~&gt; 5.0&quot;</span>
<a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="w">    </span><span class="nb">namedotcom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="w">      </span><span class="na">source</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;lexfrei/namedotcom&quot;</span>
<a id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="w">      </span><span class="na">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;1.2.0&quot;</span>
<a id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="w">    </span><span class="nb">time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-19" name="__codelineno-1-19"></a><span class="w">      </span><span class="na">source</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;hashicorp/time&quot;</span>
<a id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="w">      </span><span class="na">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;0.9.1&quot;</span>
<a id="__codelineno-1-21" name="__codelineno-1-21"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-22" name="__codelineno-1-22"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-1-23" name="__codelineno-1-23"></a><span class="p">}</span>
<a id="__codelineno-1-24" name="__codelineno-1-24"></a>
<a id="__codelineno-1-25" name="__codelineno-1-25"></a><span class="kr">provider</span><span class="w"> </span><span class="nv">&quot;github&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-26" name="__codelineno-1-26"></a><span class="w">  </span><span class="na">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.github_token</span>
<a id="__codelineno-1-27" name="__codelineno-1-27"></a><span class="w">  </span><span class="na">owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.github_organization</span>
<a id="__codelineno-1-28" name="__codelineno-1-28"></a><span class="p">}</span>
<a id="__codelineno-1-29" name="__codelineno-1-29"></a>
<a id="__codelineno-1-30" name="__codelineno-1-30"></a><span class="kr">provider</span><span class="w"> </span><span class="nv">&quot;namedotcom&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-31" name="__codelineno-1-31"></a><span class="w">  </span><span class="na">token</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nv">var.namedotcom_token</span>
<a id="__codelineno-1-32" name="__codelineno-1-32"></a><span class="w">  </span><span class="na">username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.namedotcom_username</span>
<a id="__codelineno-1-33" name="__codelineno-1-33"></a><span class="p">}</span>
<a id="__codelineno-1-34" name="__codelineno-1-34"></a>
<a id="__codelineno-1-35" name="__codelineno-1-35"></a><span class="kr">provider</span><span class="w"> </span><span class="nv">&quot;azurerm&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-36" name="__codelineno-1-36"></a><span class="w">  </span><span class="nb">features</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-37" name="__codelineno-1-37"></a><span class="w">    </span><span class="nb">key_vault</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-38" name="__codelineno-1-38"></a><span class="w">      </span><span class="na">purge_soft_delete_on_destroy</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<a id="__codelineno-1-39" name="__codelineno-1-39"></a><span class="w">      </span><span class="na">recover_soft_deleted_key_vaults</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<a id="__codelineno-1-40" name="__codelineno-1-40"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-41" name="__codelineno-1-41"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-1-42" name="__codelineno-1-42"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<blockquote>
<p>Comme nous nous sommes connecté avec <code>az login</code> auparavant, aucuns identifiants n'est requis pour faire fonctionner le provider azurerm.
<strong>Warning</strong> Vérifiez bien toutefois que votre tenant par défaut soit bien celui de votre abonnement avec du crédit. Pour vérifier :</p>
</blockquote>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>az<span class="w"> </span>account<span class="w"> </span>list<span class="w"> </span>-o<span class="w"> </span>table<span class="w"> </span>--all<span class="w"> </span>--query<span class="w"> </span><span class="s2">&quot;[].{TenantID: tenantId, Subscription: name, Default: isDefault}&quot;</span><span class="sb">`</span>
</code></pre></div>
<p>Si ce n'est pas le bon vous pouvez le changer avec <code>az login --tenant $ID</code> ou utilisez une variable terraform <code>tenant_id</code> à ajouter au provider <code>azurerm</code></p>
<p>Nous voici prêt pour créer les datasources et les ressources de notre cloud sans encombres.</p>
<hr />
<ol>
<li>Les datasources</li>
</ol>
<p>Nous allons premièrement définir un fichier <code>data.tf</code> accessible tout au long du processus de création des ressources terraform.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">infra/data.tf</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-3-10">10</a></span>
<span class="normal"><a href="#__codelineno-3-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="kr">data</span><span class="w"> </span><span class="nc">&quot;azurerm_resource_group&quot;</span><span class="w"> </span><span class="nv">&quot;paas&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="w">  </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;kubeapps-group&quot;</span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="p">}</span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a>
<a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="kr">data</span><span class="w"> </span><span class="nc">&quot;azurerm_image&quot;</span><span class="w"> </span><span class="nv">&quot;search&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="w">  </span><span class="na">name</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;kubeapps-az-arm&quot;</span>
<a id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="w">  </span><span class="na">resource_group_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">data.azurerm_resource_group.paas.name</span>
<a id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="p">}</span>
<a id="__codelineno-3-9" name="__codelineno-3-9"></a>
<a id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="kr">data</span><span class="w"> </span><span class="nc">&quot;azurerm_client_config&quot;</span><span class="w"> </span><span class="nv">&quot;current&quot;</span><span class="w"> </span><span class="p">{}</span>
<a id="__codelineno-3-11" name="__codelineno-3-11"></a><span class="kr">data</span><span class="w"> </span><span class="nc">&quot;azurerm_subscription&quot;</span><span class="w"> </span><span class="nv">&quot;primary&quot;</span><span class="w"> </span><span class="p">{}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>
<p><code>azurerm_resource_group</code> nous permet de récupérer le groupe de ressource créé précédemment avec la ligne de commande azure.</p>
</li>
<li>
<p><code>azurerm_client_config</code> permet de récupérer les informations de connexion de l'utilisateur courant que l'on a lancé avec <code>az login</code>.</p>
</li>
<li>
<p><code>azurerm_subscription</code> récupère l'identifiant de votre abonnement en cour.</p>
</li>
</ul>
<hr />
<ol>
<li>Les variables d'entrée</li>
</ol>
<p>Pour éviter de commit des secrets sur un git distant et centralisé les configurations importantes, nous allons recourir à des variables terraform.</p>
<blockquote>
<p><code>sensitive</code> permet de cacher la valeur de la variable dans le terminal lors de l'exécution de terraform.</p>
</blockquote>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">infra/variables.tf</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-4-10">10</a></span>
<span class="normal"><a href="#__codelineno-4-11">11</a></span>
<span class="normal"><a href="#__codelineno-4-12">12</a></span>
<span class="normal"><a href="#__codelineno-4-13">13</a></span>
<span class="normal"><a href="#__codelineno-4-14">14</a></span>
<span class="normal"><a href="#__codelineno-4-15">15</a></span>
<span class="normal"><a href="#__codelineno-4-16">16</a></span>
<span class="normal"><a href="#__codelineno-4-17">17</a></span>
<span class="normal"><a href="#__codelineno-4-18">18</a></span>
<span class="normal"><a href="#__codelineno-4-19">19</a></span>
<span class="normal"><a href="#__codelineno-4-20">20</a></span>
<span class="normal"><a href="#__codelineno-4-21">21</a></span>
<span class="normal"><a href="#__codelineno-4-22">22</a></span>
<span class="normal"><a href="#__codelineno-4-23">23</a></span>
<span class="normal"><a href="#__codelineno-4-24">24</a></span>
<span class="normal"><a href="#__codelineno-4-25">25</a></span>
<span class="normal"><a href="#__codelineno-4-26">26</a></span>
<span class="normal"><a href="#__codelineno-4-27">27</a></span>
<span class="normal"><a href="#__codelineno-4-28">28</a></span>
<span class="normal"><a href="#__codelineno-4-29">29</a></span>
<span class="normal"><a href="#__codelineno-4-30">30</a></span>
<span class="normal"><a href="#__codelineno-4-31">31</a></span>
<span class="normal"><a href="#__codelineno-4-32">32</a></span>
<span class="normal"><a href="#__codelineno-4-33">33</a></span>
<span class="normal"><a href="#__codelineno-4-34">34</a></span>
<span class="normal"><a href="#__codelineno-4-35">35</a></span>
<span class="normal"><a href="#__codelineno-4-36">36</a></span>
<span class="normal"><a href="#__codelineno-4-37">37</a></span>
<span class="normal"><a href="#__codelineno-4-38">38</a></span>
<span class="normal"><a href="#__codelineno-4-39">39</a></span>
<span class="normal"><a href="#__codelineno-4-40">40</a></span>
<span class="normal"><a href="#__codelineno-4-41">41</a></span>
<span class="normal"><a href="#__codelineno-4-42">42</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;github_organization&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="w">  </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="p">}</span>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a>
<a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;github_team&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="w">  </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<a id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="p">}</span>
<a id="__codelineno-4-8" name="__codelineno-4-8"></a>
<a id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;github_token&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-10" name="__codelineno-4-10"></a><span class="w">  </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<a id="__codelineno-4-11" name="__codelineno-4-11"></a><span class="w">  </span><span class="na">sensitive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<a id="__codelineno-4-12" name="__codelineno-4-12"></a><span class="p">}</span>
<a id="__codelineno-4-13" name="__codelineno-4-13"></a>
<a id="__codelineno-4-14" name="__codelineno-4-14"></a><span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;cert_manager_letsencrypt_env&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-15" name="__codelineno-4-15"></a><span class="w">  </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<a id="__codelineno-4-16" name="__codelineno-4-16"></a><span class="w">  </span><span class="na">default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;prod&quot;</span>
<a id="__codelineno-4-17" name="__codelineno-4-17"></a><span class="p">}</span>
<a id="__codelineno-4-18" name="__codelineno-4-18"></a>
<a id="__codelineno-4-19" name="__codelineno-4-19"></a><span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;domain&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-20" name="__codelineno-4-20"></a><span class="w">  </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<a id="__codelineno-4-21" name="__codelineno-4-21"></a><span class="p">}</span>
<a id="__codelineno-4-22" name="__codelineno-4-22"></a>
<a id="__codelineno-4-23" name="__codelineno-4-23"></a><span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;domain_ttl&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-24" name="__codelineno-4-24"></a><span class="w">  </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">number</span>
<a id="__codelineno-4-25" name="__codelineno-4-25"></a><span class="w">  </span><span class="na">default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3000</span>
<a id="__codelineno-4-26" name="__codelineno-4-26"></a><span class="p">}</span>
<a id="__codelineno-4-27" name="__codelineno-4-27"></a>
<a id="__codelineno-4-28" name="__codelineno-4-28"></a><span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;namedotcom_token&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-29" name="__codelineno-4-29"></a><span class="w">  </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<a id="__codelineno-4-30" name="__codelineno-4-30"></a><span class="w">  </span><span class="na">sensitive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<a id="__codelineno-4-31" name="__codelineno-4-31"></a><span class="p">}</span>
<a id="__codelineno-4-32" name="__codelineno-4-32"></a>
<a id="__codelineno-4-33" name="__codelineno-4-33"></a><span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;namedotcom_username&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-34" name="__codelineno-4-34"></a><span class="w">  </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<a id="__codelineno-4-35" name="__codelineno-4-35"></a><span class="w">  </span><span class="na">sensitive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<a id="__codelineno-4-36" name="__codelineno-4-36"></a><span class="p">}</span>
<a id="__codelineno-4-37" name="__codelineno-4-37"></a>
<a id="__codelineno-4-38" name="__codelineno-4-38"></a><span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;secrets&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-39" name="__codelineno-4-39"></a><span class="w">  </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">map</span><span class="p">(</span><span class="kt">string</span><span class="p">)</span>
<a id="__codelineno-4-40" name="__codelineno-4-40"></a><span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Define Azure Key Vault secrets&quot;</span>
<a id="__codelineno-4-41" name="__codelineno-4-41"></a><span class="w">  </span><span class="nb">default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>
<a id="__codelineno-4-42" name="__codelineno-4-42"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Pour remplir ces variables dans un fichier nommé <code>votre-env.tfvars</code> (ex prod.tfvars) il nous reste à obtenir certains tokens d'accès aux api (github et namedotcom).</p>
<p><strong>L'application github oauth pour la production</strong> :</p>
<p>Il n'y a malheureusement pas d'automatisation possible avec terraform, il faut donc <a href="https://github.com/organizations/&lt;my-org&gt;/settings/applications/new">créer une nouvelle application github</a> avec les paramètres suivants :</p>
<ul>
<li>Application name : <code>kubeapps-prod</code></li>
<li>Homepage URL : https://kubeapps.<ton-nom-de-domaine>.example</li>
<li>Authorization callback URL : https://dex.<ton-nom-de-domaine>.example/callback</li>
</ul>
<p>Dans <code>exemple.tfvars</code>, on assignera <strong>Client Id</strong> à <code>dex_github_client_id</code> puis générez un nouveau <strong>Client secret</strong> que l'on assignera à <code>dex_github_client_secret</code>.</p>
<p><strong>Identifiants api à name.com</strong> :</p>
<p>Allez <a href="https://www.name.com/account/settings/api">https://www.name.com/account/settings/api</a> et créer un token avec le nom de votre choix.</p>
<p>L'objectif sera de faire pointer notre nom de domaine vers les serveurs de nom de Azure (enregistrement NS) grâce à un module terraform qui utilisera l'api de name.com.</p>
<p>Enfin, voici un exemple du fichier final à réutiliser et remplir avec les vraies valeurs :</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">infra/exemple.tfvars.dist</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-5-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-5-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-5-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-5-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-5-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-5-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-5-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-5-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-5-10">10</a></span>
<span class="normal"><a href="#__codelineno-5-11">11</a></span>
<span class="normal"><a href="#__codelineno-5-12">12</a></span>
<span class="normal"><a href="#__codelineno-5-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="na">tenant_id</span><span class="o">=</span><span class="s2">&quot;00000000-0000-0000-0000-000000000000&quot;</span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="na">github_organization</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;github-team&quot;</span>
<a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="na">github_team</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ops-team&quot;</span>
<a id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="na">domain</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;paas-esgi-tutorial.live&quot;</span>
<a id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="na">namedotcom_username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;username&quot;</span>
<a id="__codelineno-5-6" name="__codelineno-5-6"></a><span class="na">namedotcom_token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;</span>
<a id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="na">github_token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ghp_aaaaaaaaaaaaaaaaaaxxxxxxxxxxxx&quot;</span>
<a id="__codelineno-5-8" name="__codelineno-5-8"></a>
<a id="__codelineno-5-9" name="__codelineno-5-9"></a><span class="nb">secrets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-10" name="__codelineno-5-10"></a><span class="w">  </span><span class="na">dex_github_client_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dex-github-oauth2-app-client-id&quot;</span>
<a id="__codelineno-5-11" name="__codelineno-5-11"></a><span class="w">  </span><span class="na">dex_github_client_secret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dex-github-oauth2-app-client-secret&quot;</span>
<a id="__codelineno-5-12" name="__codelineno-5-12"></a><span class="w">  </span><span class="na">cert_manager_email</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;paas-esgi-tutorial.live4@example.com&quot;</span>
<a id="__codelineno-5-13" name="__codelineno-5-13"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Ces variables seront utilisées dans le fichier <code>main.tf</code> pour créer les ressources.</p>
<ol>
<li>Le fichier principal <code>main.tf</code></li>
</ol>
<p>Ici nous allons définir les ressources de nos plusieurs plateformes afin de faire fonctionner un PaaS kubeapps complet et accessible depuis internet.</p>
<p>La première partie va concerner github et les équipes ayant accès au PaaS.</p>
<p>Ensuite dans une seconde dédié aux ressources Azure, nous allons définir :</p>
<ul>
<li>La création de la VM</li>
<li>Création de l'environnement réseau et de sa sécurisation (ports ouverts)</li>
<li>Attribution d'une ip publique pour l'interface réseau de la machine</li>
<li>Créer un stockage de secrets sécurisé pour l'application kubeapps (feature <code>key_vault</code>)</li>
<li>La gestion des zones dns</li>
</ul>
<p>Enfin au milieu de tout ça lors de la création des zones dns dans azure nous ajouterons un enregistrement NS qui pointe vers les serveurs de nom de name.com grâce au provider <code>namedotcom</code>.</p>
<hr />





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": ["content.code.copy", "content.action.edit"], "search": "../assets/javascripts/workers/search.e5c33ebb.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.51d95adb.min.js"></script>
      
        <script src="../js/print-site.js"></script>
      
    
  </body>
</html>